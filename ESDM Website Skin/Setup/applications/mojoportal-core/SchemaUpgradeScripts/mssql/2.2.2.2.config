CREATE TABLE [dbo].[mp_SiteFolders](
	[Guid] [uniqueidentifier] NOT NULL CONSTRAINT [DF_mp_SiteFolders_Guid]  DEFAULT (newid()),
	[SiteGuid] [uniqueidentifier] NOT NULL,
	[FolderName] [nvarchar](255) NOT NULL,
 CONSTRAINT [PK_mp_SiteFolders] PRIMARY KEY CLUSTERED 
(
	[Guid] ASC
) ON [PRIMARY]
) ON [PRIMARY]
GO


/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaVersion_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectByEmail]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SelectByEmail]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaVersion_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_ConfirmRegistration]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_ConfirmRegistration]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_SelectAll]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaVersion_SelectAll]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Delete]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaVersion_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetRegistrationConfirmationGuid]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SetRegistrationConfirmationGuid]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaVersion_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_DecrementTotalPosts]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_DecrementTotalPosts]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Select]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_HtmlContent_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_AccountClearLockout]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_AccountClearLockout]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_SelectByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_HtmlContent_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_FlagAsDeleted]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_FlagAsDeleted]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_HtmlContent_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_LoginByEmail]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_LoginByEmail]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_HtmlContent_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdateLastPasswordChangeTime]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_UpdateLastPasswordChangeTime]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_HtmlContent_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_CountOnlineSinceTime]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_CountOnlineSinceTime]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_SelectAll]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_HtmlContent_SelectAll]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Update]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_HtmlContent_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_SelectNotInRole]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserRoles_SelectNotInRole]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscriptions_UnsubscribeThread]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreadSubscriptions_UnsubscribeThread]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdatePasswordQuestionAndAnswer]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_UpdatePasswordQuestionAndAnswer]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscriptions_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreadSubscriptions_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Select]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscriptions_UnsubscribeAllThreads]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreadSubscriptions_UnsubscribeAllThreads]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectByGuid]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SelectByGuid]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscribers_SelectByThread]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreadSubscribers_SelectByThread]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_AccountLockout]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_AccountLockout]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_UpdateCountOfUseOnMyPage]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_UpdateCountOfUseOnMyPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Insert]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_Update]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectByLoginName]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SelectByLoginName]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_GetWebPartsForMyPage]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_GetWebPartsForMyPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_SelectByRoleID]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserRoles_SelectByRoleID]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_GetMostPopularWebPartsForMyPage]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_GetMostPopularWebPartsForMyPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Login]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_Login]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_GetCount]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_GetCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SmartDropDown]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SmartDropDown]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_SelectBySite]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_SelectBySite]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectOne]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_SelectOne]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdateLastActivityTime]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_UpdateLastActivityTime]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_Delete]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdateLastLoginTime]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_UpdateLastLoginTime]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_WebPartExists]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_WebPartExists]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_IncrementTotalPosts]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_IncrementTotalPosts]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_Insert]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_GetNewestUserID]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_GetNewestUserID]
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Links_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_CountByRegistrationDateRange]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_CountByRegistrationDateRange]
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_SelectByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Links_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Count]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_Count]
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Links_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAnswerAttemptStartWindow]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SetFailedPasswordAnswerAttemptStartWindow]
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Links_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAttemptCount]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SetFailedPasswordAttemptCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Select]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Links_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectTop50UsersOnlineSinceTime]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SelectTop50UsersOnlineSinceTime]
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Links_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectUsersOnlineSinceTime]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SelectUsersOnlineSinceTime]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleSettings_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAnswerAttemptCount]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SetFailedPasswordAnswerAttemptCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleSettings_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_CountByFirstLetter]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_CountByFirstLetter]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Select]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleSettings_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAttemptStartWindow]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SetFailedPasswordAttemptStartWindow]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_CreateDefaultSettings]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleSettings_CreateDefaultSettings]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_Insert]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserRoles_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleSettings_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_DeleteUserRoles]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserRoles_DeleteUserRoles]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_DeleteInstance]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_DeleteInstance]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_Delete]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserRoles_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_PageModules_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_PageModules_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_UserPages_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_UserPages_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_PageModules_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_PageModules_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_GetNextPageOrder]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_UserPages_GetNextPageOrder]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_UpdateModuleOrder]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_UpdateModuleOrder]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_UpdatePageOrder]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserPages_UpdatePageOrder]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_GetAuthRoles]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_GetAuthRoles]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_SelectByUser]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_UserPages_SelectByUser]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_SelectOne]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserPages_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_Update]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserPages_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_PageModule_Exists]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_PageModule_Exists]
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_CalendarEvents_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_SelectByPage]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFiles_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_Delete]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_CalendarEvents_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_SelectByPage]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_CalendarEvents_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_Update]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_CalendarEvents_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_SelectOne]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_CalendarEvents_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectOneByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_SelectOneByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_SelectByDate]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_CalendarEvents_SelectByDate]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_UpdatePage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_UpdatePage]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaScriptHistory_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_UpdateViewStats]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_UpdateViewStats]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_SelectErrorsByApp]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaScriptHistory_SelectErrorsByApp]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_IncrementReplyCount]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_IncrementReplyCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_Exists]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaScriptHistory_Exists]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_SelectOneByHost]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_SelectOneByHost]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaScriptHistory_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaScriptHistory_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_SelectByApp]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SchemaScriptHistory_SelectByApp]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_UpdateExtendedProperties]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_UpdateExtendedProperties]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectForMyPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_SelectForMyPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_UpdateCountOfUseOnMyPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_UpdateCountOfUseOnMyPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_SelectAll]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_SelectAll]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Count]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Sites_Count]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_Update]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogCategories_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_SelectOne]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogCategories_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Select]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogCategories_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteHosts_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteHosts_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_DeleteByID]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitionSettings_DeleteByID]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteHosts_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_UpdateByID]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitionSettings_UpdateByID]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteHosts_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_Select]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitionSettings_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Select]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteHosts_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitionSettings_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogComments_Select]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogComments_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitions_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitions_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_SelectUserModules]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitions_SelectUserModules]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationPerUser_SetPageSettings]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePersonalizationPerUser_SetPageSettings]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Select]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitions_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAllUsers_SetPageSettings]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePersonalizationAllUsers_SetPageSettings]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitions_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ModuleDefinitions_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Modules_SelectPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectPage]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_SelectPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAllUsers_GetPageSettings]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePersonalizationAllUsers_GetPageSettings]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectTreeForModule]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Pages_SelectTreeForModule]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByForumDesc]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_SelectByForumDesc]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAdministration_FindState]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePersonalizationAdministration_FindState]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByForum]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_SelectByForum]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectThumbsByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_SelectThumbsByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectTree]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Pages_SelectTree]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_DecrementPostCount]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_DecrementPostCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_SelectPage]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_WebParts_SelectPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectWebImageByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_GalleryImages_SelectWebImageByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByForumDesc_v2]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_SelectByForumDesc_v2]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_DeleteByPageID]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_DeleteByPageID]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Update]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_IncrementPostCount]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_IncrementPostCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_IncrementPostCountOnly]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_IncrementPostCountOnly]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectBySiteUrl]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_SelectBySiteUrl]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_UpdatePostStats]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_UpdatePostStats]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_Update]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_DecrementThreadCount]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_DecrementThreadCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_UpdateThreadStats]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_UpdateThreadStats]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectOneByUrl]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_SelectOneByUrl]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_IncrementThreadCount]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_IncrementThreadCount]
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectByHost]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_FriendlyUrls_SelectByHost]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_SelectOne]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Delete]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_RecalculatePostStats]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_RecalculatePostStats]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Roles_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByCategory]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_SelectByCategory]
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Roles_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByEndDate]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_SelectByEndDate]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_GetUserRoles]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_Users_GetUserRoles]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectOne]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Roles_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Select]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_RoleExists]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Roles_RoleExists]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogComment_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogComment_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Select]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Roles_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogComment_Delete]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogComment_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_SelectOneByName]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Roles_SelectOneByName]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectArchiveByMonth]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_SelectArchiveByMonth]
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Roles_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Update]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectOne]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByMonth]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_SelectByMonth]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_SelectPage]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteSettings_SelectPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByPage]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Blog_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_SelectDefaultPage]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteSettings_SelectDefaultPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFileFolders_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_SelectDefaultPageByID]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteSettings_SelectDefaultPageByID]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_SelectAllByModule]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFileFolders_SelectAllByModule]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFileFolders_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Pages_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_SelectByModule]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFileFolders_SelectByModule]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_GetBreadcrumbs]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_GetBreadcrumbs]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFileFolders_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_GetNextPageOrder]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_GetNextPageOrder]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFileFolders_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_GetPageList]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteSettings_GetPageList]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Delete]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_Delete]
GO

/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectList]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_SelectList]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_Delete]
GO

/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectChildPages]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_SelectChildPages]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectOne]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_SelectOne]
GO

/****** Object:  StoredProcedure [dbo].[mp_Pages_UpdatePageOrder]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_Pages_UpdatePageOrder]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectAllByThread]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_SelectAllByThread]
GO

/****** Object:  StoredProcedure [dbo].[mp_Pages_Delete]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_Pages_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectByThread]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_SelectByThread]
GO

/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_RssFeeds_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_Delete]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_Delete]
GO

/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Select]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_RssFeeds_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_Update]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_Update]
GO

/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_RssFeeds_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_DecrementReplyCount]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_DecrementReplyCount]
GO

/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_RssFeeds_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_RssFeeds_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_CountByThread]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_CountByThread]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFiles_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectForRss]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumPosts_SelectForRss]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFiles_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByPage]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_SelectByPage]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_SelectByModule]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFiles_SelectByModule]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogItemCategories_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogItemCategories_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFiles_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogItemCategories_Delete]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogItemCategories_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_Update]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFiles_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogItemCategories_SelectByItem]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogItemCategories_SelectByItem]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFilesHistory_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_Delete]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogCategories_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_Select]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFilesHistory_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_SelectListByModule]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogCategories_SelectListByModule]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFilesHistory_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_SelectByModule]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogCategories_SelectByModule]
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_SelectOne]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SharedFilesHistory_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAdministration_GetCountOfState]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePersonalizationAdministration_GetCountOfState]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_Insert]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserProperties_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationPerUser_GetPageSettings]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePersonalizationPerUser_GetPageSettings]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_PropertyExists]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserProperties_PropertyExists]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationPerUser_ResetPageSettings]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePersonalizationPerUser_ResetPageSettings]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_Update]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserProperties_Update]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_Insert]    Script Date: 05/11/2007 10:54:00 ******/
DROP PROCEDURE [dbo].[mp_ForumThreads_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_Delete]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserProperties_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Select]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_Forums_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_SelectByUser]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserProperties_SelectByUser]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumSubscriptions_Unsubscribe]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumSubscriptions_Unsubscribe]
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_SelectOne]    Script Date: 05/11/2007 10:54:02 ******/
DROP PROCEDURE [dbo].[mp_UserProperties_SelectOne]
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumSubscriptions_Insert]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_ForumSubscriptions_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteModuleDefinitions_Delete]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteModuleDefinitions_Delete]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogStats_Select]    Script Date: 05/11/2007 10:53:59 ******/
DROP PROCEDURE [dbo].[mp_BlogStats_Select]
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteModuleDefinitions_Insert]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SiteModuleDefinitions_Insert]
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePaths_CreatePath]    Script Date: 05/11/2007 10:54:01 ******/
DROP PROCEDURE [dbo].[mp_SitePaths_CreatePath]
GO


/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectPage]    Script Date: 05/11/2007 10:57:44 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectPage]

/*
Author:			Joe Audette
Created:		5/16/2006
Last Modified:	5/20/2006

*/

@SiteID			int,
@PageNumber 	int,
@PageSize 		int,
@SortByModuleType	bit,
@SortByAuthor	bit



AS
DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1



CREATE TABLE #PageIndex 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	ModuleID int
)	


 IF @SortByModuleType = 1
	BEGIN
	    	INSERT INTO 	#PageIndex (ModuleID)

	    	SELECT 			m.ModuleID 
			FROM 			mp_Modules m
			JOIN			mp_ModuleDefinitions md
			ON				md.ModuleDefID = m.ModuleDefID
			WHERE 			m.SiteID = @SiteID
							AND md.IsAdmin = 0
				
			ORDER BY 		md.FeatureName, m.ModuleTitle

	END
 Else IF @SortByAuthor = 1
	BEGIN
		INSERT INTO 	#PageIndex (ModuleID)

	    	SELECT 			m.ModuleID 
			FROM 			mp_Modules m
			JOIN			mp_ModuleDefinitions md
			ON				md.ModuleDefID = m.ModuleDefID
			LEFT OUTER JOIN	mp_Users u
			ON				m.CreatedByUserID = u.UserID
			WHERE 			m.SiteID = @SiteID
							AND md.IsAdmin = 0
				
			ORDER BY 		u.[Name], m.ModuleTitle
	END
 ELSE
	BEGIN
	    	INSERT INTO 	#PageIndex (ModuleID)

	    	SELECT 			m.ModuleID 
			FROM 			mp_Modules m
			JOIN			mp_ModuleDefinitions md
			ON				md.ModuleDefID = m.ModuleDefID
			WHERE 			m.SiteID = @SiteID
							AND md.IsAdmin = 0
				
			ORDER BY 		m.ModuleTitle

	END

DECLARE @TotalRows int
DECLARE @TotalPages int
DECLARE @Remainder int

SET @TotalRows = (SELECT Count(*) FROM #PageIndex)
SET @TotalPages = @TotalRows / @PageSize
SET @Remainder = @TotalRows % @PageSize
IF @Remainder > 0 
SET @TotalPages = @TotalPages + 1


SELECT		m.*,
			md.FeatureName,
			md.ControlSrc,
			u.[Name] As CreatedBy,
			'TotalPages' = @TotalPages

FROM			mp_Modules m

JOIN			mp_ModuleDefinitions md
ON				md.ModuleDefID = m.ModuleDefID

LEFT OUTER JOIN	mp_Users u
ON				m.CreatedByUserID = u.UserID

JOIN			#PageIndex p
ON				m.ModuleID = p.ModuleID

WHERE 		
			p.IndexID > @PageLowerBound 
			AND p.IndexID < @PageUpperBound

ORDER BY		p.IndexID

DROP TABLE #PageIndex
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectTreeForModule]    Script Date: 05/11/2007 10:58:03 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectTreeForModule]

/*
Author:			Joe Audette
Created:		5/18/2006
Last Modified:	5/18/2006

*/
        
@SiteID int,
@ModuleID	int

AS
CREATE TABLE #PageTree
(
        [PageID] [int],
        [PageName] [nvarchar] (100),
        [ParentID] [int],
        [PageOrder] [int],
        [NestLevel] [int],
        [TreeOrder] [nvarchar] (1000)
)

SET NOCOUNT ON  
DECLARE @LastLevel smallint
SET @LastLevel = 0
-- First, the parent levels
INSERT INTO     	#PageTree

SELECT  		PageID,
        			PageName,
        			ParentID,
        			PageOrder,
       			0,
        			CAST( 100000000 + PageOrder as nvarchar(20) )

FROM   		mp_Pages

WHERE   		ParentID IS NULL  OR ParentID = -1
			AND SiteID = @SiteID

ORDER BY 		PageOrder

-- Next, the children levels
WHILE (@@rowcount > 0)
BEGIN
  SET @LastLevel = @LastLevel + 1
  INSERT        #PageTree 
	(
		PageID, 
		PageName, 
		ParentID, 
		PageOrder, 
		NestLevel, 
		TreeOrder
	) 
                
    SELECT  	p.PageID,
                        	Replicate('-', @LastLevel *2) + p.PageName,
                        	p.ParentID,
                        	p.PageOrder,
                        	@LastLevel,
                        	CAST(t.TreeOrder as nvarchar) + '.' + CAST(100000000 + p.PageOrder as nvarchar)

      FROM    	mp_Pages p
 
      join 		#PageTree t
      on 		p.ParentID= t.PageID

      WHERE   	EXISTS (SELECT 'X' FROM #PageTree WHERE PageID = p.ParentID AND NestLevel = @LastLevel - 1)
                 	AND SiteID = @SiteID

      ORDER BY 	t.PageOrder


END
--Get the Orphans
  INSERT        	#PageTree 
		(
		PageID, 
		PageName, 
		ParentID, 
		PageOrder, 
		NestLevel, 
		TreeOrder
		) 
                

   SELECT  	p.PageID,
                        	'(Orphan)' + p.PageName,
                        	p.ParentID,
                        	p.PageOrder,
                        	999999999,
                        	'999999999'
                
    FROM    	mp_Pages p 

    WHERE   	NOT EXISTS (SELECT 'X' FROM #PageTree WHERE PageID = p.PageID)
                         	AND SiteID  = @SiteID


-- Reorder the Pages by using a 2nd Temp table and an identity field to keep them straight.
SELECT 	IDENTITY(int,1,2) as ord , 
		CAST(PageID as nvarchar) as PageID 

INTO 		#Pages

FROM 		#PageTree

ORDER BY 	NestLevel, TreeOrder

-- Change the taborder in the sirt temp table so that tabs are ordered in sequence
/*
UPDATE 	#PageTree 

SET 		PageOrder = (SELECT ord FROM #Pages WHERE CAST(#Pages.PageID as int) = #PageTree.PageID) 
*/

-- Return Temporary Table
SELECT 	pt.PageID, 
		pt.ParentID, 
		pt.PageName, 
		pt.PageOrder, 
		pt.NestLevel,
		p.PageTitle,
		p.AuthorizedRoles,
		p.EditRoles,
		p.CreateChildPageRoles,
		'IsPublished' = CONVERT(bit,ISNULL(pm.ModuleID + 1,0)),
		pm.PaneName,
		pm.ModuleOrder,
		pm.PublishBeginDate,
		pm.PublishEndDate

FROM 		#PageTree  pt

JOIN		mp_Pages p
ON		p.PageID = pt.PageID

LEFT OUTER JOIN	mp_PageModules pm
ON		pm.PageID = p.PageID
		AND pm.ModuleID = @ModuleID

ORDER BY 	pt.TreeOrder

DROP TABLE #Pages
DROP TABLE #PageTree
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAdministration_FindState]    Script Date: 05/11/2007 10:58:41 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SitePersonalizationAdministration_FindState] 


@SiteID			int,
@Path 				nvarchar(255) = NULL,
@AllUsersScope 		bit,
@UserID 			uniqueidentifier = NULL,
@InactiveSinceDate 		datetime = NULL,
@PageIndex              		int,
@PageSize               		int



AS

BEGIN
   

    -- Set the page bounds
    DECLARE @PageLowerBound INT
    DECLARE @PageUpperBound INT
    DECLARE @TotalRecords   INT
    SET @PageLowerBound = @PageSize * @PageIndex
    SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

    -- Create a temp table to store the selected results
    CREATE TABLE #PageIndex (
        IndexId int IDENTITY (0, 1) NOT NULL,
        ItemId UNIQUEIDENTIFIER
    )

    IF (@AllUsersScope = 1)
    BEGIN
        -- Insert into our temp table
        INSERT INTO 	#PageIndex (ItemId)

        SELECT 		Paths.PathID
        FROM 		mp_SitePaths Paths,
             			(
			(SELECT 		Paths.PathID
               		FROM 			mp_SitePersonalizationAllUsers AllUsers, mp_SitePaths Paths
               		WHERE 		Paths.SiteID = @SiteID
                      					AND AllUsers.PathId = Paths.PathId
                      					AND (@Path IS NULL OR Paths.LoweredPath LIKE LOWER(@Path))
              			) AS SharedDataPerPath
       			FULL OUTER JOIN
             		 (		SELECT DISTINCT 	Paths.PathID
               			FROM 			mp_SitePersonalizationPerUser PerUser, mp_SitePaths Paths
               			WHERE 		Paths.SiteID = @SiteID
                      						AND PerUser.PathID = Paths.PathID
                      						AND (@Path IS NULL OR Paths.LoweredPath LIKE LOWER(@Path))
              			) AS UserDataPerPath
      			ON SharedDataPerPath.PathID = UserDataPerPath.PathID
             		)

        WHERE 		Paths.PathID = SharedDataPerPath.PathID 
			OR Paths.PathID = UserDataPerPath.PathID

        ORDER BY 	Paths.Path ASC

        SELECT @TotalRecords = @@ROWCOUNT

        SELECT 			Paths.Path,
               			SharedDataPerPath.LastUpdate,
               			SharedDataPerPath.DataSize,
               			UserDataPerPath.UserDataLength,
               			UserDataPerPath.UserCount,
				@TotalRecords As TotalRecords

        FROM 			mp_SitePaths Paths,
             (
		(		SELECT 		PageIndex.ItemId AS PathID,
                      						AllUsers.LastUpdatedDate AS LastUpdatedDate,
                      						DATALENGTH(AllUsers.PageSettings) AS DataSize
               			FROM 			mp_SitePersonalizationAllUsers AllUsers, #PageIndex PageIndex
               			WHERE 		AllUsers.PathID = PageIndex.ItemId
                     						AND PageIndex.IndexId >= @PageLowerBound 
							AND PageIndex.IndexId <= @PageUpperBound
              	) 		AS SharedDataPerPath
              
				FULL OUTER JOIN

              	(		SELECT 		PageIndex.ItemId AS PathID,
                      						SUM(DATALENGTH(PerUser.PageSettings)) AS UserDataLength,
                      						COUNT(*) AS UserCount

               			FROM 			mp_SitePersonalizationPerUser PerUser, #PageIndex PageIndex
               			WHERE 		PerUser.PathID = PageIndex.ItemId
                     						AND PageIndex.IndexId >= @PageLowerBound 
							AND PageIndex.IndexId <= @PageUpperBound

               			GROUP BY 		PageIndex.ItemId

              	) 		AS UserDataPerPath

              			ON SharedDataPerPath.PathID = UserDataPerPath.PathID
             )

        WHERE 			Paths.PathID = SharedDataPerPath.PathID 
				OR Paths.PathID = UserDataPerPath.PathID

        ORDER BY 		Paths.Path ASC

    END
    ELSE
    BEGIN
        -- Insert into our temp table
        INSERT INTO 		#PageIndex (ItemId)

        SELECT 			PerUser.[ID]

        FROM 			mp_SitePersonalizationPerUser PerUser, mp_Users Users, mp_SitePaths Paths

        WHERE 			Paths.SiteID = @SiteID
              			AND PerUser.UserID = Users.UserGuid
              			AND PerUser.PathID = Paths.PathID
              			AND (@Path IS NULL OR Paths.LoweredPath LIKE LOWER(@Path))
				AND (@UserID = '{00000000-0000-0000-0000-000000000000}' OR Users.UserGuid = @UserID)
             
              			AND (@InactiveSinceDate IS NULL OR Users.LastActivityDate <= @InactiveSinceDate)

        ORDER BY 		Paths.Path ASC, Users.LoginName ASC

        SELECT @TotalRecords = @@ROWCOUNT

        SELECT 			Paths.Path, 
				PerUser.LastUpdate, 
				DATALENGTH(PerUser.PageSettings) As DataSize, 
				Users.LoginName, 
				Users.LastActivityDate,
				@TotalRecords As TotalRecords
        
        FROM 			mp_SitePersonalizationPerUser PerUser, mp_Users Users, mp_SitePaths Paths, #PageIndex PageIndex
        
        WHERE 			PerUser.[ID] = PageIndex.ItemId
              			AND PerUser.UserID = Users.UserGuid
              			AND PerUser.PathID = Paths.PathID
              			AND PageIndex.IndexId >= @PageLowerBound 
				AND PageIndex.IndexId <= @PageUpperBound

        ORDER BY 		Paths.Path ASC, Users.LoginName ASC

    END

    --RETURN @TotalRecords
END
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectThumbsByPage]    Script Date: 05/11/2007 10:57:19 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_SelectThumbsByPage]

/*
Author:			Joe Audette
Created:		12/5/2004
Last Modified:		12/5/2004

*/

@ModuleID			int,
@PageNumber 			int,
@PageSize 			int


AS
DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1


CREATE TABLE #PageIndex
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	ItemID int
)	


 
INSERT INTO 	#PageIndex (ItemID)

SELECT	t.ItemID
FROM		mp_GalleryImages t
WHERE	t.ModuleID = @ModuleID	
ORDER BY	t.DisplayOrder, t.ItemID ASC

DECLARE @TotalRows int
DECLARE @TotalPages int
DECLARE @Remainder int

SET @TotalRows = (SELECT Count(*) FROM #PageIndex)
SET @TotalPages = @TotalRows / @PageSize
SET @Remainder = @TotalRows % @PageSize
IF @Remainder > 0 
SET @TotalPages = @TotalPages + 1


SELECT	t.ItemID,
		t.Caption,
		t.ThumbnailFile,
		t.WebImageFile,
		p.IndexID,
		'TotalPages' = @TotalPages
		


FROM		mp_GalleryImages t

JOIN		#PageIndex p
ON		p.ItemID = t.ItemID



WHERE	t.ModuleID = @ModuleID	
		AND p.IndexID > @PageLowerBound 
		AND p.IndexID < @PageUpperBound

ORDER BY	p.IndexID 

DROP TABLE #PageIndex
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectPage]    Script Date: 05/11/2007 10:59:38 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Users_SelectPage]

/*
Author:			Joe Audette
Created:		10/3/2004
Last Modified:		12/20/2006

*/

@PageNumber 			int,
@PageSize 			int,
@UserNameBeginsWith 		nvarchar(1),
@SiteID			int


AS
DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

--SET @PageLowerBound = @PageSize * @PageNumber
--SET @PageUpperBound = @PageLowerBound + @PageSize + 1


CREATE TABLE #PageIndexForUsers 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	UserName nvarchar(50),
	LoginName nvarchar(50)
)	


 IF @UserNameBeginsWith IS NULL OR @UserNameBeginsWith = ''
	BEGIN
	    	INSERT INTO 	#PageIndexForUsers (UserName, LoginName)

	    	SELECT 	[Name], LoginName
		FROM 		mp_Users 
		WHERE 	ProfileApproved = 1
				 AND DisplayInMemberList = 1  
				AND SiteID = @SiteID
				AND IsDeleted = 0
		ORDER BY 	[Name]
	END
ELSE
	BEGIN
	    	INSERT INTO 	#PageIndexForUsers (UserName, LoginName)

	    	SELECT 	[Name] , LoginName
		FROM 		mp_Users 
		WHERE 	ProfileApproved = 1 
				AND DisplayInMemberList = 1  
				AND SiteID = @SiteID
				AND IsDeleted = 0
				AND LEFT([Name], 1) = @UserNameBeginsWith 
		ORDER BY 	[Name]

	END

DECLARE @TotalRows int
DECLARE @TotalPages int
DECLARE @Remainder int

SET @TotalRows = (SELECT Count(*) FROM #PageIndexForUsers)
SET @TotalPages = @TotalRows / @PageSize
SET @Remainder = @TotalRows % @PageSize
IF @Remainder > 0 
SET @TotalPages = @TotalPages + 1


SELECT		*,
			'TotalPages' = @TotalPages

FROM			mp_Users u

JOIN			#PageIndexForUsers p
ON			u.LoginName = p.LoginName

WHERE 		u.ProfileApproved = 1 
			AND u.SiteID = @SiteID
			AND u.IsDeleted = 0
			AND p.IndexID > @PageLowerBound 
			AND p.IndexID < @PageUpperBound

ORDER BY		p.IndexID

DROP TABLE #PageIndexForUsers
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectTree]    Script Date: 05/11/2007 10:58:02 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectTree]

/*
Author:			Joe Audette
Created:		11/6/2004
Last Modified:		9/10/2005

*/
        
@SiteID int

AS
CREATE TABLE #PageTree
(
        [PageID] [int],
        [PageName] [nvarchar] (100),
        [ParentID] [int],
        [PageOrder] [int],
        [NestLevel] [int],
        [TreeOrder] [nvarchar] (1000)
)

SET NOCOUNT ON  
DECLARE @LastLevel smallint
SET @LastLevel = 0
-- First, the parent levels
INSERT INTO     	#PageTree

SELECT  		PageID,
        			PageName,
        			ParentID,
        			PageOrder,
       			0,
        			CAST( 100000000 + PageOrder as nvarchar(20) )

FROM   		mp_Pages

WHERE   		ParentID IS NULL  OR ParentID = -1
			AND SiteID = @SiteID

ORDER BY 		PageOrder

-- Next, the children levels
WHILE (@@rowcount > 0)
BEGIN
  SET @LastLevel = @LastLevel + 1
  INSERT        #PageTree 
	(
		PageID, 
		PageName, 
		ParentID, 
		PageOrder, 
		NestLevel, 
		TreeOrder
	) 
                
    SELECT  	p.PageID,
                        	Replicate('-', @LastLevel *2) + p.PageName,
                        	p.ParentID,
                        	p.PageOrder,
                        	@LastLevel,
                        	CAST(t.TreeOrder as nvarchar) + '.' + CAST(100000000 + p.PageOrder as nvarchar)

      FROM    	mp_Pages p
 
      join 		#PageTree t
      on 		p.ParentID= t.PageID

      WHERE   	EXISTS (SELECT 'X' FROM #PageTree WHERE PageID = p.ParentID AND NestLevel = @LastLevel - 1)
                 	AND SiteID = @SiteID

      ORDER BY 	t.PageOrder


END
--Get the Orphans
  INSERT        	#PageTree 
		(
		PageID, 
		PageName, 
		ParentID, 
		PageOrder, 
		NestLevel, 
		TreeOrder
		) 
                

   SELECT  	p.PageID,
                        	'(Orphan)' + p.PageName,
                        	p.ParentID,
                        	p.PageOrder,
                        	999999999,
                        	'999999999'
                
    FROM    	mp_Pages p 

    WHERE   	NOT EXISTS (SELECT 'X' FROM #PageTree WHERE PageID = p.PageID)
                         	AND SiteID  = @SiteID


-- Reorder the Pages by using a 2nd Temp table and an identity field to keep them straight.
SELECT 	IDENTITY(int,1,2) as ord , 
		CAST(PageID as nvarchar) as PageID 

INTO 		#Pages

FROM 		#PageTree

ORDER BY 	NestLevel, TreeOrder

-- Change the taborder in the sirt temp table so that tabs are ordered in sequence
/*
UPDATE 	#PageTree 

SET 		PageOrder = (SELECT ord FROM #Pages WHERE CAST(#Pages.PageID as int) = #PageTree.PageID) 
*/

-- Return Temporary Table
SELECT 	pt.PageID, 
		pt.ParentID, 
		pt.PageName, 
		pt.PageOrder, 
		pt.NestLevel,
		p.PageTitle,
		p.AuthorizedRoles,
		p.EditRoles,
		p.CreateChildPageRoles

FROM 		#PageTree  pt

JOIN		mp_Pages p
ON		p.PageID = pt.PageID

ORDER BY 	pt.TreeOrder

DROP TABLE #Pages
DROP TABLE #PageTree
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_SelectPage]    Script Date: 05/11/2007 11:00:02 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_WebParts_SelectPage]

/*
Author:			Joe Audette
Created:		6/7/2006
Last Modified:	6/7/2006

*/

@SiteID			int,
@PageNumber 	int,
@PageSize 		int,
@SortByClassName	bit,
@SortByAssemblyName	bit



AS
DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1



CREATE TABLE #PageIndex 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	WebPartID uniqueidentifier
)	


 IF @SortByClassName = 1
	BEGIN
	    	INSERT INTO 	#PageIndex (WebPartID)

	    	SELECT 			w.WebPartID 
			FROM 			mp_WebParts w
			WHERE 			w.SiteID = @SiteID
			ORDER BY 		w.ClassName, w.Title

	END
 Else IF @SortByAssemblyName = 1
	BEGIN
		INSERT INTO 	#PageIndex (WebPartID)

	    	SELECT 			w.WebPartID 
			FROM 			mp_WebParts w
			WHERE 			w.SiteID = @SiteID
			ORDER BY 		w.AssemblyName, w.Title
	END
 ELSE
	BEGIN
	    	INSERT INTO 	#PageIndex (WebPartID)

	    	SELECT 			w.WebPartID 
			FROM 			mp_WebParts w
			WHERE 			w.SiteID = @SiteID
			ORDER BY 		w.Title, w.ClassName

	END

DECLARE @TotalRows int
DECLARE @TotalPages int
DECLARE @Remainder int

SET @TotalRows = (SELECT Count(*) FROM #PageIndex)
SET @TotalPages = @TotalRows / @PageSize
SET @Remainder = @TotalRows % @PageSize
IF @Remainder > 0 
SET @TotalPages = @TotalPages + 1


SELECT		w.*,
			'TotalPages' = @TotalPages

FROM			mp_WebParts w

JOIN			#PageIndex p
ON				w.WebPartID = p.WebPartID

WHERE 		
			p.IndexID > @PageLowerBound 
			AND p.IndexID < @PageUpperBound

ORDER BY		p.IndexID

DROP TABLE #PageIndex
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectWebImageByPage]    Script Date: 05/11/2007 10:57:19 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_SelectWebImageByPage]

/*
Author:			Joe Audette
Created:		12/5/2004
Last Modified:		12/5/2004

*/

@ModuleID			int,
@PageNumber 			int


AS

DECLARE @PageSize 		int
DECLARE @PageLowerBound 	int
DECLARE @PageUpperBound 	int

SET @PageSize = 1
SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1


CREATE TABLE #PageIndex
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	ItemID int
)	


 
INSERT INTO 	#PageIndex (ItemID)

SELECT	t.ItemID
FROM		mp_GalleryImages t
WHERE	t.ModuleID = @ModuleID	
ORDER BY	t.DisplayOrder, t.ItemID ASC

DECLARE @TotalRows int
DECLARE @TotalPages int
DECLARE @Remainder int

SET @TotalRows = (SELECT Count(*) FROM #PageIndex)
SET @TotalPages = @TotalRows / @PageSize
SET @Remainder = @TotalRows % @PageSize
IF @Remainder > 0 
SET @TotalPages = @TotalPages + 1


SELECT	t.ModuleID,
		t.ItemID,
		'TotalPages' = @TotalPages
		


FROM		mp_GalleryImages t

JOIN		#PageIndex p
ON		p.ItemID = t.ItemID



WHERE	t.ModuleID = @ModuleID	
		AND p.IndexID > @PageLowerBound 
		AND p.IndexID < @PageUpperBound

ORDER BY	p.IndexID 

DROP TABLE #PageIndex
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectOne]    Script Date: 05/11/2007 10:57:13 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_SelectOne]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 			6/1/2005

*/

@UrlID int

AS


SELECT
		[UrlID],
		[SiteID],
		[FriendlyUrl],
		[RealUrl],
		[IsPattern]
		
FROM
		[dbo].[mp_FriendlyUrls]
		
WHERE
		[UrlID] = @UrlID
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectBySiteUrl]    Script Date: 05/11/2007 10:57:13 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_SelectBySiteUrl]

/*
Author:   			Joe Audette
Created: 			9/10/2006
Last Modified: 		4/15/2007
*/

@SiteID				int,
@FriendlyUrl		varchar(255)

AS
SELECT *
		
FROM
		[dbo].[mp_FriendlyUrls] u


WHERE	u.SiteID = @SiteID
		AND u.FriendlyUrl = @FriendlyUrl
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_Update]    Script Date: 05/11/2007 10:57:15 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_Update]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 			6/1/2005


*/
	
@UrlID int, 
@SiteID int, 
@FriendlyUrl varchar(255), 
@RealUrl varchar(255), 
@IsPattern bit 


AS

UPDATE 		[dbo].[mp_FriendlyUrls] 

SET
			[SiteID] = @SiteID,
			[FriendlyUrl] = @FriendlyUrl,
			[RealUrl] = @RealUrl,
			[IsPattern] = @IsPattern
			
WHERE
			[UrlID] = @UrlID
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_Insert]    Script Date: 05/11/2007 10:57:10 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_Insert]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 			6/1/2005


*/

@SiteID int,
@FriendlyUrl varchar(255),
@RealUrl varchar(255),
@IsPattern bit

	
AS

INSERT INTO 	[dbo].[mp_FriendlyUrls] 
(
				[SiteID],
				[FriendlyUrl],
				[RealUrl],
				[IsPattern]
) 

VALUES 
(
				@SiteID,
				@FriendlyUrl,
				@RealUrl,
				@IsPattern
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectOneByUrl]    Script Date: 05/11/2007 10:57:14 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_SelectOneByUrl]

/*
Author:   			Joe Audette
Created: 			6/16/2005
Last Modified: 			6/16/2005
*/

@HostName		varchar(100),
@FriendlyUrl		varchar(255)

AS




SELECT TOP 1
		u.[UrlID],
		u.[SiteID],
		u.[FriendlyUrl],
		u.[RealUrl],
		u.[IsPattern]
		
FROM
		[dbo].[mp_FriendlyUrls] u



WHERE	u.FriendlyUrl = @FriendlyUrl
		AND u.SiteID = COALESCE(
					(SELECT TOP 1 SiteID From mp_SiteHosts WHERE HostName = @HostName),

					(SELECT TOP 1 SiteID From mp_Sites ORDER BY SiteID )
					)
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_SelectByHost]    Script Date: 05/11/2007 10:57:11 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_SelectByHost]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 			6/1/2005
*/

@HostName		varchar(100)

AS




SELECT
		[UrlID],
		[SiteID],
		[FriendlyUrl],
		[RealUrl],
		[IsPattern]
		
FROM
		[dbo].[mp_FriendlyUrls]

WHERE	SiteID = COALESCE(
					(SELECT TOP 1 SiteID From mp_SiteHosts WHERE HostName = @HostName),

					(SELECT TOP 1 SiteID From mp_Sites ORDER BY SiteID )
					)
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_DeleteByPageID]    Script Date: 05/11/2007 10:57:09 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_DeleteByPageID]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 			6/1/2005

*/

@PageID int

AS

DELETE FROM [dbo].[mp_FriendlyUrls]
WHERE
	RealUrl LIKE '%pageid=' + CONVERT(varchar(255), @PageID) + '%'
GO
/****** Object:  StoredProcedure [dbo].[mp_FriendlyUrls_Delete]    Script Date: 05/11/2007 10:57:08 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_FriendlyUrls_Delete]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 			6/1/2005

*/

@UrlID int

AS

DELETE FROM [dbo].[mp_FriendlyUrls]
WHERE
	[UrlID] = @UrlID
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByCategory]    Script Date: 05/11/2007 10:56:24 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Blog_SelectByCategory]

/*
Author:			Joe Audette
Created:		6/12/2005
Last Modified:		6/12/2005

*/



@ModuleID 		int,
@CategoryID		int


AS

SELECT	b.*

		

FROM 		mp_Blogs b

WHERE 	b.ModuleID = @ModuleID
		AND b.ItemID IN (SELECT ItemID FROM mp_BlogItemCategories WHERE CategoryID = @CategoryID)


ORDER BY	 b.StartDate DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByEndDate]    Script Date: 05/11/2007 10:56:25 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Blog_SelectByEndDate]

/*
Author:		Joe Audette
Created:	6/5/2005
Last Modified:	6/12/2005

*/
    
@ModuleID int,
@EndDate datetime

AS

DECLARE @RowsToGet int

SET @RowsToGet = COALESCE((SELECT TOP 1 SettingValue FROM mp_ModuleSettings WHERE SettingName = 'BlogEntriesToShowSetting' AND ModuleID = @ModuleID),10)

SET rowcount @RowsToGet

SELECT		b.ItemID, 
			b.ModuleID, 
			b.CreatedByUser, 
			b.CreatedDate, 
			b.Title, 
			b.Excerpt, 
			b.[Description], 
			b.StartDate,
			b.IsInNewsletter, 
			b.IncludeInFeed,
			'CommentCount' = CONVERT(nvarchar(20), b.CommentCount)
			

FROM        		mp_Blogs b

WHERE
    			(b.ModuleID = @ModuleID)  and (@EndDate >= b.StartDate)

ORDER BY
   			b.ItemID DESC,  b.StartDate DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Insert]    Script Date: 05/11/2007 10:56:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Blog_Insert]

/*
Author:			Joe Audette
Last Modified:		8/7/2005

*/

    
@ModuleID       		int,
@UserName       	nvarchar(100),
@Title          		nvarchar(100),
@Excerpt	    	nvarchar(512),
@Description    		ntext,
@StartDate      		datetime,
@IsInNewsletter 	bit,
@IncludeInFeed		bit,
@ItemID         		int OUTPUT



AS



INSERT INTO 		mp_Blogs
(

    			ModuleID,
    			CreatedByUser,
    			CreatedDate,
    			Title,
    			Excerpt,
			[Description],
			StartDate,
			IsInNewsletter,
			IncludeInFeed
			


)

VALUES
(

    		@ModuleID,
    		@UserName,
    		GetDate(),
    		@Title,
    		@Excerpt,
    		@Description,
    		@StartDate,
    		@IsInNewsletter,
		@IncludeInFeed
    		



)



SELECT

    @ItemID = @@Identity


IF EXISTS(SELECT ModuleID FROM mp_BlogStats WHERE ModuleID = @ModuleID)
	BEGIN
		UPDATE mp_BlogStats
		SET 	EntryCount = EntryCount + 1
		WHERE ModuleID = @ModuleID

	END
ELSE
	BEGIN
		INSERT INTO mp_BlogStats(ModuleID, EntryCount)
		VALUES (@ModuleID, 1)


	END
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Delete]    Script Date: 05/11/2007 10:56:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Blog_Delete]
(
    @ItemID int
)
AS

DECLARE @ModuleID int
SET @ModuleID = (SELECT TOP 1 ModuleID FROM mp_Blogs WHERE ItemID = @ItemID)

DELETE FROM
    mp_Blogs

WHERE
    ItemID = @ItemID

UPDATE mp_BlogStats
SET 	EntryCount = EntryCount - 1
WHERE ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByMonth]    Script Date: 05/11/2007 10:56:27 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Blog_SelectByMonth]

(
	@Month int,
	@Year int,
	@ModuleID int
)

AS

SELECT	b.*

		

FROM 		mp_Blogs b

WHERE 	b.ModuleID = @ModuleID
		AND Month(b.StartDate)  = @Month 
		AND Year(b.StartDate)  = @Year


ORDER BY	 b.StartDate DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectByPage]    Script Date: 05/11/2007 10:56:27 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Blog_SelectByPage]

/*
Author:			Joe Audettte
Created:		6/30/2005
Last Modified:		6/30/2005

*/


@SiteID		int,
@PageID		int

AS
SELECT  	b.*,
		m.ModuleTitle,
		md.FeatureName

FROM		mp_Blogs b

JOIN		mp_Modules m
ON		b.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID
		AND pm.PublishBeginDate < GetDate()
		AND (pm.PublishEndDate IS NULL OR pm.PublishEndDate > GetDate())
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Update]    Script Date: 05/11/2007 10:56:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Blog_Update]

/*
Author:			Joe Audette
Last Modified:		6/30/2005

*/





@ItemID         		int,
@ModuleID       		int,
@UserName       	nvarchar(100),
@Title          		nvarchar(100),
@Excerpt       		nvarchar(512),
@Description    		ntext,
@StartDate      		datetime,
@IsInNewsletter 	bit,
@IncludeInFeed		bit

   
AS



UPDATE mp_Blogs



SET 

		ModuleID = @ModuleID,
		CreatedByUser = @UserName,
		CreatedDate = GetDate(),
		Title =@Title ,
		Excerpt =@Excerpt,
		[Description] = @Description,
		StartDate = @StartDate,
		IsInNewsletter = @IsInNewsletter,
		IncludeInFeed = @IncludeInFeed
		



WHERE 

		ItemID = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogComment_Delete]    Script Date: 05/11/2007 10:56:32 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_BlogComment_Delete]
(
    @BlogCommentID int
)
AS

DECLARE @ModuleID int
DECLARE @ItemID int

SELECT @ModuleID = ModuleID, @ItemID = ItemID
FROM	mp_BlogComments
WHERE BlogCommentID = @BlogCommentID

DELETE FROM
    mp_BlogComments

WHERE
    BlogCommentID = @BlogCommentID



UPDATE mp_Blogs
SET CommentCount = CommentCount - 1
WHERE ModuleID = @ModuleID AND ItemID = @ItemID

UPDATE mp_BlogStats
SET 	CommentCount = CommentCount - 1
WHERE ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectArchiveByMonth]    Script Date: 05/11/2007 10:56:24 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Blog_SelectArchiveByMonth]


(
	@ModuleID int
)

AS

SELECT 	Month(StartDate) as [Month], 
		DATENAME(month,StartDate) as [MonthName],
		Year(StartDate) as [Year], 
		1 as Day, 
		Count(*) as [Count] 

FROM 		mp_Blogs
 
WHERE 	ModuleID = @ModuleID 

GROUP BY 	Year(StartDate), 
		Month(StartDate) ,
		DATENAME(month,StartDate)

ORDER BY 	[Year] desc, [Month] desc
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogComment_Insert]    Script Date: 05/11/2007 10:56:33 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogComment_Insert]

@ModuleID       int,
@ItemID	int,
@Name       nvarchar(100),
@Title          nvarchar(100),
@URL       nvarchar(200),
@Comment    ntext,
@DateCreated	datetime


AS
INSERT INTO mp_BlogComments

(

    ModuleID,
	ItemID,
    [Name],
    Title,
	URL,
    Comment,
	DateCreated

)

VALUES
(

    @ModuleID,
    @ItemID,
   @Name,
    @Title,
    @URL,
    @Comment,
    @DateCreated

)



UPDATE mp_Blogs
SET CommentCount = CommentCount + 1
WHERE ModuleID = @ModuleID AND ItemID = @ItemID


UPDATE mp_BlogStats
SET 	CommentCount = CommentCount + 1
WHERE ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_SelectOne]    Script Date: 05/11/2007 10:56:28 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Blog_SelectOne]

/*
Author:			Joe Audette
Last Modified:		7/1/2005

*/

    
@ItemID int

AS

SELECT		*
			
			
FROM			mp_Blogs


WHERE   		(ItemID = @ItemID)
GO
/****** Object:  StoredProcedure [dbo].[mp_Blog_Select]    Script Date: 05/11/2007 10:56:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Blog_Select]

/*
Author:		Joe Audette
Last Modified:	6/12/2005

*/
    
@ModuleID int,
@BeginDate datetime

AS
DECLARE @RowsToGet int

SET @RowsToGet = COALESCE((SELECT TOP 1 SettingValue FROM mp_ModuleSettings WHERE SettingName = 'BlogEntriesToShowSetting' AND ModuleID = @ModuleID),1)

SET rowcount @RowsToGet

SELECT		b.ItemID, 
			b.ModuleID, 
			b.CreatedByUser, 
			b.CreatedDate, 
			b.Title, 
			b.Excerpt, 
			b.[Description], 
			b.StartDate,
			b.IsInNewsletter, 
			b.IncludeInFeed,
			'CommentCount' = CONVERT(nvarchar(20), b.CommentCount)
			

FROM        		mp_Blogs b

WHERE
    			(b.ModuleID = @ModuleID)  and (@BeginDate >= b.StartDate)

ORDER BY
   			b.ItemID DESC,  b.StartDate DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_SelectAllByModule]    Script Date: 05/11/2007 10:58:23 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SharedFileFolders_SelectAllByModule]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/9/2005
*/

@ModuleID		int


AS


SELECT
		[FolderID],
		ModuleID,
		[FolderName],
		[ParentID]
		
FROM
		[dbo].[mp_SharedFileFolders]

WHERE	ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_Update]    Script Date: 05/11/2007 10:58:24 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFileFolders_Update]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/5/2005
*/
	
@FolderID int, 
@ModuleID	int,
@FolderName nvarchar(255), 
@ParentID int 


AS

UPDATE 		[dbo].[mp_SharedFileFolders] 

SET
			ModuleID = @ModuleID,
			[FolderName] = @FolderName,
			[ParentID] = @ParentID
			
WHERE
			[FolderID] = @FolderID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_Insert]    Script Date: 05/11/2007 10:58:22 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFileFolders_Insert]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/5/2005


*/

@ModuleID	int,
@FolderName 	nvarchar(255),
@ParentID 	int

	
AS

INSERT INTO 	[dbo].[mp_SharedFileFolders] 
(
				ModuleID,
				[FolderName],
				[ParentID]
) 

VALUES 
(
				@ModuleID,
				@FolderName,
				@ParentID
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_SelectOne]    Script Date: 05/11/2007 10:58:24 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFileFolders_SelectOne]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/8/2005

*/

@FolderID int

AS


SELECT
		[FolderID],
		ModuleID,
		[FolderName],
		[ParentID]
		
FROM
		[dbo].[mp_SharedFileFolders]
		
WHERE
		[FolderID] = @FolderID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_SelectByModule]    Script Date: 05/11/2007 10:58:23 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFileFolders_SelectByModule]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/5/2005
*/

@ModuleID		int,
@ParentID		int


AS


SELECT
		[FolderID],
		[FolderName],
		[ParentID]
		
FROM
		[dbo].[mp_SharedFileFolders]

WHERE	ModuleID = @ModuleID
		AND ParentID = @ParentID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFileFolders_Delete]    Script Date: 05/11/2007 10:58:22 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFileFolders_Delete]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/5/2005


*/

@FolderID int

AS

DELETE FROM [dbo].[mp_SharedFileFolders]
WHERE
	[FolderID] = @FolderID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_Delete]    Script Date: 05/11/2007 10:56:57 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_Delete]

/*
Author:			Joe Audette
Created:		11/28/2004
Last Modified:	8/14/2006

*/

@ThreadID			int

AS

DELETE FROM mp_ForumPosts

WHERE	ThreadID = @ThreadID

DELETE FROM 		mp_ForumThreads


WHERE		ThreadID = @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Delete]    Script Date: 05/11/2007 10:56:50 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Forums_Delete]

/*
Author:				Joe Audette
Created:			6/27/2006
Last Modified:		8/14/2006

*/

@ItemID			int

AS

DELETE FROM mp_ForumPosts

WHERE ThreadID IN (SELECT ThreadID FROM mp_ForumThreads
					WHERE ForumID = @ItemID)

DELETE
FROM mp_ForumThreads
WHERE ForumID = @ItemID


DELETE
FROM			mp_Forums 

WHERE		ItemID = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectByThread]    Script Date: 05/11/2007 10:56:45 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_SelectByThread]

/*
Author:				Joe Audette
Created:			9/14/2004
Last Modified:			9/11/2005

An approach to paging grids in the database, hopefully more efficient than bringing back a zillion rows and
paging with a DataGrid using viewstate

ThreadSequence is the integer order that postss were created within the thread

*/

@ThreadID			int,
@PageNumber			int

AS

DECLARE @PostsPerPage	int
--DECLARE @TotalPosts		int
DECLARE @CurrentPageMaxThreadSequence	int

DECLARE @BeginSequence int
DECLARE @EndSequence int



SELECT	@PostsPerPage = f.PostsPerPage
		--@TotalPosts = ft.TotalReplies

FROM		mp_ForumThreads ft

JOIN		mp_Forums f
ON		ft.ForumID = f.ItemID

WHERE	ft.ThreadID = @ThreadID

SET @CurrentPageMaxThreadSequence = (@PostsPerPage * @PageNumber) 
IF @CurrentPageMaxThreadSequence > @PostsPerPage
	BEGIN
		SET @BeginSequence = @CurrentPageMaxThreadSequence  - @PostsPerPage + 1
	END
ELSE
	BEGIN
		SET @BeginSequence = 1
	END

SET @EndSequence = @BeginSequence + @PostsPerPage  -1



SELECT	p.*,
		ft.ForumID,
		'MostRecentPostUser' = COALESCE(u.[Name],'Guest'),
		'StartedBy' = COALESCE(s.[Name],'Guest'),
		'PostAuthor' = COALESCE(up.[Name], 'Guest'),
		'PostAuthorTotalPosts' = up.TotalPosts,
		'PostAuthorAvatar' = up.AvatarUrl,
		'PostAuthorWebSiteUrl' = up.WebSiteURL,
		'PostAuthorSignature' = up.Signature


FROM		mp_ForumPosts p

JOIN		mp_ForumThreads ft
ON		p.ThreadID = ft.ThreadID

LEFT OUTER JOIN		mp_Users u
ON		ft.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		mp_Users s
ON		ft.StartedByUserID = s.UserID

LEFT OUTER JOIN		mp_Users up
ON		up.UserID = p.UserID

WHERE	ft.ThreadID = @ThreadID
		AND p.ThreadSequence >= @BeginSequence
		AND  p.ThreadSequence <= @EndSequence

ORDER BY	p.SortOrder, p.PostID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectOne]    Script Date: 05/11/2007 10:56:46 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_SelectOne]

/*
Author:				Joe Audette
Created:			10/17/2004
Last Modified:			10/17/2004

*/

@PostID		int

AS


SELECT	fp.*

FROM		mp_ForumPosts fp

WHERE	fp.PostID = @PostID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectAllByThread]    Script Date: 05/11/2007 10:56:44 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_SelectAllByThread]

/*
Author:				Joe Audette
Created:			2/19/2005
Last Modified:			9/11/2005

An approach to paging grids in the database, hopefully more efficient than bringing back a zillion rows and
paging with a DataGrid using viewstate

ThreadSequence is the integer order that postss were created within the thread

*/

@ThreadID			int


AS


SELECT	p.*,
		ft.ForumID,
		'MostRecentPostUser' = COALESCE(u.[Name],'Guest'),
		'StartedBy' = COALESCE(s.[Name],'Guest'),
		'PostAuthor' = COALESCE(up.[Name], 'Guest'),
		'PostAuthorTotalPosts' = up.TotalPosts,
		'PostAuthorAvatar' = up.AvatarUrl,
		'PostAuthorWebSiteUrl' = up.WebSiteURL,
		'PostAuthorSignature' = up.Signature


FROM		mp_ForumPosts p

JOIN		mp_ForumThreads ft
ON		p.ThreadID = ft.ThreadID

LEFT OUTER JOIN		mp_Users u
ON		ft.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		mp_Users s
ON		ft.StartedByUserID = s.UserID

LEFT OUTER JOIN		mp_Users up
ON		up.UserID = p.UserID

WHERE	ft.ThreadID = @ThreadID
		

ORDER BY	p.SortOrder, p.PostID DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_Delete]    Script Date: 05/11/2007 10:56:43 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_Delete]

/*
Author:			Joe Audette
Created:		11/6/2004
Last Modified:		11/6/2004

*/

@PostID		int


AS

DELETE FROM mp_ForumPosts

WHERE PostID = @PostID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_Update]    Script Date: 05/11/2007 10:56:47 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_Update]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		9/19/2004

*/

@PostID			int,
@Subject			nvarchar(255),
@Post				ntext,
@SortOrder			int,
@Approved			bit

AS

UPDATE		mp_ForumPosts

SET			Subject = @Subject,
			Post = @Post,
			SortOrder = @SortOrder,
			Approved = @Approved


WHERE		PostID = @PostID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_DecrementReplyCount]    Script Date: 05/11/2007 10:56:57 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_DecrementReplyCount]

/*
Author:			Joe Audette
Created:		2/19/2005
Last Modified:		2/19/2005

*/

@ThreadID			int


AS

DECLARE @MostRecentPostUserID int
DECLARE @MostRecentPostDate datetime
 
SELECT TOP 1  @MostRecentPostUserID = UserID,
		@MostRecentPostDate = PostDate

FROM mp_ForumPosts 
WHERE ThreadID = @ThreadID 
ORDER BY PostID DESC


UPDATE		mp_ForumThreads

SET			MostRecentPostUserID = @MostRecentPostUserID,
			TotalReplies = TotalReplies - 1,
			MostRecentPostDate = @MostRecentPostDate


WHERE		ThreadID = @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_Insert]    Script Date: 05/11/2007 10:56:44 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_Insert]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		1/14/2007

*/


@ThreadID			int,
@Subject			nvarchar(255),
@Post				ntext,
@Approved			bit,
@UserID			int,
@PostDate		datetime



AS
DECLARE @ThreadSequence int
SET @ThreadSequence = (SELECT COALESCE(Max(ThreadSequence) + 1,1) FROM mp_ForumPosts WHERE ThreadID = @ThreadID)



INSERT INTO		mp_ForumPosts
(
			ThreadID,
			Subject,
			Post,
			Approved,
			UserID,
			ThreadSequence,
			PostDate
)

VALUES
(
			@ThreadID,
			@Subject,
			@Post,
			@Approved,
			@UserID,
			@ThreadSequence,
			@PostDate

)

SELECT  @@IDENTITY As PostID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_SelectForRss]    Script Date: 05/11/2007 10:56:46 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_SelectForRss]

/*
Author:				Joseph Hill
Created:			11/01/2005
Last Modified:			11/04/2005

A list of all forums posts (and associated data) filtered by the specified criteria

MaximumDays is the maximum age in days of the posts to return

*/
@SiteID				int,
@PageID				int,
@ModuleID			int,
@ItemID				int,
@ThreadID			int,
@MaximumDays			int


AS
SELECT		fp.*,
		ft.ThreadSubject,
		ft.ForumID,
		'StartedBy' = COALESCE(s.[Name],'Guest'),
		'PostAuthor' = COALESCE(up.[Name], 'Guest'),
		'PostAuthorTotalPosts' = up.TotalPosts,
		'PostAuthorAvatar' = up.AvatarUrl,
		'PostAuthorWebSiteUrl' = up.WebSiteURL,
		'PostAuthorSignature' = up.Signature


FROM		mp_ForumPosts fp

JOIN		mp_ForumThreads ft
ON		fp.ThreadID = ft.ThreadID

JOIN		mp_Forums f
ON		ft.ForumID = f.ItemID

JOIN		mp_Modules m
ON		f.ModuleID = m.ModuleID

JOIN	mp_PageModules pm
ON	    m.ModuleID = pm.ModuleID

JOIN		mp_Pages p
ON		pm.PageID = p.PageID

LEFT OUTER JOIN		mp_Users u
ON		ft.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		mp_Users s
ON		ft.StartedByUserID = s.UserID

LEFT OUTER JOIN		mp_Users up
ON		up.UserID = fp.UserID

WHERE	p.SiteID = @SiteID
AND	(@PageID = -1 OR p.PageID = @PageID)
AND	(@ModuleID = -1 OR m.ModuleID = @ModuleID)
AND	(@ItemID = -1 OR f.ItemID = @ItemID)
AND	(@ThreadID = -1 OR ft.ThreadID = @ThreadID)
AND	(@MaximumDays = -1 OR datediff(dd, getdate(), fp.PostDate) <= @MaximumDays)

ORDER BY	fp.PostDate DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumPosts_CountByThread]    Script Date: 05/11/2007 10:56:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumPosts_CountByThread]

/*
Author:				Joe Audette
Created:			11/28/2004
Last Modified:			11/28/2004

*/


@ThreadID		int



AS


SELECT	COUNT(*)

FROM		mp_ForumPosts

WHERE	ThreadID = @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByPage]    Script Date: 05/11/2007 10:57:03 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_SelectByPage]

/*
Author:			Joe Audettte
Created:		7/2/2005
Last Modified:		7/2/2005

*/


@SiteID		int,
@PageID		int

AS
SELECT  	fp.*,
		f.ModuleID,
		f.ItemID,
		m.ModuleTitle,
		md.FeatureName

FROM		mp_ForumPosts fp

JOIN		mp_ForumThreads ft
ON		fp.ThreadID = ft.ThreadID

JOIN		mp_Forums f
ON		f.ItemID = ft.ForumID

JOIN		mp_Modules m
ON		f.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID
		AND pm.PublishBeginDate < GetDate()
		AND (pm.PublishEndDate IS NULL OR pm.PublishEndDate > GetDate())
		AND fp.Approved = 1
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogItemCategories_Insert]    Script Date: 05/11/2007 10:56:35 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogItemCategories_Insert]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			6/7/2005


*/

@ItemID int,
@CategoryID int

	
AS

INSERT INTO 	[dbo].[mp_BlogItemCategories] 
(
				[ItemID],
				[CategoryID]
) 

VALUES 
(
				@ItemID,
				@CategoryID
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogItemCategories_Delete]    Script Date: 05/11/2007 10:56:34 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogItemCategories_Delete]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			6/7/2005

*/

@ItemID int

AS

DELETE FROM [dbo].[mp_BlogItemCategories]
WHERE
	[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogItemCategories_SelectByItem]    Script Date: 05/11/2007 10:56:35 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogItemCategories_SelectByItem]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			6/7/2005
*/

@ItemID	int

AS


SELECT
		bic.[ID],
		bic.[ItemID],
		bic.[CategoryID],
		bc.Category
		
FROM
		[dbo].[mp_BlogItemCategories] bic

JOIN		mp_BlogCategories bc
ON		bc.CategoryID = bic.CategoryID

WHERE	ItemID = @ItemID

ORDER BY	bc.Category
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_SelectByModule]    Script Date: 05/11/2007 10:56:30 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogCategories_SelectByModule]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			9/11/2005
*/

@ModuleID			int

AS


SELECT
				bc.CategoryID, 
				bc.Category,
				COUNT(bic.ItemID) As PostCount
		
		
FROM
			[dbo].[mp_BlogCategories] bc

JOIN			mp_BlogItemCategories bic
ON 			bc.CategoryID = bic.CategoryID

WHERE		bc.ModuleID = @ModuleID
			

GROUP BY		bc.CategoryID, bc.Category

ORDER BY		bc.Category
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_Delete]    Script Date: 05/11/2007 10:56:29 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogCategories_Delete]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			6/12/2005

*/

@CategoryID int

AS

DELETE FROM mp_BlogItemCategories
WHERE	CategoryID = @CategoryID

DELETE FROM [dbo].[mp_BlogCategories]
WHERE
	[CategoryID] = @CategoryID
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_SelectListByModule]    Script Date: 05/11/2007 10:56:31 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_BlogCategories_SelectListByModule]

/*
Author:   			Joe Audette
Created: 			9/11/2005
Last Modified: 			9/11/2005
*/

@ModuleID			int

AS


SELECT
				bc.CategoryID, 
				bc.Category,
				COUNT(bic.ItemID) As PostCount
		
		
FROM
			[dbo].[mp_BlogCategories] bc

LEFT OUTER JOIN	mp_BlogItemCategories bic
ON 			bc.CategoryID = bic.CategoryID

WHERE		bc.ModuleID = @ModuleID
			

GROUP BY		bc.CategoryID, bc.Category

ORDER BY		bc.Category
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAdministration_GetCountOfState]    Script Date: 05/11/2007 10:58:41 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SitePersonalizationAdministration_GetCountOfState] 

@SiteID		int,
@Path 			nvarchar(255) = NULL,
@AllUsersScope 	bit,
@UserID 		uniqueidentifier ,
@InactiveSinceDate 	datetime = NULL


AS

BEGIN

    
        IF (@AllUsersScope = 1)
            SELECT 		COUNT(*)
            FROM 			mp_SitePersonalizationAllUsers spa
	JOIN			mp_SitePaths sp
	ON 			spa.PathID = sp.PathID
            	WHERE 		sp.SiteID = @SiteID
                  			AND (@Path IS NULL OR sp.LoweredPath LIKE LOWER(@Path))
        ELSE
            	SELECT 		COUNT(*)
            	FROM 			mp_SitePersonalizationPerUser spu
	JOIN	 		mp_SitePaths sp
	ON 			spu.PathID = sp.PathID
	LEFT OUTER JOIN	mp_Users u
	ON 			spu.UserID = u.UserGuid

            WHERE 		sp.SiteID = @SiteID
                  			AND (@Path IS NULL OR sp.LoweredPath LIKE LOWER(@Path))
                  			AND (@UserID = '{00000000-0000-0000-0000-000000000000}' OR u.UserGuid = @UserID)
                 			 AND (@InactiveSinceDate IS NULL OR u.LastActivityDate <= @InactiveSinceDate)
END
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationPerUser_GetPageSettings]    Script Date: 05/11/2007 10:58:44 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SitePersonalizationPerUser_GetPageSettings] 
(
   
@SiteID		int,
@Path             	NVARCHAR(255),
@UserId        	UNIQUEIDENTIFIER


)

AS
BEGIN
   
    DECLARE @PathId UNIQUEIDENTIFIER
    SELECT @PathId = NULL
    
    SELECT @PathId = u.PathID 
    FROM mp_SitePaths u WHERE u.SiteID = @SiteID AND u.LoweredPath = LOWER(@Path)
    IF (@PathId IS NULL)
    BEGIN
        RETURN
    END


    SELECT p.PageSettings 
	FROM mp_SitePersonalizationPerUser p 
	WHERE p.PathID = @PathId AND p.UserId = @UserId

END
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationPerUser_ResetPageSettings]    Script Date: 05/11/2007 10:58:45 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SitePersonalizationPerUser_ResetPageSettings]
 (
    @SiteID		int,
    @Path             	NVARCHAR(255),
    @UserId        	UNIQUEIDENTIFIER

)
AS
BEGIN
    
    DECLARE @PathId UNIQUEIDENTIFIER
    SELECT @PathId = NULL
   

    SELECT @PathId = u.PathId FROM mp_SitePaths u WHERE u.SiteID = @SiteID AND u.LoweredPath = LOWER(@Path)
    IF (@PathId IS NULL)
    BEGIN
        RETURN
    END


    DELETE FROM mp_SitePersonalizationPerUser WHERE PathID = @PathId AND UserId = @UserId
    RETURN 0
END
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_Insert]    Script Date: 05/11/2007 10:56:59 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_Insert]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		1/14/2007

*/

@ForumID			int,
@ThreadSubject		nvarchar(255),
@SortOrder			int,
@IsLocked			bit,
@StartedByUserID		int,
@ThreadDate		datetime


AS
DECLARE @ThreadID int
DECLARE @ForumSequence int
SET @ForumSequence = (SELECT COALESCE(Max(ForumSequence) + 1,1) FROM mp_ForumThreads WHERE ForumID = @ForumID)

INSERT INTO		mp_ForumThreads
(
			ForumID,
			ThreadSubject,
			SortOrder,
			ForumSequence,
			IsLocked,
			StartedByUserID,
			ThreadDate,
			MostRecentPostUserID,
			MostRecentPostDate

)

VALUES
(
			
			@ForumID,
			@ThreadSubject,
			@SortOrder,
			@ForumSequence,
			@IsLocked,
			@StartedByUserID,
			@ThreadDate,
			@StartedByUserID,
			@ThreadDate


)

SELECT @ThreadID = @@IDENTITY 


INSERT INTO mp_ForumThreadSubscriptions (ThreadID, UserID)
	SELECT @ThreadID, UserID FROM mp_ForumSubscriptions fs 
		WHERE fs.ForumID = @ForumID AND fs.SubscribeDate IS NOT NULL 
				AND fs.UnSubscribeDate IS NULL

SELECT @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumSubscriptions_Insert]    Script Date: 05/11/2007 10:56:56 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumSubscriptions_Insert]

/*
Author:			Dean Brettle
Created:		9/11/2005
Last Modified:		9/11/2005

*/

@ForumID		int,
@UserID		int


AS

IF EXISTS (SELECT UserID FROM mp_ForumSubscriptions WHERE ForumID = @ForumID AND UserID = @UserID)
BEGIN
	UPDATE 	mp_ForumSubscriptions

	SET		SubscribeDate = GetDate(),
			UnSubscribeDate = Null
	

	WHERE 	ForumID = @ForumID AND UserID = @UserID

END

ELSE

BEGIN

	INSERT INTO	mp_ForumSubscriptions
	(
			ForumID,
			UserID
	)
	VALUES
	(
			@ForumID,
			@UserID
	)

END
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumSubscriptions_Unsubscribe]    Script Date: 05/11/2007 10:56:57 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumSubscriptions_Unsubscribe]

/*
Author:				Dean Brettle
Created:			9/11/2005
Last Modified:			9/11/2005

*/

@ForumID		int,
@UserID		int

AS

UPDATE		mp_ForumSubscriptions

SET			UnSubscribeDate = GetDate()

WHERE		ForumID = @ForumID
			AND UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Select]    Script Date: 05/11/2007 10:56:53 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Forums_Select]


/*
Author:			Joe Audette
Created:		9/12/2004
Last Modified:		9/12/2004

*/

@ModuleID			int,
@UserID				int

AS


SELECT		f.*,
			'MostRecentPostUser' = u.[Name],
			'Subscribed' = CASE WHEN s.[SubscribeDate] IS NOT NULL and s.[UnSubscribeDate] IS NULL THEN 1
					Else 0
					End

FROM			mp_Forums f

LEFT OUTER JOIN	mp_Users u
ON			f.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN mp_ForumSubscriptions s
on			f.ItemID = s.ForumID and s.UserID = @UserID

WHERE		f.ModuleID	= @ModuleID
			AND f.IsActive = 1

ORDER BY		f.SortOrder, f.ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogStats_Select]    Script Date: 05/11/2007 10:56:36 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_BlogStats_Select]
(
    @ModuleID int
)
AS

SELECT		
			ModuleID, 
			EntryCount,
			CommentCount

FROM       		 mp_BlogStats

WHERE
    			ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_Update]    Script Date: 05/11/2007 10:58:21 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaVersion_Update]

/*
Author:   			Joe Audette
Created: 			1/29/2007
Last Modified: 		1/29/2007
*/
	
@ApplicationID uniqueidentifier, 
@ApplicationName nvarchar(255), 
@Major int, 
@Minor int, 
@Build int, 
@Revision int 


AS

UPDATE 		[dbo].[mp_SchemaVersion] 

SET
			[ApplicationName] = @ApplicationName,
			[Major] = @Major,
			[Minor] = @Minor,
			[Build] = @Build,
			[Revision] = @Revision
			
WHERE
			[ApplicationID] = @ApplicationID
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_Delete]    Script Date: 05/11/2007 10:58:17 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaVersion_Delete]

/*
Author:   			Joe Audette
Created: 			1/29/2007
Last Modified: 		1/29/2007
*/

@ApplicationID uniqueidentifier

AS

DELETE FROM [dbo].[mp_SchemaVersion]
WHERE
	[ApplicationID] = @ApplicationID
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_SelectAll]    Script Date: 05/11/2007 10:58:19 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaVersion_SelectAll]

/*
Author:   			Joe Audette
Created: 			1/29/2007
Last Modified: 		1/29/2007
*/

AS


SELECT
		[ApplicationID],
		[ApplicationName],
		[Major],
		[Minor],
		[Build],
		[Revision]
		
FROM
		[dbo].[mp_SchemaVersion]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_SelectOne]    Script Date: 05/11/2007 10:58:19 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SchemaVersion_SelectOne]

/*
Author:   			Joe Audette
Created: 			1/29/2007
Last Modified: 		1/29/2007
*/

@ApplicationID uniqueidentifier

AS


SELECT
		[ApplicationID],
		[ApplicationName],
		[Major],
		[Minor],
		[Build],
		[Revision]
		
FROM
		[dbo].[mp_SchemaVersion]
		
WHERE
		[ApplicationID] = @ApplicationID
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaVersion_Insert]    Script Date: 05/11/2007 10:58:18 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaVersion_Insert]

/*
Author:   			Joe Audette
Created: 			1/29/2007
Last Modified: 		1/29/2007
*/

@ApplicationID uniqueidentifier,
@ApplicationName nvarchar(255),
@Major int,
@Minor int,
@Build int,
@Revision int

	
AS

INSERT INTO 	[dbo].[mp_SchemaVersion] 
(
				[ApplicationID],
				[ApplicationName],
				[Major],
				[Minor],
				[Build],
				[Revision]
) 

VALUES 
(
				@ApplicationID,
				@ApplicationName,
				@Major,
				@Minor,
				@Build,
				@Revision
				
)
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_SelectByPage]    Script Date: 05/11/2007 10:57:25 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_HtmlContent_SelectByPage]

/*
Author:			Joe Audettte
Created:		6/26/2005
Last Modified:		6/27/2005

*/


@SiteID		int,
@PageID		int

AS
SELECT  	h.*,
		m.ModuleTitle,
		md.FeatureName

FROM		mp_HtmlContent h

JOIN		mp_Modules m
ON		h.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID
		AND pm.PublishBeginDate < GetDate()
		AND (pm.PublishEndDate IS NULL OR pm.PublishEndDate > GetDate())
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Select]    Script Date: 05/11/2007 10:57:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_HtmlContent_Select]

/*
Author:			Joe Audettte
Created:		12/23/2004
Last Modified:		1/14/2007

*/


@ModuleID int,
@BeginDate datetime

AS
SELECT  	*

FROM		mp_HtmlContent

WHERE	ModuleID = @ModuleID
		AND BeginDate <= @BeginDate
		AND EndDate >= @BeginDate
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Insert]    Script Date: 05/11/2007 10:57:22 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_HtmlContent_Insert]

/*
Author:   			Joe Audette
Created: 			12/23/2004
Last Modified: 			12/23/2004

*/

@ModuleID int,
@Title nvarchar(255),
@Excerpt ntext,
@Body ntext,
@MoreLink nvarchar(255),
@SortOrder int,
@BeginDate datetime,
@EndDate datetime,
@CreatedDate datetime,
@UserID int

	
AS

INSERT INTO 	[dbo].[mp_HtmlContent] 
(
				[ModuleID],
				[Title],
				[Excerpt],
				[Body],
				[MoreLink],
				[SortOrder],
				[BeginDate],
				[EndDate],
				[CreatedDate],
				[UserID]
) 

VALUES 
(
				@ModuleID,
				@Title,
				@Excerpt,
				@Body,
				@MoreLink,
				@SortOrder,
				@BeginDate,
				@EndDate,
				@CreatedDate,
				@UserID
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Update]    Script Date: 05/11/2007 10:57:27 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_HtmlContent_Update]

/*
Author:   			Joe Audette
Created: 			12/23/2004
Last Modified: 			12/23/2004


*/
	
@ItemID int, 
@ModuleID int, 
@Title nvarchar(255), 
@Excerpt ntext, 
@Body ntext, 
@MoreLink nvarchar(255), 
@SortOrder int, 
@BeginDate datetime, 
@EndDate datetime, 
@CreatedDate datetime, 
@UserID int 


AS

UPDATE 		[dbo].[mp_HtmlContent] 

SET
			[ModuleID] = @ModuleID,
			[Title] = @Title,
			[Excerpt] = @Excerpt,
			[Body] = @Body,
			[MoreLink] = @MoreLink,
			[SortOrder] = @SortOrder,
			[BeginDate] = @BeginDate,
			[EndDate] = @EndDate,
			[CreatedDate] = @CreatedDate,
			[UserID] = @UserID
			
WHERE
			[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_SelectAll]    Script Date: 05/11/2007 10:57:24 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_HtmlContent_SelectAll]

/*
Author:   			Joe Audette
Created: 			12/23/2004
Last Modified: 			12/23/2004


*/

AS


SELECT	*
		
FROM
		[dbo].[mp_HtmlContent]
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_Delete]    Script Date: 05/11/2007 10:57:21 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_HtmlContent_Delete]

/*
Author:   			Joe Audette
Created: 			12/23/2004
Last Modified: 			12/23/2004

*/

@ItemID int

AS

DELETE FROM [dbo].[mp_HtmlContent]
WHERE
	[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_HtmlContent_SelectOne]    Script Date: 05/11/2007 10:57:25 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_HtmlContent_SelectOne]

/*
Author:			Joe Audettte
Created:		12/23/2004
Last Modified:		12/23/2004

*/


@ItemID	int

AS

SELECT  	*

FROM		mp_HtmlContent

WHERE	ItemID = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscriptions_UnsubscribeThread]    Script Date: 05/11/2007 10:57:07 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreadSubscriptions_UnsubscribeThread]

/*
Author:				Joe Audette
Created:			10/14/2004
Last Modified:			10/14/2004

*/

@ThreadID		int,
@UserID		int

AS

UPDATE		mp_ForumThreadSubscriptions

SET			UnSubscribeDate = GetDate()

WHERE		ThreadID = @ThreadID
			AND UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscriptions_UnsubscribeAllThreads]    Script Date: 05/11/2007 10:57:07 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreadSubscriptions_UnsubscribeAllThreads]

/*
Author:				Joe Audette
Created:			10/14/2004
Last Modified:			10/14/2004

*/

@UserID		int

AS

UPDATE		mp_ForumThreadSubscriptions

SET			UnSubscribeDate = GetDate()

WHERE		
			UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscriptions_Insert]    Script Date: 05/11/2007 10:57:06 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreadSubscriptions_Insert]

/*
Author:			Joe Audette
Created:		10/14/2004
Last Modified:		1/21/2006

*/

@ThreadID		int,
@UserID		int


AS

IF EXISTS (SELECT UserID FROM mp_ForumThreadSubscriptions WHERE ThreadID = @ThreadID AND UserID = @UserID)
BEGIN
	UPDATE 	mp_ForumThreadSubscriptions

	SET		SubscribeDate = GetDate(),
			UnSubscribeDate = Null
	

	WHERE 	ThreadID = @ThreadID AND UserID = @UserID

END

ELSE

BEGIN

	INSERT INTO	mp_ForumThreadSubscriptions
	(
			ThreadID,
			UserID
	)
	VALUES
	(
			@ThreadID,
			@UserID
	)

END
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreadSubscribers_SelectByThread]    Script Date: 05/11/2007 10:57:05 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ForumThreadSubscribers_SelectByThread]

/*
Author:				Joe Audette
Created:			10/13/2004
Last Modified:			10/13/2004

*/


@ThreadID		int,
@CurrentPostUserID 	int


AS

SELECT		u.Email


FROM			mp_Users u

JOIN			mp_ForumThreadSubscriptions s
ON			u.UserID = s.UserID

WHERE		s.ThreadID = @ThreadID
			AND s.UnSubscribeDate IS NULL
			AND u.UserID <> @CurrentPostUserID
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_GetMostPopularWebPartsForMyPage]    Script Date: 05/11/2007 10:59:58 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_WebParts_GetMostPopularWebPartsForMyPage]

/*
Author:				Joe Audette
Created:			6/11/2006
Last Modified:		6/11/2006

*/

@SiteID		int


AS

SELECT TOP 15 dt.* 
FROM
(

SELECT  		m.ModuleID,
				m.SiteID,
				m.ModuleDefID,
				m.ModuleTitle,
				m.AllowMultipleInstancesOnMyPage,
				m.CountOfUseOnMyPage ,
				m.Icon As ModuleIcon,
				md.Icon As FeatureIcon,
				md.FeatureName,
				0 As IsAssembly,
				'' As WebPartID
				
				
				
				
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

WHERE   
    			m.SiteID = @SiteID
				AND m.AvailableForMyPage = 1

UNION

SELECT
				0 As ModuleID,
				w.SiteID,
				0 As MuduleDefID,
				w.Title As ModuleTitle,
				w.AllowMultipleInstancesOnMyPage,
				w.CountOfUseOnMyPage ,
				w.ImageUrl As ModuleIcon,
				w.ImageUrl As FeatureIcon,
				w.Description As FeatureName,
				1 As IsAssembly,
				CONVERT(varchar(36),w.WebPartID) As WebPartID

FROM			mp_WebParts w

WHERE			w.SiteID = @SiteID
				AND w.AvailableForMyPage = 1
				



		
    
--ORDER BY		CountOfUseOnMyPage DESC, ModuleTitle

) dt

ORDER BY dt.CountOfUseOnMyPage DESC, dt.ModuleTitle
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_GetCount]    Script Date: 05/11/2007 10:59:58 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_WebParts_GetCount]

/*
Author:				Joe Audette
Created:			6/11/2006
Last Modified:		6/11/2006

*/

@SiteID		int


AS

SELECT Count(*)
FROM
(

SELECT  		m.ModuleID
				
				
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

WHERE   
    			m.SiteID = @SiteID
				AND m.AvailableForMyPage = 1

UNION

SELECT
				0 As ModuleID
				

FROM			mp_WebParts w

WHERE			w.SiteID = @SiteID
				AND w.AvailableForMyPage = 1
				


) dt
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_UpdateCountOfUseOnMyPage]    Script Date: 05/11/2007 11:00:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_WebParts_UpdateCountOfUseOnMyPage]

/*
Author:   			Joe Audette
Created: 			6/15/2006
Last Modified: 		6/15/2006
*/
	
@WebPartID uniqueidentifier, 
@Increment	int


AS
UPDATE 		[dbo].[mp_WebParts] 

SET
			CountOfUseOnMyPage = CountOfUseOnMyPage + @Increment
			
WHERE
			[WebPartID] = @WebPartID
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_Update]    Script Date: 05/11/2007 11:00:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_WebParts_Update]

/*
Author:   			Joe Audette
Created: 			6/3/2006
Last Modified: 		6/3/2006
*/
	
@WebPartID uniqueidentifier, 
@SiteID int, 
@Title nvarchar(255), 
@Description nvarchar(255), 
@ImageUrl nvarchar(255), 
@ClassName nvarchar(255), 
@AssemblyName nvarchar(255), 
@AvailableForMyPage bit, 
@AllowMultipleInstancesOnMyPage bit, 
@AvailableForContentSystem bit 


AS

UPDATE 		[dbo].[mp_WebParts] 

SET
			[SiteID] = @SiteID,
			[Title] = @Title,
			[Description] = @Description,
			[ImageUrl] = @ImageUrl,
			[ClassName] = @ClassName,
			[AssemblyName] = @AssemblyName,
			[AvailableForMyPage] = @AvailableForMyPage,
			[AllowMultipleInstancesOnMyPage] = @AllowMultipleInstancesOnMyPage,
			[AvailableForContentSystem] = @AvailableForContentSystem
			
WHERE
			[WebPartID] = @WebPartID
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_GetWebPartsForMyPage]    Script Date: 05/11/2007 10:59:59 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_WebParts_GetWebPartsForMyPage]

/*
Author:				Joe Audette
Created:			6/11/2006
Last Modified:		6/11/2006

*/

@SiteID		int


AS
SELECT  		m.ModuleID,
				m.SiteID,
				m.ModuleDefID,
				m.ModuleTitle,
				m.AllowMultipleInstancesOnMyPage,
				m.CountOfUseOnMyPage ,
				m.Icon As ModuleIcon,
				md.Icon As FeatureIcon,
				md.FeatureName,
				0 As IsAssembly,
				'' As WebPartID
				
				
				
				
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

WHERE   
    			m.SiteID = @SiteID
				AND m.AvailableForMyPage = 1

UNION

SELECT
				-1 As ModuleID,
				w.SiteID,
				0 As MuduleDefID,
				w.Title As ModuleTitle,
				w.AllowMultipleInstancesOnMyPage,
				w.CountOfUseOnMyPage ,
				w.ImageUrl As ModuleIcon,
				w.ImageUrl As FeatureIcon,
				w.Description As FeatureName,
				1 As IsAssembly,
				CONVERT(varchar(36),w.WebPartID) As WebPartID

FROM			mp_WebParts w

WHERE			w.SiteID = @SiteID
				AND w.AvailableForMyPage = 1
				



		
    
ORDER BY
    			ModuleTitle
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_Insert]    Script Date: 05/11/2007 11:00:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_WebParts_Insert]

/*
Author:   			Joe Audette
Created: 			6/3/2006
Last Modified: 		6/3/2006
*/

@WebPartID	uniqueidentifier,
@SiteID int,
@Title nvarchar(255),
@Description nvarchar(255),
@ImageUrl nvarchar(255),
@ClassName nvarchar(255),
@AssemblyName nvarchar(255),
@AvailableForMyPage bit,
@AllowMultipleInstancesOnMyPage bit,
@AvailableForContentSystem bit

	
AS



INSERT INTO 	[dbo].[mp_WebParts] 
(
				[WebPartID],
				[SiteID],
				[Title],
				[Description],
				[ImageUrl],
				[ClassName],
				[AssemblyName],
				[AvailableForMyPage],
				[AllowMultipleInstancesOnMyPage],
				[AvailableForContentSystem]
) 

VALUES 
(
				@WebPartID,
				@SiteID,
				@Title,
				@Description,
				@ImageUrl,
				@ClassName,
				@AssemblyName,
				@AvailableForMyPage,
				@AllowMultipleInstancesOnMyPage,
				@AvailableForContentSystem
				
)
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_SelectOne]    Script Date: 05/11/2007 11:00:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_WebParts_SelectOne]

/*
Author:   			Joe Audette
Created: 			6/3/2006
Last Modified: 		6/3/2006
*/

@WebPartID uniqueidentifier

AS


SELECT
		[WebPartID],
		[SiteID],
		[Title],
		[Description],
		[ImageUrl],
		[ClassName],
		[AssemblyName],
		[AvailableForMyPage],
		[AllowMultipleInstancesOnMyPage],
		[AvailableForContentSystem]
		
FROM
		[dbo].[mp_WebParts]
		
WHERE
		[WebPartID] = @WebPartID
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_SelectBySite]    Script Date: 05/11/2007 11:00:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_WebParts_SelectBySite]

/*
Author:   			Joe Audette
Created: 			6/11/2006
Last Modified: 		6/11/2006
*/

@SiteID		int

AS
SELECT
		[WebPartID],
		[SiteID],
		[Title],
		[Description],
		[ImageUrl],
		[ClassName],
		[AssemblyName],
		[AvailableForMyPage],
		[AllowMultipleInstancesOnMyPage],
		[AvailableForContentSystem]
		
FROM
		[dbo].[mp_WebParts]
		
WHERE
		[SiteID] = @SiteID
		AND AvailableForContentSystem = 1
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_Delete]    Script Date: 05/11/2007 10:59:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_WebParts_Delete]

/*
Author:   			Joe Audette
Created: 			6/3/2006
Last Modified: 		6/3/2006
*/

@WebPartID uniqueidentifier

AS

DELETE FROM [dbo].[mp_WebParts]
WHERE
	[WebPartID] = @WebPartID
GO
/****** Object:  StoredProcedure [dbo].[mp_WebParts_WebPartExists]    Script Date: 05/11/2007 11:00:04 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_WebParts_WebPartExists]

/*
Author:			Joe Audette
Created:		6/7/2006
Last Modified:	6/7/2006

*/
    
@SiteID  	int,
@ClassName	nvarchar(255),
@AssemblyName	nvarchar(255)

AS
IF EXISTS (	SELECT 	WebPartID
		FROM		mp_WebParts
		WHERE	SiteID = @SiteID
				AND (ClassName = @ClassName AND AssemblyName = @AssemblyName))
SELECT 1
ELSE
SELECT 0
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_SelectByPage]    Script Date: 05/11/2007 10:57:29 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Links_SelectByPage]

/*
Author:			Joe Audettte
Created:		7/4/2005
Last Modified:		7/4/2005

*/


@SiteID		int,
@PageID		int

AS
SELECT  	u.*,
		
		m.ModuleTitle,
		md.FeatureName

FROM		mp_Links u

JOIN		mp_Modules m
ON		u.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID
		AND pm.PublishBeginDate < GetDate()
		AND (pm.PublishEndDate IS NULL OR pm.PublishEndDate > GetDate())
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Insert]    Script Date: 05/11/2007 10:57:28 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Links_Insert]

/*
Author:   			Joe Audette
Created: 			12/24/2004
Last Modified: 			8/7/2005

*/

@ModuleID int,
@Title nvarchar(255),
@Url nvarchar(255),
@ViewOrder int,
@Description ntext,
@CreatedDate datetime,
@CreatedBy int,
@Target nvarchar(20)

	
AS

INSERT INTO 	[dbo].[mp_Links] 
(
				[ModuleID],
				[Title],
				[Url],
				[ViewOrder],
				[Description],
				[CreatedDate],
				[CreatedBy],
				Target
) 

VALUES 
(
				@ModuleID,
				@Title,
				@Url,
				@ViewOrder,
				@Description,
				@CreatedDate,
				@CreatedBy,
				@Target
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_SelectOne]    Script Date: 05/11/2007 10:57:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Links_SelectOne]

    
@ItemID int

AS

SELECT
   *

FROM
    mp_Links

WHERE
    ItemID = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Delete]    Script Date: 05/11/2007 10:57:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Links_Delete]

    
@ItemID int


AS

DELETE FROM
    mp_Links

WHERE
    ItemID = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Update]    Script Date: 05/11/2007 10:57:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Links_Update]

/*
Author:   			Joe Audette
Created: 			12/24/2004
Last Modified: 			8/7/2005

*/
	
@ItemID int, 
@ModuleID int, 
@Title nvarchar(255), 
@Url nvarchar(255), 
@ViewOrder int, 
@Description ntext, 
@CreatedDate datetime, 
@CreatedBy int ,
@Target nvarchar(20)


AS

UPDATE 		[dbo].[mp_Links] 

SET
			[ModuleID] = @ModuleID,
			[Title] = @Title,
			[Url] = @Url,
			Target = @Target,
			[ViewOrder] = @ViewOrder,
			[Description] = @Description,
			[CreatedDate] = @CreatedDate,
			[CreatedBy] = @CreatedBy
			
WHERE
			[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_Links_Select]    Script Date: 05/11/2007 10:57:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Links_Select]

    
@ModuleID int

AS

SELECT	*

FROM
    mp_Links

WHERE
    ModuleID = @ModuleID

ORDER BY
    ViewOrder, ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Update]    Script Date: 05/11/2007 10:57:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Update]
(
    @ModuleID      int,
    @SettingName   nvarchar(50),
    @SettingValue  nvarchar(255)
)
AS

IF NOT EXISTS (
    SELECT 
        * 
    FROM 
        mp_ModuleSettings 
    WHERE 
        ModuleID = @ModuleID
      AND
        SettingName = @SettingName
)
INSERT INTO mp_ModuleSettings (
    ModuleID,
    SettingName,
    SettingValue
) 
VALUES (
    @ModuleID,
    @SettingName,
    @SettingValue
)
ELSE
UPDATE
    mp_ModuleSettings

SET
    SettingValue = @SettingValue

WHERE
    ModuleID = @ModuleID
  AND
    SettingName = @SettingName
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Delete]    Script Date: 05/11/2007 10:57:49 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Delete]

/*
Author:			Joe Audette
Created:		1/1/2005
Last Modified:		1/1/2005

*/

@ModuleID		int

AS

DELETE FROM mp_ModuleSettings

WHERE	ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Insert]    Script Date: 05/11/2007 10:57:50 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Insert]

/*
Author:			Joe Audette
Created:		6/9/2005
Last Modified:		6/9/2005

*/



@ModuleID			int,
@SettingName			nvarchar(50),
@SettingValue			nvarchar(255),
@ControlType			nvarchar(50),
@RegexValidationExpression 	ntext




AS

INSERT INTO 	mp_ModuleSettings
(
			ModuleID,
			SettingName,
			SettingValue,
			ControlType,
			RegexValidationExpression
)

VALUES
(
			@ModuleID,
			@SettingName,
			@SettingValue,
			@ControlType,
			@RegexValidationExpression
)
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_CreateDefaultSettings]    Script Date: 05/11/2007 10:57:49 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_CreateDefaultSettings]

/*
Author:			Joe Audette
Created:		1/1/2005
Last Modified:		1/1/2005

*/



@ModuleID		int


AS

INSERT INTO 	mp_ModuleSettings
(
			ModuleID,
			SettingName,
			SettingValue,
			ControlType,
			RegexValidationExpression
)

SELECT		m.ModuleID,
			ds.SettingName,
			ds.SettingValue,
			ds.ControlType,
			ds.RegexValidationExpression


FROM			mp_Modules m

JOIN			mp_ModuleDefinitionSettings ds
ON			ds.ModuleDefID = m.ModuleDefID

WHERE		m.ModuleID = @ModuleID

ORDER BY		ds.[ID]
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleSettings_Select]    Script Date: 05/11/2007 10:57:51 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleSettings_Select]
(
    @ModuleID int
)
AS

SELECT	*

FROM		mp_ModuleSettings

WHERE	ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_UpdatePage]    Script Date: 05/11/2007 10:57:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_UpdatePage]

	
@OldPageID				int,
@NewPageID			int,
@ModuleID           int
    

AS
UPDATE
    mp_PageModules

SET
    PageID = @NewPageID

WHERE
    ModuleID = @ModuleID
	AND PageID = @OldPageID
GO
/****** Object:  StoredProcedure [dbo].[mp_PageModule_Exists]    Script Date: 05/11/2007 10:57:53 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_PageModule_Exists]

/*
Author:			Joe Audette
Created:		5/18/2006
Last Modified:	5/18/2006

*/
    
@ModuleID  	int,
@PageID		int

AS
IF EXISTS (	SELECT 	ModuleID
		FROM		mp_PageModules
		WHERE	ModuleID = @ModuleID
				AND PageID = @PageID )
SELECT 1
ELSE
SELECT 0
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_Insert]    Script Date: 05/11/2007 10:57:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_Insert]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 		6/4/2006

*/

@PageID int,
@SiteID		int,
@ModuleDefID int,
@ModuleOrder int,
@PaneName nvarchar(50),
@ModuleTitle nvarchar(255),
@AuthorizedEditRoles ntext,
@CacheTime int,
@ShowTitle bit,
@AvailableForMyPage	bit,
@CreatedByUserID	int,
@CreatedDate		datetime,
@AllowMultipleInstancesOnMyPage	bit,
@Icon	nvarchar(255)

	
AS
DECLARE @ModuleID int

INSERT INTO 	[dbo].[mp_Modules] 
(
				SiteID,
				[ModuleDefID],
				[ModuleTitle],
				[AuthorizedEditRoles],
				[CacheTime],
				[ShowTitle],
				AvailableForMyPage,
				AllowMultipleInstancesOnMyPage,
				Icon,
				CreatedByUserID,
				CreatedDate
) 

VALUES 
(
				@SiteID,
				@ModuleDefID,
				@ModuleTitle,
				@AuthorizedEditRoles,
				@CacheTime,
				@ShowTitle,
				@AvailableForMyPage,
				@AllowMultipleInstancesOnMyPage,
				@Icon,
				@CreatedByUserID,
				@CreatedDate
				
)
SELECT @ModuleID =  @@IDENTITY

IF @PageID > -1
BEGIN
INSERT INTO 	[dbo].[mp_PageModules] 
(
				[PageID],
				[ModuleID],
				[ModuleOrder],
				[PaneName]
				
) 

VALUES 
(
				@PageID,
				@ModuleID,
				@ModuleOrder,
				@PaneName
				
				
)
END


SELECT @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectOneByPage]    Script Date: 05/11/2007 10:57:43 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectOneByPage]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 		6/4/2006

*/

@ModuleID int,
@PageID		int

AS
SELECT  		m.ModuleID,
				m.SiteID,
				pm.PageID,
				m.ModuleDefID,
				pm.ModuleOrder,
				pm.PaneName,
				m.ModuleTitle,
				m.AuthorizedEditRoles,
				m.CacheTime,
				m.ShowTitle,
				m.EditUserID,
				m.AvailableForMyPage,
				m.AllowMultipleInstancesOnMyPage,
				m.Icon,
				m.CreatedByUserID,
				m.CreatedDate,
				pm.PublishBeginDate,
				pm.PublishEndDate,
				md.ControlSrc
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

INNER JOIN		mp_PageModules pm
ON				m.ModuleID = pm.ModuleID
    
WHERE   
    			pm.PageID = @PageID
				AND pm.ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_SelectByPage]    Script Date: 05/11/2007 10:56:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_CalendarEvents_SelectByPage]

/*
Author:			Joe Audettte
Created:		7/4/2005
Last Modified:		7/4/2005

*/


@SiteID		int,
@PageID		int

AS
SELECT  	ce.*,
		
		m.ModuleTitle,
		md.FeatureName

FROM		mp_CalendarEvents ce

JOIN		mp_Modules m
ON		ce.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID
		AND pm.PublishBeginDate < GetDate()
		AND (pm.PublishEndDate IS NULL OR pm.PublishEndDate > GetDate())
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_SelectByPage]    Script Date: 05/11/2007 10:58:27 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SharedFiles_SelectByPage]

/*
Author:			Joe Audettte
Created:		7/4/2005
Last Modified:		7/4/2005

*/


@SiteID		int,
@PageID		int

AS
SELECT  	sf.*,
		
		m.ModuleTitle,
		md.FeatureName

FROM		mp_SharedFiles sf

JOIN		mp_Modules m
ON		sf.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID
		AND pm.PublishBeginDate < GetDate()
		AND (pm.PublishEndDate IS NULL OR pm.PublishEndDate > GetDate())
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectByPage]    Script Date: 05/11/2007 10:57:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectByPage]

/*
Author:				Joe Audette
Created:			12/26/2004
Last Modified:		8/27/2006

*/

@PageID		int


AS
SELECT  		m.ModuleID,
				m.SiteID,
				pm.PageID,
				m.ModuleDefID,
				pm.ModuleOrder,
				pm.PaneName,
				m.ModuleTitle,
				m.AuthorizedEditRoles,
				m.CacheTime,
				m.ShowTitle,
				m.EditUserID,
				m.AvailableForMyPage,
				m.CreatedByUserID,
				m.CreatedDate,
				pm.PublishBeginDate,
				pm.PublishEndDate,
				md.ControlSrc,
				md.FeatureName
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

INNER JOIN		mp_PageModules pm
ON				m.ModuleID = pm.ModuleID
    
WHERE   
    			pm.PageID = @PageID
				AND pm.PublishBeginDate < GetDate()
				AND	(
					(pm.PublishEndDate IS NULL)
					OR
					(pm.PublishEndDate > GetDate())
					)
		
    
ORDER BY
    			pm.ModuleOrder
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_DeleteInstance]    Script Date: 05/11/2007 10:57:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_DeleteInstance]

/*
Author:   			Joe Audette
Created: 			5/18/2006
Last Modified: 		5/18/2006


*/

@ModuleID int,
@PageID		int

AS
DELETE FROM [dbo].[mp_PageModules]
WHERE ModuleID = @ModuleID AND PageID = @PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_PageModules_Insert]    Script Date: 05/11/2007 10:57:54 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
Create PROCEDURE [dbo].[mp_PageModules_Insert]

/*
Author:   			Joe Audette
Created: 			5/18/2006
Last Modified: 		5/18/2006

*/

@ModuleID			int,
@PageID				int,
@PaneName			nvarchar(50),
@ModuleOrder		int,
@PublishBeginDate	datetime,
@PublishEndDate		datetime

	
AS
INSERT INTO 	[dbo].[mp_PageModules] 
(
				ModuleID,
				PageID,
				PaneName,
				ModuleOrder,
				PublishBeginDate,
				PublishEndDate
				
) 

VALUES 
(
				@ModuleID,
				@PageID,
				@PaneName,
				@ModuleOrder,
				@PublishBeginDate,
				@PublishEndDate
				
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_Delete]    Script Date: 05/11/2007 10:57:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_Delete]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 		6/28/2006


*/

@ModuleID int

AS

DELETE FROM [dbo].[mp_PageModules]
WHERE ModuleID = @ModuleID

DELETE FROM [dbo].[mp_Modules]
WHERE ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectByPage]    Script Date: 05/11/2007 10:57:18 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_SelectByPage]

/*
Author:			Joe Audettte
Created:		7/4/2005
Last Modified:		7/4/2005

*/


@SiteID		int,
@PageID		int

AS
SELECT  	gi.*,
		
		m.ModuleTitle,
		md.FeatureName

FROM		mp_GalleryImages gi

JOIN		mp_Modules m
ON		gi.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID
		AND pm.PublishBeginDate < GetDate()
		AND (pm.PublishEndDate IS NULL OR pm.PublishEndDate > GetDate())
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_GetAuthRoles]    Script Date: 05/11/2007 10:57:56 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_GetAuthRoles]
(
    @SiteID    int,
    @ModuleID    int,
    @AccessRoles nvarchar (256) OUTPUT,
    @EditRoles   nvarchar (256) OUTPUT
)
AS
SELECT  
    @AccessRoles = p.AuthorizedRoles,
    @EditRoles   = m.AuthorizedEditRoles
    
FROM    
    mp_Modules m
INNER JOIN mp_PageModules pm
ON	pm.ModuleID = m.ModuleID
  INNER JOIN
    mp_Pages p
ON pm.PageID = p.PageID
    
WHERE   
    m.ModuleID = @ModuleID
  AND
    p.SiteID = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_PageModules_Update]    Script Date: 05/11/2007 10:57:54 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_PageModules_Update]

/*
Author:   			Joe Audette
Created: 			5/18/2006
Last Modified: 		5/18/2006

*/

@ModuleID			int,
@PageID				int,
@PaneName			nvarchar(50),
@ModuleOrder		int,
@PublishBeginDate	datetime,
@PublishEndDate		datetime

	
AS
UPDATE 	[dbo].[mp_PageModules] 
SET
				PaneName = @PaneName,
				ModuleOrder = @ModuleOrder,
				PublishBeginDate = @PublishBeginDate,
				PublishEndDate = @PublishEndDate

WHERE			ModuleID = @ModuleID
				AND PageID = @PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_UpdateModuleOrder]    Script Date: 05/11/2007 10:57:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_UpdateModuleOrder]
(
	@PageID				int,
    @ModuleID           int,
    @ModuleOrder        int,
    @PaneName           nvarchar(50)
)
AS
UPDATE
    mp_PageModules

SET
    ModuleOrder = @ModuleOrder,
    PaneName    = @PaneName

WHERE
    ModuleID = @ModuleID
	AND PageID = @PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_Insert]    Script Date: 05/11/2007 10:58:16 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaScriptHistory_Insert]

/*
Author:   			Joe Audette
Created: 			1/30/2007
Last Modified: 		1/30/2007
*/

@ApplicationID uniqueidentifier,
@ScriptFile nvarchar(255),
@RunTime datetime,
@ErrorOccurred bit,
@ErrorMessage ntext,
@ScriptBody ntext

	
AS

INSERT INTO 	[dbo].[mp_SchemaScriptHistory] 
(
				[ApplicationID],
				[ScriptFile],
				[RunTime],
				[ErrorOccurred],
				[ErrorMessage],
				[ScriptBody]
) 

VALUES 
(
				@ApplicationID,
				@ScriptFile,
				@RunTime,
				@ErrorOccurred,
				@ErrorMessage,
				@ScriptBody
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_SelectErrorsByApp]    Script Date: 05/11/2007 10:58:17 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaScriptHistory_SelectErrorsByApp]

/*
Author:   			Joe Audette
Created: 			1/30/2007
Last Modified: 		1/30/2007
*/

@ApplicationID uniqueidentifier

AS


SELECT
		[ID],
		[ApplicationID],
		[ScriptFile],
		[RunTime],
		[ErrorOccurred],
		[ErrorMessage],
		[ScriptBody]
		
FROM
		[dbo].[mp_SchemaScriptHistory]

WHERE 
		[ApplicationID] = @ApplicationID
		AND [ErrorOccurred] = 1

ORDER BY [ID]
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_Exists]    Script Date: 05/11/2007 10:58:15 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SchemaScriptHistory_Exists]

/*
Author:			Joe Audette
Created:		1/30/2007
Last Modified:	1/30/2007

*/
    
@ApplicationID uniqueidentifier,
@ScriptFile		nvarchar(255)

AS
IF EXISTS (	SELECT 	[ID]
		FROM		mp_SchemaScriptHistory
		WHERE	[ApplicationID] = @ApplicationID
				AND [ScriptFile] = @ScriptFile )
SELECT 1
ELSE
SELECT 0
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_Delete]    Script Date: 05/11/2007 10:58:14 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaScriptHistory_Delete]

/*
Author:   			Joe Audette
Created: 			1/30/2007
Last Modified: 		1/30/2007
*/

@ID int

AS

DELETE FROM [dbo].[mp_SchemaScriptHistory]
WHERE
	[ID] = @ID
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_SelectOne]    Script Date: 05/11/2007 10:58:17 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SchemaScriptHistory_SelectOne]

/*
Author:   			Joe Audette
Created: 			1/30/2007
Last Modified: 		1/30/2007
*/

@ID int

AS


SELECT
		[ID],
		[ApplicationID],
		[ScriptFile],
		[RunTime],
		[ErrorOccurred],
		[ErrorMessage],
		[ScriptBody]
		
FROM
		[dbo].[mp_SchemaScriptHistory]
		
WHERE
		[ID] = @ID
GO
/****** Object:  StoredProcedure [dbo].[mp_SchemaScriptHistory_SelectByApp]    Script Date: 05/11/2007 10:58:16 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SchemaScriptHistory_SelectByApp]

/*
Author:   			Joe Audette
Created: 			1/30/2007
Last Modified: 		1/30/2007
*/

@ApplicationID uniqueidentifier

AS


SELECT
		[ID],
		[ApplicationID],
		[ScriptFile],
		[RunTime],
		[ErrorOccurred],
		[ErrorMessage],
		[ScriptBody]
		
FROM
		[dbo].[mp_SchemaScriptHistory]

WHERE 
		[ApplicationID] = @ApplicationID
		AND [ErrorOccurred] = 0

ORDER BY [ID]
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_UpdateCountOfUseOnMyPage]    Script Date: 05/11/2007 10:57:47 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_UpdateCountOfUseOnMyPage]

/*
Author:   			Joe Audette
Created: 			6/15/2006
Last Modified: 		6/15/2006

*/
	
@ModuleID int, 
@Increment	int


AS
UPDATE 		[dbo].[mp_Modules] 

SET
			
			CountOfUseOnMyPage = CountOfUseOnMyPage + @Increment
			
WHERE
			[ModuleID] = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectOne]    Script Date: 05/11/2007 10:57:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectOne]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 			12/26/2004

*/

@ModuleID int

AS


SELECT	*
		
FROM
		[dbo].[mp_Modules]
		
WHERE
		[ModuleID] = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_Update]    Script Date: 05/11/2007 10:57:45 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Modules_Update]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 			6/19/2005

*/
	
@ModuleID int, 
@ModuleDefID int, 
@ModuleTitle nvarchar(255), 
@AuthorizedEditRoles ntext, 
@CacheTime int, 
@ShowTitle bit ,
@EditUserID	int,
@AvailableForMyPage	bit,
@AllowMultipleInstancesOnMyPage	bit,
@Icon	nvarchar(255)


AS
UPDATE 		[dbo].[mp_Modules] 

SET
			
			[ModuleDefID] = @ModuleDefID,
			
			[ModuleTitle] = @ModuleTitle,
			[AuthorizedEditRoles] = @AuthorizedEditRoles,
			[CacheTime] = @CacheTime,
			[ShowTitle] = @ShowTitle,
			EditUserID = @EditUserID,
			AvailableForMyPage = @AvailableForMyPage,
			AllowMultipleInstancesOnMyPage = @AllowMultipleInstancesOnMyPage,
			Icon = @Icon
			
WHERE
			[ModuleID] = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Modules_SelectForMyPage]    Script Date: 05/11/2007 10:57:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Modules_SelectForMyPage]

/*
Author:				Joe Audette
Created:			5/21/2006
Last Modified:		6/4/2006

*/

@SiteID		int


AS
SELECT  		m.ModuleID,
				m.SiteID,
				m.ModuleDefID,
				m.ModuleTitle,
				m.AllowMultipleInstancesOnMyPage,
				m.Icon As ModuleIcon,
				md.Icon As FeatureIcon,
				md.FeatureName
				
				
				
				
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID


WHERE   
    			m.SiteID = @SiteID
				AND m.AvailableForMyPage = 1
		
    
ORDER BY
    			m.ModuleTitle
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Delete]    Script Date: 05/11/2007 10:57:15 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_Delete]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 		12/4/2004
*/

@ItemID int

AS

DELETE FROM [dbo].[mp_GalleryImages]
WHERE
	[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_SelectOne]    Script Date: 05/11/2007 10:57:18 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_SelectOne]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 		12/4/2004
*/

@ItemID int

AS


SELECT
		[ItemID],
		[ModuleID],
		[DisplayOrder],
		[Caption],
		[Description],
		[MetaDataXml],
		[ImageFile],
		[WebImageFile],
		[ThumbnailFile],
		[UploadDate],
		[UploadUser]
		
FROM
		[dbo].[mp_GalleryImages]
		
WHERE
		[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Select]    Script Date: 05/11/2007 10:57:17 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_Select]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 			12/4/2004

*/

@ModuleID		int

AS


SELECT
		[ItemID],
		[ModuleID],
		[DisplayOrder],
		[Caption],
		[Description],
		[MetaDataXml],
		[ImageFile],
		[WebImageFile],
		[ThumbnailFile],
		[UploadDate],
		[UploadUser]
		
FROM
		[dbo].[mp_GalleryImages]

WHERE	ModuleID = @ModuleID
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Insert]    Script Date: 05/11/2007 10:57:16 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_Insert]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 			12/4/2004


*/

@ModuleID int,
@DisplayOrder int,
@Caption nvarchar(255),
@Description ntext,
@MetaDataXml ntext,
@ImageFile nvarchar(100),
@WebImageFile nvarchar(100),
@ThumbnailFile nvarchar(100),
@UploadDate datetime,
@UploadUser nvarchar(100)

	
AS

INSERT INTO 	[dbo].[mp_GalleryImages] 
(
				[ModuleID],
				[DisplayOrder],
				[Caption],
				[Description],
				[MetaDataXml],
				[ImageFile],
				[WebImageFile],
				[ThumbnailFile],
				[UploadDate],
				[UploadUser]
) 

VALUES 
(
				@ModuleID,
				@DisplayOrder,
				@Caption,
				@Description,
				@MetaDataXml,
				@ImageFile,
				@WebImageFile,
				@ThumbnailFile,
				@UploadDate,
				@UploadUser
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_GalleryImages_Update]    Script Date: 05/11/2007 10:57:21 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_GalleryImages_Update]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 			12/4/2004

*/
	
@ItemID int, 
@ModuleID int, 
@DisplayOrder int, 
@Caption nvarchar(255), 
@Description ntext, 
@MetaDataXml ntext, 
@ImageFile nvarchar(100), 
@WebImageFile nvarchar(100), 
@ThumbnailFile nvarchar(100), 
@UploadDate datetime, 
@UploadUser nvarchar(100) 


AS

UPDATE 		[dbo].[mp_GalleryImages] 

SET
			[ModuleID] = @ModuleID,
			[DisplayOrder] = @DisplayOrder,
			[Caption] = @Caption,
			[Description] = @Description,
			[MetaDataXml] = @MetaDataXml,
			[ImageFile] = @ImageFile,
			[WebImageFile] = @WebImageFile,
			[ThumbnailFile] = @ThumbnailFile,
			[UploadDate] = @UploadDate,
			[UploadUser] = @UploadUser
			
WHERE
			[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_DeleteByID]    Script Date: 05/11/2007 10:57:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_DeleteByID]

    
@ID int

AS
DELETE FROM
    mp_ModuleDefinitionSettings

WHERE
    ID = @ID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_UpdateByID]    Script Date: 05/11/2007 10:57:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_UpdateByID]

@ID						int,
@ModuleDefID      		int,
@SettingName   		nvarchar(50),
@SettingValue  			nvarchar(255),
@ControlType   			nvarchar(50),
@RegexValidationExpression 	ntext



AS

UPDATE
    mp_ModuleDefinitionSettings

SET
	SettingName = @SettingName,
    SettingValue = @SettingValue,
	ControlType = @ControlType,
	RegexValidationExpression = @RegexValidationExpression

WHERE
    ID = @ID AND ModuleDefID = @ModuleDefID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_Select]    Script Date: 05/11/2007 10:57:37 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_Select]
(
    @ModuleDefID int
)
AS

SELECT
    *

FROM
    mp_ModuleDefinitionSettings

WHERE
    ModuleDefID = @ModuleDefID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitionSettings_Update]    Script Date: 05/11/2007 10:57:38 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitionSettings_Update]

    
@ModuleDefID      		int,
@SettingName   		nvarchar(50),
@SettingValue  			nvarchar(255),
@ControlType   			nvarchar(50),
@RegexValidationExpression 	ntext



AS

IF NOT EXISTS (
    SELECT 
        * 
    FROM 
        mp_ModuleDefinitionSettings 
    WHERE 
        ModuleDefID = @ModuleDefID
      AND
        SettingName = @SettingName
)
INSERT INTO mp_ModuleDefinitionSettings (
    ModuleDefID,
    SettingName,
    SettingValue,
	ControlType,
	RegexValidationExpression
) 
VALUES (
    @ModuleDefID,
    @SettingName,
    @SettingValue,
	@ControlType,
	@RegexValidationExpression
)
ELSE
UPDATE
    mp_ModuleDefinitionSettings

SET
    SettingValue = @SettingValue,
	ControlType = @ControlType,
	RegexValidationExpression = @RegexValidationExpression

WHERE
    ModuleDefID = @ModuleDefID
  AND
    SettingName = @SettingName
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Delete]    Script Date: 05/11/2007 10:57:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Delete]

    
@ModuleDefID int

AS

DELETE FROM
    mp_ModuleDefinitions

WHERE
    ModuleDefID = @ModuleDefID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_SelectUserModules]    Script Date: 05/11/2007 10:57:34 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_SelectUserModules]

    
@SiteID  int


AS

SELECT   		md.*

FROM			mp_ModuleDefinitions md

JOIN			mp_SiteModuleDefinitions smd
ON			smd.ModuleDefID = md.ModuleDefID
    
WHERE   		smd.SiteID = @SiteID
			AND md.IsAdmin = 0

ORDER BY 		md.SortOrder, md.FeatureName
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_SelectOne]    Script Date: 05/11/2007 10:57:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_SelectOne]

    
@ModuleDefID int

AS

SELECT	*

FROM
    mp_ModuleDefinitions

WHERE
    ModuleDefID = @ModuleDefID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Update]    Script Date: 05/11/2007 10:57:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Update]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 		1/21/2007

*/
	
@ModuleDefID int, 
@FeatureName nvarchar(255), 
@ControlSrc nvarchar(255), 
@SortOrder int, 
@IsAdmin bit,
@Icon	nvarchar(255),
@DefaultCacheTime int


AS
UPDATE 		[dbo].[mp_ModuleDefinitions] 

SET

			[FeatureName] = @FeatureName,
			[ControlSrc] = @ControlSrc,
			[SortOrder] = @SortOrder,
			DefaultCacheTime = @DefaultCacheTime,
			Icon = @Icon,
			[IsAdmin] = @IsAdmin
			
WHERE
			[ModuleDefID] = @ModuleDefID
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Select]    Script Date: 05/11/2007 10:57:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Select]

    
@SiteID  int


AS

SELECT   	md.*

FROM		mp_ModuleDefinitions md

JOIN		mp_SiteModuleDefinitions smd
ON		smd.ModuleDefID = md.ModuleDefID
    
WHERE   	smd.SiteID = @SiteID

ORDER BY 	md.SortOrder, md.FeatureName
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePaths_CreatePath]    Script Date: 05/11/2007 10:58:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SitePaths_CreatePath]

@SiteID	int,
@Path           nvarchar(255),
@PathId         UNIQUEIDENTIFIER OUTPUT

AS

BEGIN
    BEGIN TRANSACTION
    IF (NOT EXISTS(SELECT * FROM mp_SitePaths WHERE LoweredPath = LOWER(@Path) AND SiteID = @SiteID))
    BEGIN
        INSERT mp_SitePaths (SiteID, Path, LoweredPath) VALUES (@SiteID, @Path, LOWER(@Path))
    END
    COMMIT TRANSACTION
    SELECT @PathId = PathID FROM mp_SitePaths WHERE LOWER(@Path) = LoweredPath AND SiteID = @SiteID
END
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAllUsers_GetPageSettings]    Script Date: 05/11/2007 10:58:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SitePersonalizationAllUsers_GetPageSettings] 
(
    
@SiteID	int,
@Path              nvarchar(255)

)

AS

BEGIN
    
    DECLARE @PathId UNIQUEIDENTIFIER

    SELECT @PathId = NULL

   
    SELECT @PathId = u.PathId FROM mp_SitePaths u WHERE u.SiteID = @SiteID AND u.LoweredPath = LOWER(@Path)
    IF (@PathId IS NULL)
    BEGIN
        RETURN
    END

    SELECT p.PageSettings FROM mp_SitePersonalizationAllUsers p WHERE p.PathId = @PathId
END
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_DecrementPostCount]    Script Date: 05/11/2007 10:56:47 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_DecrementPostCount]

/*
Author:				Joe Audette
Created:			11/6/2004
Last Modified:			11/6/2004

*/

@ForumID		int

AS


UPDATE mp_Forums

SET PostCount = PostCount - 1

WHERE ItemID = @ForumID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectOne]    Script Date: 05/11/2007 10:57:03 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_SelectOne]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		2/16/2005

*/

@ThreadID		int


AS

SELECT		t.*,
			'MostRecentPostUser' = COALESCE(u.[Name], 'Guest'),
			'StartedBy' = COALESCE(s.[Name], 'Guest'),
			f.PostsPerPage


FROM			mp_ForumThreads t

LEFT OUTER JOIN	mp_Users u
ON			t.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN	mp_Users s
ON			t.StartedByUserID = s.UserID

JOIN			mp_Forums f
ON			f.ItemID = t.ForumID

WHERE		t.ThreadID = @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_IncrementPostCount]    Script Date: 05/11/2007 10:56:50 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_IncrementPostCount]

/*
Author:				Joe Audette
Created:			11/6/2004
Last Modified:			1/14/2007

*/

@ForumID			int,
@MostRecentPostUserID	int,
@MostRecentPostDate datetime

AS
UPDATE 	mp_Forums

SET 		MostRecentPostDate = @MostRecentPostDate,
		MostRecentPostUserID = @MostRecentPostUserID,
 		PostCount = PostCount + 1

WHERE 	ItemID = @ForumID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Update]    Script Date: 05/11/2007 10:56:55 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Forums_Update]

/*
Author:			Joe Audette
Created:		9/12/2004
Last Modified:		10/20/2004

*/

@ItemID			int,
@Title          			nvarchar(100),
@Description    			ntext,
@IsModerated			bit,
@IsActive			bit,
@SortOrder			int,
@PostsPerPage			int,
@ThreadsPerPage		int,
@AllowAnonymousPosts		bit



AS


UPDATE		mp_Forums

SET			Title = @Title,
			[Description] = @Description,
			IsModerated = @IsModerated,
			IsActive = @IsActive,
			SortOrder = @SortOrder,
			PostsPerPage = @PostsPerPage,
			ThreadsPerPage = @ThreadsPerPage,
			AllowAnonymousPosts = @AllowAnonymousPosts



WHERE		ItemID = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByForumDesc_v2]    Script Date: 05/11/2007 10:57:02 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_SelectByForumDesc_v2]

/*
Author:			Joe Audette
Created:		9/14/2004
Last Modified:		9/25/2004

*/


@ForumID			int,
@PageNumber			int

AS

DECLARE @ThreadsPerPage	int
DECLARE @TotalThreads	int
DECLARE @BeginSequence int
DECLARE @EndSequence int

SELECT	@ThreadsPerPage = ThreadsPerPage,
		@TotalThreads = ThreadCount
FROM		mp_Forums
WHERE	ItemID = @ForumID


SET @BeginSequence = @TotalThreads - (@ThreadsPerPage * @PageNumber) + 1
SET @EndSequence = @BeginSequence + @ThreadsPerPage  -1

CREATE TABLE #PageIndex 
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	ThreadID int
	
)

INSERT INTO #PageIndex (ThreadID)


SELECT	t.ThreadID
FROM		mp_ForumThreads t
WHERE	t.ForumID = @ForumID	
ORDER BY	t.MostRecentPostDate 


SELECT	t.*,
		'MostRecentPostUser' = u.[Name],
		'StartedBy' = s.[Name]


FROM		mp_ForumThreads t

JOIN		#PageIndex p
ON		p.ThreadID = t.ThreadID

LEFT OUTER JOIN		mp_Users u
ON		t.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		mp_Users s
ON		t.StartedByUserID = s.UserID

WHERE	t.ForumID = @ForumID
		AND p.IndexID
Between @BeginSequence 
AND @EndSequence

ORDER BY	p.IndexID DESC

DROP TABLE #PageIndex
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_Insert]    Script Date: 05/11/2007 10:56:52 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Forums_Insert]

/*
Author:				Joe Audette
Created:			9/12/2004
Last Modified:			10/20/2004

*/

@ModuleID			int,
@UserID			int,
@Title          			nvarchar(100),
@Description    			ntext,
@IsModerated			bit,
@IsActive			bit,
@SortOrder			int,
@PostsPerPage			int,
@ThreadsPerPage		int,
@AllowAnonymousPosts		bit



AS

INSERT INTO			mp_Forums
(
				ModuleID,
				CreatedBy,
				Title,
				[Description],
				IsModerated,
				IsActive,
				SortOrder,
				PostsPerPage,
				ThreadsPerPage,
				AllowAnonymousPosts

)

VALUES
(
				@ModuleID,
				@UserID,
				@Title,
				@Description,
				@IsModerated,
				@IsActive,
				@SortOrder,
				@PostsPerPage,
				@ThreadsPerPage,
				@AllowAnonymousPosts

)

SELECT @@IDENTITY As ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByForum]    Script Date: 05/11/2007 10:57:01 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_SelectByForum]

/*
Author:			Joe Audette
Created:		9/14/2004
Last Modified:		2/16/2005

*/


@ForumID			int,
@PageNumber			int

AS

DECLARE @ThreadsPerPage	int
DECLARE @CurrentPageMaxForumSequence	int
DECLARE @BeginSequence int
DECLARE @EndSequence int

SELECT	@ThreadsPerPage = ThreadsPerPage
		
FROM		mp_Forums

WHERE	ItemID = @ForumID

SET @CurrentPageMaxForumSequence = (@ThreadsPerPage * @PageNumber)

IF @CurrentPageMaxForumSequence > @ThreadsPerPage + 1
	BEGIN
		SET @BeginSequence = @CurrentPageMaxForumSequence  
- @ThreadsPerPage + 1
	END
ELSE
	BEGIN
		SET @BeginSequence = 1
	END

SET @EndSequence = @BeginSequence + @ThreadsPerPage  -1

SELECT	t.*,
		'MostRecentPostUser' = COALESCE(u.[Name], 'Guest'),
		'StartedBy' = s.[Name]


FROM		mp_ForumThreads t

LEFT OUTER JOIN		mp_Users u
ON		t.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		mp_Users s
ON		t.StartedByUserID = s.UserID

WHERE	t.ForumID = @ForumID
		AND t.ForumSequence 
Between @BeginSequence 
AND @EndSequence

ORDER BY	t.SortOrder, t.ThreadID DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_SelectByForumDesc]    Script Date: 05/11/2007 10:57:01 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_SelectByForumDesc]

/*
Author:			Joe Audette
Created:		9/14/2004
Last Modified:		9/25/2004

*/


@ForumID			int,
@PageNumber			int

AS

DECLARE @ThreadsPerPage	int
DECLARE @TotalThreads	int
DECLARE @BeginSequence int
DECLARE @EndSequence int

SELECT	@ThreadsPerPage = ThreadsPerPage,
		@TotalThreads = ThreadCount
FROM		mp_Forums
WHERE	ItemID = @ForumID


SET @BeginSequence = @TotalThreads - (@ThreadsPerPage * @PageNumber) + 1
SET @EndSequence = @BeginSequence + @ThreadsPerPage  -1

SELECT	t.*,
		'MostRecentPostUser' = u.[Name],
		'StartedBy' = s.[Name]


FROM		mp_ForumThreads t

LEFT OUTER JOIN		mp_Users u
ON		t.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		mp_Users s
ON		t.StartedByUserID = s.UserID

WHERE	t.ForumID = @ForumID
		AND t.ForumSequence 
Between @BeginSequence 
AND @EndSequence

ORDER BY	t.SortOrder, t.ThreadID DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_IncrementThreadCount]    Script Date: 05/11/2007 10:56:51 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_IncrementThreadCount]

/*
Author:			Joe Audette
Created:		11/28/2004
Last Modified:		11/28/2004

*/

@ForumID			int

AS

UPDATE		mp_Forums

SET			ThreadCount = ThreadCount + 1

WHERE		ItemID = @ForumID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_SelectOne]    Script Date: 05/11/2007 10:56:54 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Forums_SelectOne]

/*
Author:				Joe Audette
Created:			9/12/2004
Last Modified:			9/12/2004

*/

@ItemID			int

AS

SELECT		f.*,
			'CreatedByUser' = u.[Name],
			'MostRecentPostUser' = up.[Name]

FROM			mp_Forums f

LEFT OUTER JOIN	mp_Users u
ON			f.CreatedBy = u.UserID

LEFT OUTER JOIN	mp_Users up
ON			f.MostRecentPostUserID = up.UserID

WHERE		f.ItemID = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_UpdateThreadStats]    Script Date: 05/11/2007 10:56:56 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_UpdateThreadStats]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		9/19/2004

*/

@ForumID			int

AS

UPDATE		mp_Forums

SET			ThreadCount = ThreadCount + 1

WHERE		ItemID = @ForumID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_DecrementThreadCount]    Script Date: 05/11/2007 10:56:48 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_DecrementThreadCount]

/*
Author:			Joe Audette
Created:		11/28/2004
Last Modified:		11/28/2004

*/

@ForumID			int

AS

UPDATE		mp_Forums

SET			ThreadCount = ThreadCount - 1

WHERE		ItemID = @ForumID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_UpdatePostStats]    Script Date: 05/11/2007 10:56:55 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_UpdatePostStats]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		9/19/2004

*/

@ForumID			int,
@MostRecentPostUserID	int

AS

UPDATE	mp_Forums

SET		MostRecentPostDate = GetDate(),
		MostRecentPostUserID = @MostRecentPostUserID,
		PostCount = PostCount + 1

WHERE	ItemID = @ForumID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_IncrementPostCountOnly]    Script Date: 05/11/2007 10:56:51 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_IncrementPostCountOnly]

/*
Author:				Joe Audette
Created:			9/10/2005
Last Modified:			9/10/2005

*/

@ForumID			int


AS


UPDATE 	mp_Forums

SET 		
 		PostCount = PostCount + 1

WHERE 	ItemID = @ForumID
GO
/****** Object:  StoredProcedure [dbo].[mp_Forums_RecalculatePostStats]    Script Date: 05/11/2007 10:56:53 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Forums_RecalculatePostStats]

/*
Author:			Joe Audette
Created:		9/11/2005
Last Modified:		9/11/2005

based ont he pgsql version by Dean Brettle

*/

@ForumID		int


AS

DECLARE @RowsAffected		int
DECLARE @MostRecentPostDate	datetime
DECLARE @MostRecentPostUserID	int
DECLARE @PostCount			int

SET @RowsAffected = 0

SELECT TOP 1	@MostRecentPostDate = MostRecentPostDate,
		@MostRecentPostUserID = MostRecentPostUserID

FROM		mp_ForumThreads

WHERE	ForumID = @ForumID

ORDER BY	MostRecentPostDate DESC

SET @PostCount = COALESCE(
				(	SELECT 	SUM(TotalReplies) + COUNT(*)
					FROM		mp_ForumThreads
					WHERE	ForumID = @ForumID

				),
				0
				)

UPDATE 	mp_Forums
SET		MostRecentPostDate = @MostRecentPostDate,
		MostRecentPostUserID = @MostRecentPostUserID,
		PostCount = @PostCount

WHERE	ItemID = @ForumID

SET @RowsAffected = @@ROWCOUNT


SELECT @RowsAffected
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_RoleExists]    Script Date: 05/11/2007 10:58:08 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Roles_RoleExists]

/*
Author:			Joe Audette
Created:		5/19/2005
Last Modified:		5/19/2005

*/
    
@SiteID  	int,
@RoleName	nvarchar(50)

AS

IF EXISTS (	SELECT 	RoleID
		FROM		mp_Roles
		WHERE	SiteID = @SiteID
				AND (RoleName = @RoleName OR DisplayName = @RoleName))
SELECT 1
ELSE
SELECT 0
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Insert]    Script Date: 05/11/2007 10:58:07 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Roles_Insert]

/*
Author:			Joe Audette
Created:		7/19/2004
Last Modified:		5/19/2005

*/


@SiteID    		int,
@RoleName    nvarchar(50)

AS

INSERT INTO mp_Roles
(
    		SiteID,
    		RoleName,
    		DisplayName
)

VALUES
(
    	@SiteID,
    	@RoleName,
	@RoleName
)

SELECT  @@Identity As RoleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Select]    Script Date: 05/11/2007 10:58:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Roles_Select]

/*
Last Modified:		5/19/2005 Joe Audette

*/
    
@SiteID  int

AS

SELECT  *

FROM		mp_Roles

WHERE   	SiteID = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_SelectOne]    Script Date: 05/11/2007 10:58:10 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Roles_SelectOne]
(
    @RoleID int
)
AS

SELECT
    *

FROM
    mp_Roles

WHERE
    RoleID = @RoleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_SelectOneByName]    Script Date: 05/11/2007 10:58:11 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Roles_SelectOneByName]

/*
Auhor:			Joe Audette
Created:		5/21/2005
Last Modified:		5/21/2005

*/



@SiteID	int,
@RoleName	nvarchar(50)



AS


SELECT *

FROM		mp_Roles

WHERE	SiteID = @SiteID
		AND RoleName = @RoleName
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Update]    Script Date: 05/11/2007 10:58:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Roles_Update]

/*
Last Modified:		5/19/2005 Joe Audette

*/

    
@RoleID      int,
@RoleName    nvarchar(50)

AS

UPDATE		mp_Roles

SET
    			DisplayName = @RoleName

WHERE
    			RoleID = @RoleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Roles_Delete]    Script Date: 05/11/2007 10:58:07 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Roles_Delete]

/*
Last Modified:		5/21/2005
don't allow delete of admins role

*/
    
@RoleID int

AS

DELETE FROM	mp_Roles

WHERE	RoleID = @RoleID AND RoleName  <> 'Admins' AND RoleName <> 'Content Administrators' AND RoleName <> 'Authenticated Users'
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_GetUserRoles]    Script Date: 05/11/2007 10:59:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Users_GetUserRoles]



@SiteID	int,
@UserID       	int

AS

SELECT  
    		mp_Roles.RoleName,
    		mp_Roles.RoleID

FROM		 mp_UserRoles
  
INNER JOIN 	mp_Users 
ON 		mp_UserRoles.UserID = mp_Users.UserID

INNER JOIN 	mp_Roles 
ON 		mp_UserRoles.RoleID = mp_Roles.RoleID


WHERE   	mp_Users.SiteID = @SiteID
		AND mp_UserRoles.UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectOne]    Script Date: 05/11/2007 10:58:02 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectOne]

/*
Author:				Joe Audette
Created:			11/7/2004
Last Modified:		8/27/2006

*/

@SiteID		int,
@PageID		int


AS
SELECT TOP 1	*

FROM		mp_Pages

WHERE	(PageID = @PageID OR @PageID = -1)
		AND SiteID = @SiteID 
ORDER BY ParentID, PageOrder
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_SelectDefaultPage]    Script Date: 05/11/2007 10:58:58 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteSettings_SelectDefaultPage]

/*
Author:				Joe Audette
Created:			7/27/2004
Last Modified:			1/8/2006

*/

@HostName		nvarchar(255)

AS
DECLARE @SiteID int

SET @SiteID = COALESCE(	(SELECT TOP 1 SiteID FROM mp_SiteHosts WHERE HostName = @HostName),
				 (SELECT TOP 1 SiteID FROM mp_Sites ORDER BY SiteID)
			)


 SELECT TOP 1
        			s.SiteID,
         			s.SiteName,
			s.Skin,
			s.Logo,
			s.Icon,
			s.AllowNewRegistration,
			s.AllowUserSkins,
			s.AllowPageSkins,
			s.AllowHideMenuOnPages,
			s.UseSecureRegistration,
			s.UseSSLOnAllPages,
			'MetaKeyWords' = COALESCE(s.DefaultPageKeyWords,  ''),
			'MetaDescription' = COALESCE(s.DefaultPageDescription,  ''),
			'MetaEncoding' = COALESCE(s.DefaultPageEncoding,  ''),
			'MetaAdditional' = COALESCE(s.DefaultAdditionalMetaTags,  ''),
			'PageMetaKeyWords' = COALESCE(p.PageKeyWords, ''),
			'PageMetaDescription' = COALESCE(p.PageDescription, ''),
			'PageMetaEncoding' = COALESCE(p.PageEncoding, ''),
			'PageMetaAdditional' = COALESCE(p.AdditionalMetaTags, ''),
			s.IsServerAdminSite,
			s.UseLdapAuth,
			s.AutoCreateLdapUserOnFirstLogin,
			s.LdapServer,
			s.LdapPort,
			s.LdapDomain,
			s.LdapRootDN,
			s.LdapUserDNKey,
			s.ReallyDeleteUsers,
			s.UseEmailForLogin,
			s.AllowUserFullNameChange,
			s.EditorSkin,
			s.DefaultFriendlyUrlPatternEnum,
			s.EnableMyPageFeature,
        			p.PageID,
			p.ParentID,
         			p.PageOrder,
        			p.PageName,
					p.PageTitle,
					p.MenuImage,
         			p.RequireSSL,
        			p.AuthorizedRoles,
			p.EditRoles,
			p.CreateChildPageRoles,
        			p.ShowBreadcrumbs,
			p.ShowChildPageMenu,
			p.ShowChildBreadCrumbs,
			p.HideMainMenu,
			'PageSkin' = p.Skin


FROM			mp_Pages p
    
INNER JOIN		mp_Sites  s
ON 			p.SiteID = s.SiteID
        
    
WHERE
        			s.SiteID = @SiteID
        
ORDER BY
        			p.ParentID, p.PageOrder
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_Insert]    Script Date: 05/11/2007 10:58:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_Insert]

/*
Author:			Joe Audette
Created:		11/7/2004
Last Modified:		1/8/2007

*/

@SiteID   		int,
@ParentID		int,
@PageName    		nvarchar(50),
@PageOrder   		int,
@AuthorizedRoles 	ntext,
@EditRoles		ntext,
@CreateChildPageRoles ntext,
@RequireSSL		bit,
@ShowBreadcrumbs 	bit,
@ShowChildPageBreadcrumbs 	bit,
@PageKeyWords	nvarchar(255),
@PageDescription	nvarchar(255),
@PageEncoding	nvarchar(255),
@AdditionalMetaTags	nvarchar(255),
@UseUrl		bit,
@Url			nvarchar(255),
@OpenInNewWindow	bit,
@ShowChildPageMenu	bit,
@HideMainMenu	bit,
@Skin			nvarchar(100),
@IncludeInMenu	bit,
@MenuImage			nvarchar(50),
@PageTitle    		nvarchar(255),
@AllowBrowserCache	bit

AS
INSERT INTO 		mp_Pages
(
    			SiteID,
			ParentID,
    			PageName,
				PageTitle,
    			PageOrder,
			AuthorizedRoles,
			EditRoles,
			CreateChildPageRoles,
    			RequireSSL,
			AllowBrowserCache,
    			ShowBreadcrumbs,
			ShowChildBreadCrumbs,
    			PageKeyWords,
			PageDescription,
			PageEncoding,
			AdditionalMetaTags,
			UseUrl,
			Url,
			OpenInNewWindow,
			ShowChildPageMenu,
			HideMainMenu,
			Skin,
			IncludeInMenu,
			MenuImage
)

VALUES
(
    			@SiteID,
			@ParentID,
    			@PageName,
				@PageTitle,
    			@PageOrder,
			@AuthorizedRoles,
			@EditRoles,
			@CreateChildPageRoles,
    			@RequireSSL,
			@AllowBrowserCache,
    			@ShowBreadcrumbs,
			@ShowChildPageBreadcrumbs,
			@PageKeyWords,
			@PageDescription,
			@PageEncoding,
			@AdditionalMetaTags,
			@UseUrl,
			@Url,
			@OpenInNewWindow,
			@ShowChildPageMenu,
			@HideMainMenu,
			@Skin,
			@IncludeInMenu,
			@MenuImage
)

SELECT  @@Identity As PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_SelectDefaultPageByID]    Script Date: 05/11/2007 10:58:58 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SiteSettings_SelectDefaultPageByID]

/*
Author:				Joe Audette
Created:			3/7/2005
Last Modified:			1/8/2006

*/

@SiteID int

AS
SELECT TOP 1
        			s.SiteID,
         			s.SiteName,
			s.Skin,
			s.Logo,
			s.Icon,
			s.AllowNewRegistration,
			s.AllowUserSkins,
			s.AllowPageSkins,
			s.AllowHideMenuOnPages,
			s.UseSecureRegistration,
			s.UseSSLOnAllPages,
			'MetaKeyWords' = COALESCE(s.DefaultPageKeyWords,  ''),
			'MetaDescription' = COALESCE(s.DefaultPageDescription,  ''),
			'MetaEncoding' = COALESCE(s.DefaultPageEncoding,  ''),
			'MetaAdditional' = COALESCE(s.DefaultAdditionalMetaTags,  ''),
			'PageMetaKeyWords' = COALESCE(p.PageKeyWords, ''),
			'PageMetaDescription' = COALESCE(p.PageDescription, ''),
			'PageMetaEncoding' = COALESCE(p.PageEncoding, ''),
			'PageMetaAdditional' = COALESCE(p.AdditionalMetaTags, ''),
			s.IsServerAdminSite,
			s.UseLdapAuth,
			s.AutoCreateLdapUserOnFirstLogin,
			s.LdapServer,
			s.LdapPort,
			s.LdapDomain,
			s.LdapRootDN,
			s.LdapUserDNKey,
			s.ReallyDeleteUsers,
			s.UseEmailForLogin,
			s.AllowUserFullNameChange,
			s.EditorSkin,
			s.DefaultFriendlyUrlPatternEnum,
			s.EnableMyPageFeature,
        			p.PageID,
			p.ParentID,
         			p.PageOrder,
        			p.PageName,
					p.PageTitle,
			p.MenuImage,
         			p.RequireSSL,
        			p.AuthorizedRoles,
			p.EditRoles,
			p.CreateChildPageRoles,
        			p.ShowBreadcrumbs,
			p.ShowChildPageMenu,
			p.ShowChildBreadCrumbs,
			p.HideMainMenu,
			'PageSkin' = p.Skin


FROM			mp_Pages p
    
INNER JOIN		mp_Sites  s
ON 			p.SiteID = s.SiteID
        
    
WHERE
        			s.SiteID = @SiteID
        
ORDER BY
        			p.ParentID, p.PageOrder
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_SelectPage]    Script Date: 05/11/2007 10:58:59 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteSettings_SelectPage]

/*
Author:				Joe Audette
Created:			7/27/2004
Last Modified:			1/8/2006

*/

@PageID		int,
@HostName		nvarchar(255)

AS
DECLARE @SiteID int

SET @SiteID = COALESCE(	(SELECT TOP 1 SiteID FROM mp_SiteHosts WHERE HostName = @HostName),
				 (SELECT TOP 1 SiteID FROM mp_Sites ORDER BY SiteID)
			)


 SELECT TOP 1
        			s.SiteID,
         			s.SiteName,
			s.Skin,
			s.Logo,
			s.Icon,
			s.AllowNewRegistration,
			s.AllowUserSkins,
			s.AllowPageSkins,
			s.AllowHideMenuOnPages,
			s.UseSecureRegistration,
			s.UseSSLOnAllPages,
			'MetaKeyWords' = COALESCE(s.DefaultPageKeyWords,  ''),
			'MetaDescription' = COALESCE(s.DefaultPageDescription,  ''),
			'MetaEncoding' = COALESCE(s.DefaultPageEncoding,  ''),
			'MetaAdditional' = COALESCE(s.DefaultAdditionalMetaTags,  ''),
			'PageMetaKeyWords' = COALESCE(p.PageKeyWords, ''),
			'PageMetaDescription' = COALESCE(p.PageDescription, ''),
			'PageMetaEncoding' = COALESCE(p.PageEncoding, ''),
			'PageMetaAdditional' = COALESCE(p.AdditionalMetaTags, ''),
			s.IsServerAdminSite,
			s.UseLdapAuth,
			s.AutoCreateLdapUserOnFirstLogin,
			s.LdapServer,
			s.LdapPort,
			s.LdapDomain,
			s.LdapRootDN,
			s.LdapUserDNKey,
			s.ReallyDeleteUsers,
			s.UseEmailForLogin,
			s.AllowUserFullNameChange,
			s.EditorSkin,
			s.DefaultFriendlyUrlPatternEnum,
			s.EnableMyPageFeature,
        			p.PageID,
			p.ParentID,
         			p.PageOrder,
        			p.PageName,
			p.PageTitle,
			p.MenuImage,
         			p.RequireSSL,
        			p.AuthorizedRoles,
			p.EditRoles,
			p.CreateChildPageRoles,
        			p.ShowBreadcrumbs,
			p.ShowChildPageMenu,
			p.ShowChildBreadCrumbs,
			p.HideMainMenu,
			'PageSkin' = p.Skin


FROM			mp_Pages p
    
INNER JOIN		mp_Sites  s
ON 			p.SiteID = s.SiteID
        
    
WHERE		s.SiteID = @SiteID
        			AND p.PageID = @PageID
        
ORDER BY
        			p.PageOrder
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteSettings_GetPageList]    Script Date: 05/11/2007 10:58:57 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SiteSettings_GetPageList]

/*
Author:				Joe Audette
Created:			7/27/2004
Last Modified:			3/19/2005

*/

@SiteID			int



AS
SELECT  
    				*
    
FROM    
    				mp_Pages
    
WHERE   
    				SiteID = @SiteID
					AND IncludeInMenu = 1

ORDER BY			ParentID, PageOrder, PageName
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_Update]    Script Date: 05/11/2007 10:58:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_Update]

/*
Author:			Joe Audette
Last Modified:		1/8/2007

*/


@SiteID        		int,
@PageID           	int,
@ParentID		int,
@PageOrder        	int,
@PageName         	nvarchar(50),
@AuthorizedRoles 	ntext,
@EditRoles		ntext,
@CreateChildPageRoles ntext,
@RequireSSL		bit,
@ShowBreadcrumbs	bit,
@ShowChildPageBreadcrumbs bit,
@PageKeyWords	nvarchar(255),
@PageDescription	nvarchar(255),
@PageEncoding	nvarchar(255),
@AdditionalMetaTags	nvarchar(255),
@UseUrl		bit,
@Url			nvarchar(255),
@OpenInNewWindow	bit,
@ShowChildPageMenu	bit,
@HideMainMenu	bit,
@Skin			nvarchar(100),
@IncludeInMenu	bit,
@MenuImage			nvarchar(50),
@PageTitle         	nvarchar(255),
@AllowBrowserCache	bit


AS
IF NOT EXISTS (
    SELECT PageID 
    FROM 
        mp_Pages 
    WHERE 
        PageID = @PageID
)
INSERT INTO mp_Pages
(
	ParentID,
    	SiteID,
    	PageOrder,
   	PageName,
	PageTitle,
   	AuthorizedRoles,
	EditRoles,
	CreateChildPageRoles,
    	RequireSSL,
	AllowBrowserCache,
	ShowBreadcrumbs,
	ShowChildBreadCrumbs,
     	PageKeyWords,
	PageDescription	,
	PageEncoding,
	AdditionalMetaTags,
	UseUrl,
	Url,
	OpenInNewWindow,
	ShowChildPageMenu,
	HideMainMenu,
	Skin,
	IncludeInMenu,
	MenuImage 

) 
VALUES
 (
	@ParentID,
    	@SiteID,
    	@PageOrder,
    	@PageName,
		@PageTitle,
    	@AuthorizedRoles,
	@EditRoles,
	@CreateChildPageRoles,
    	@RequireSSL,
	@AllowBrowserCache,
	@ShowBreadcrumbs,
	@ShowChildPageBreadcrumbs,
	@PageKeyWords,
	@PageDescription,
	@PageEncoding,
	@AdditionalMetaTags,
	@UseUrl,
	@Url,
	@OpenInNewWindow,
	@ShowChildPageMenu,
	@HideMainMenu,
	@Skin,
	@IncludeInMenu,
	@MenuImage
   
)
ELSE
UPDATE
    mp_Pages

SET
	ParentID = @ParentID,
    	PageOrder = @PageOrder,
    	PageName = @PageName,
		PageTitle = @PageTitle,
    	AuthorizedRoles = @AuthorizedRoles,
	EditRoles = @EditRoles,
	CreateChildPageRoles = @CreateChildPageRoles,
    	RequireSSL = @RequireSSL,
	AllowBrowserCache = @AllowBrowserCache,
	ShowBreadcrumbs = @ShowBreadcrumbs,
	ShowChildBreadCrumbs = @ShowChildPageBreadcrumbs,
	PageKeyWords = @PageKeyWords,
	PageDescription = @PageDescription,
	PageEncoding = @PageEncoding,
	AdditionalMetaTags = @AdditionalMetaTags,
	UseUrl = @UseUrl,
	Url = @Url,
	OpenInNewWindow = @OpenInNewWindow,
	ShowChildPageMenu = @ShowChildPageMenu,
	HideMainMenu = @HideMainMenu,
	Skin = @Skin,
	IncludeInMenu = @IncludeInMenu,
	MenuImage = @MenuImage

WHERE
    PageID = @PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_GetNextPageOrder]    Script Date: 05/11/2007 10:57:56 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Pages_GetNextPageOrder]

/*
Author:			Joe Audette
Created:		11/7/2004
Last Modified:	04/29/2007

*/

@SiteID int,
@ParentID		int

AS

SELECT	COALESCE(MAX(PageOrder), -1) + 2

FROM		mp_Pages

WHERE	SiteID = @SiteID
		AND ParentID = @ParentID
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_GetBreadcrumbs]    Script Date: 05/11/2007 10:57:56 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_GetBreadcrumbs]

/*
Author:			Joe Audette
Created:		1/1/2005
Last Modified:		1/1/2005

*/


@PageID		int


AS


SELECT		p.PageID,
			p.PageName,
			p.ParentID As Parent1ID,
			p1.PageName As Parent1Name,
			COALESCE(p1.ParentID,-1) As Parent2ID,
			p2.PageName As Parent2Name,
			COALESCE(p2.ParentID,-1) As Parent3ID,
			p3.PageName As Parent3Name,
			COALESCE(p3.ParentID,-1) As Parent4ID,
			p4.PageName As Parent4Name,
			COALESCE(p4.ParentID,-1) As Parent5ID,
			p5.PageName As Parent5Name,
			COALESCE(p5.ParentID,-1) As Parent6ID,
			p6.PageName As Parent6Name,
			COALESCE(p6.ParentID,-1) As Parent7ID,
			p7.PageName As Parent7Name,
			COALESCE(p7.ParentID,-1) As Parent8ID,
			p8.PageName As Parent8Name,
			COALESCE(p8.ParentID,-1) As Parent9ID,
			p9.PageName As Parent9Name,
			COALESCE(p9.ParentID,-1) As Parent10ID,
			p10.PageName As Parent10Name,
			COALESCE(p10.ParentID,-1) As Parent11ID,
			p11.PageName As Parent11Name,
			COALESCE(p11.ParentID,-1) As Parent12ID,
			p12.PageName As Parent12Name


FROM			mp_Pages p

LEFT OUTER JOIN	mp_Pages p1
ON			p1.PageID = p.ParentID

LEFT OUTER JOIN	mp_Pages p2
ON			p2.PageID = p1.ParentID

LEFT OUTER JOIN	mp_Pages p3
ON			p3.PageID = p2.ParentID

LEFT OUTER JOIN	mp_Pages p4
ON			p4.PageID = p3.ParentID

LEFT OUTER JOIN	mp_Pages p5
ON			p5.PageID = p4.ParentID

LEFT OUTER JOIN	mp_Pages p6
ON			p6.PageID = p5.ParentID

LEFT OUTER JOIN	mp_Pages p7
ON			p7.PageID = p6.ParentID

LEFT OUTER JOIN	mp_Pages p8
ON			p8.PageID = p7.ParentID

LEFT OUTER JOIN	mp_Pages p9
ON			p9.PageID = p8.ParentID

LEFT OUTER JOIN	mp_Pages p10
ON			p10.PageID = p9.ParentID

LEFT OUTER JOIN	mp_Pages p11
ON			p11.PageID = p10.ParentID

LEFT OUTER JOIN	mp_Pages p12
ON			p12.PageID = p11.ParentID




WHERE 		p.PageID = @PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_Delete]    Script Date: 05/11/2007 10:57:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_Delete]
(
    @PageID int
)
AS

DELETE FROM
    mp_Pages

WHERE
    PageID = @PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_UpdatePageOrder]    Script Date: 05/11/2007 10:58:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_UpdatePageOrder]
(
    @PageID           int,
    @PageOrder        int
)
AS

UPDATE
    mp_Pages

SET
    PageOrder = @PageOrder

WHERE
    PageID = @PageID
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectList]    Script Date: 05/11/2007 10:58:01 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectList]

/*
Author:				Joe Audette
Created:			7/27/2004
Last Modified:			7/27/2004

*/

@SiteID			int



AS

SELECT  			*
    				
    
FROM    
    				mp_Pages
    
WHERE   
    				SiteID = @SiteID

ORDER BY			ParentID,  PageName
GO
/****** Object:  StoredProcedure [dbo].[mp_Pages_SelectChildPages]    Script Date: 05/11/2007 10:58:01 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Pages_SelectChildPages]

/*
Author:				Joe Audette
Created:			2/20/2005
Last Modified:			2/27/2005

*/


@ParentID		int


AS


SELECT	*

FROM		mp_Pages

WHERE	ParentID = @ParentID

ORDER BY PageOrder
GO
/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Delete]    Script Date: 05/11/2007 10:58:12 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_RssFeeds_Delete]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 			3/27/2005

*/

@ItemID int

AS

DELETE FROM [dbo].[mp_RssFeeds]
WHERE
	[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Update]    Script Date: 05/11/2007 10:58:14 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_RssFeeds_Update]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 			3/27/2005


*/
	
@ItemID int, 
@ModuleID int, 
@Author nvarchar(100), 
@Url nvarchar(255), 
@RssUrl nvarchar(255) 


AS

UPDATE 		[dbo].[mp_RssFeeds] 

SET
			[ModuleID] = @ModuleID,
			[Author] = @Author,
			[Url] = @Url,
			[RssUrl] = @RssUrl
			
WHERE
			[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Select]    Script Date: 05/11/2007 10:58:13 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_RssFeeds_Select]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 			3/27/2005

*/

@ModuleID		int

AS


SELECT
		[ItemID],
		[ModuleID],
		[CreatedDate],
		[UserID],
		[Author],
		[Url],
		[RssUrl]
		
FROM
		[dbo].[mp_RssFeeds]


WHERE	ModuleID = @ModuleID

ORDER BY	Author
GO
/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_SelectOne]    Script Date: 05/11/2007 10:58:13 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_RssFeeds_SelectOne]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 		  	3/27/2005


*/


@ItemID int

AS


SELECT
		[ItemID],
		[ModuleID],
		[CreatedDate],
		[UserID],
		[Author],
		[Url],
		[RssUrl]
		
FROM
		[dbo].[mp_RssFeeds]
		
WHERE
		[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_RssFeeds_Insert]    Script Date: 05/11/2007 10:58:12 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_RssFeeds_Insert]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 			3/27/2005


*/

@ModuleID int,
@UserID int,
@Author nvarchar(100),
@Url nvarchar(255),
@RssUrl nvarchar(255)

	
AS

INSERT INTO 	[dbo].[mp_RssFeeds] 
(
				[ModuleID],
				[CreatedDate],
				[UserID],
				[Author],
				[Url],
				[RssUrl]
) 

VALUES 
(
				@ModuleID,
				GetDate(),
				@UserID,
				@Author,
				@Url,
				@RssUrl
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_SelectOne]    Script Date: 05/11/2007 10:58:27 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SharedFiles_SelectOne]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/10/2005

*/

@ItemID int

AS


SELECT
		[ItemID],
		[ModuleID],
		[UploadUserID],
		[FriendlyName],
		[OriginalFileName],
		[ServerFileName],
		[SizeInKB],
		[UploadDate],
		[FolderID]
		
FROM
		[dbo].[mp_SharedFiles]
		
WHERE
		[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_Delete]    Script Date: 05/11/2007 10:58:25 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SharedFiles_Delete]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/5/2005


*/

@ItemID int

AS

DELETE FROM [dbo].[mp_SharedFiles]
WHERE
	[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_Update]    Script Date: 05/11/2007 10:58:29 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFiles_Update]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/10/2005

*/
	
@ItemID int, 
@ModuleID int, 
@UploadUserID int, 
@FriendlyName nvarchar(255), 
@OriginalFileName nvarchar(255), 
@ServerFileName nvarchar(255), 
@SizeInKB int, 
@UploadDate datetime, 
@FolderID int 


AS

UPDATE 		[dbo].[mp_SharedFiles] 

SET
			[ModuleID] = @ModuleID,
			[UploadUserID] = @UploadUserID,
			[FriendlyName] = @FriendlyName,
			[OriginalFileName] = @OriginalFileName,
			[ServerFileName] = @ServerFileName,
			[SizeInKB] = @SizeInKB,
			[UploadDate] = @UploadDate,
			[FolderID] = @FolderID
			
WHERE
			[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_Insert]    Script Date: 05/11/2007 10:58:26 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFiles_Insert]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			1/10/2005


*/

@ModuleID int,
@UploadUserID int,
@FriendlyName nvarchar(255),
@OriginalFileName nvarchar(255),
@ServerFileName nvarchar(255),
@SizeInKB int,
@UploadDate datetime,
@FolderID int

	
AS

INSERT INTO 			[dbo].[mp_SharedFiles] 
(
				[ModuleID],
				[UploadUserID],
				[FriendlyName],
				[OriginalFileName],
				[ServerFileName],
				[SizeInKB],
				[UploadDate],
				[FolderID]
) 

VALUES 
(
				@ModuleID,
				@UploadUserID,
				@FriendlyName,
				@OriginalFileName,
				@ServerFileName,
				@SizeInKB,
				@UploadDate,
				@FolderID
				
)


SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFiles_SelectByModule]    Script Date: 05/11/2007 10:58:26 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SharedFiles_SelectByModule]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		1/12/2007

*/

@ModuleID		int,
@FolderID		int

AS
SELECT
		sf.[ItemID],
		sf.[ModuleID],
		sf.[UploadUserID],
		sf.[FriendlyName],
		sf.[OriginalFileName],
		sf.[ServerFileName],
		sf.[SizeInKB],
		sf.[UploadDate],
		sf.[FolderID],
		u.[Name] As UserName
		
FROM
		[dbo].[mp_SharedFiles] sf

LEFT OUTER JOIN
		mp_Users u
ON		sf.UploadUserID = u.UserID

WHERE	sf.ModuleID = @ModuleID
		AND sf.FolderID = @FolderID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_SelectOne]    Script Date: 05/11/2007 10:58:31 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SharedFilesHistory_SelectOne]

/*
Author:   			Joe Audette
Created: 			1/9/2005
Last Modified: 			1/10/2005

*/


@ID	int

AS


SELECT
		[ID],
		[ItemID],
		[ModuleID],
		[FriendlyName],
		OriginalFileName,
		[ServerFileName],
		SizeInKB,
		UploadDate,
		UploadUserID,
		[ArchiveDate]
		
FROM
		[dbo].[mp_SharedFilesHistory]

WHERE	[ID] = @ID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_Insert]    Script Date: 05/11/2007 10:58:30 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFilesHistory_Insert]

/*
Author:   			Joe Audette
Created: 			1/9/2005
Last Modified: 			1/10/2005

*/

@ItemID int,
@ModuleID int,
@FriendlyName nvarchar(255),
@OriginalFileName nvarchar(255),
@ServerFileName nvarchar(50),
@SizeInKB	int,
@UploadDate datetime,
@UploadUserID	int,
@ArchiveDate datetime

	
AS

INSERT INTO 	[dbo].[mp_SharedFilesHistory] 
(
				[ItemID],
				[ModuleID],
				[FriendlyName],
				OriginalFileName,
				[ServerFileName],
				SizeInKB,
				UploadDate,
				UploadUserID,
				[ArchiveDate]
) 

VALUES 
(
				@ItemID,
				@ModuleID,
				@FriendlyName,
				@OriginalFileName,
				@ServerFileName,
				@SizeInKB,
				@UploadDate,
				@UploadUserID,
				@ArchiveDate
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_Delete]    Script Date: 05/11/2007 10:58:29 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SharedFilesHistory_Delete]

/*
Author:   			Joe Audette
Created: 			1/9/2005
Last Modified: 			1/9/2005

*/

@ID int

AS

DELETE FROM [dbo].[mp_SharedFilesHistory]
WHERE
	[ID] = @ID
GO
/****** Object:  StoredProcedure [dbo].[mp_SharedFilesHistory_Select]    Script Date: 05/11/2007 10:58:31 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SharedFilesHistory_Select]

/*
Author:   			Joe Audette
Created: 			1/9/2005
Last Modified: 			1/10/2005

*/

@ModuleID	int,
@ItemID	int

AS


SELECT
		h.[ID],
		h.[ItemID],
		h.[ModuleID],
		h.[FriendlyName],
		h.OriginalFileName,
		h.[ServerFileName],
		h.SizeInKB,
		h.UploadDate,
		h.UploadUserID,
		h.[ArchiveDate],
		u.[Name]
		
FROM
		[dbo].[mp_SharedFilesHistory] h

LEFT OUTER JOIN	mp_Users u
ON			u.UserID = h.UploadUserID

WHERE	h.ModuleID = @ModuleID
		AND h.ItemID = @ItemID

ORDER BY 	h.ArchiveDate DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_Insert]    Script Date: 05/11/2007 10:59:04 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserProperties_Insert]

/*
Author:   			Joe Audette
Created: 			12/31/2006
Last Modified: 		12/31/2006
*/

@PropertyID uniqueidentifier,
@UserGuid uniqueidentifier,
@PropertyName nvarchar(255),
@PropertyValueString ntext,
@PropertyValueBinary image,
@LastUpdatedDate datetime,
@IsLazyLoaded bit

	
AS



INSERT INTO 	[dbo].[mp_UserProperties] 
(
				[PropertyID],
				[UserGuid],
				[PropertyName],
				[PropertyValueString],
				[PropertyValueBinary],
				[LastUpdatedDate],
				[IsLazyLoaded]
) 

VALUES 
(
				@PropertyID,
				@UserGuid,
				@PropertyName,
				@PropertyValueString,
				@PropertyValueBinary,
				@LastUpdatedDate,
				@IsLazyLoaded
				
)
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_Update]    Script Date: 05/11/2007 10:59:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserProperties_Update]

/*
Author:   			Joe Audette
Created: 			12/31/2006
Last Modified: 		12/31/2006
*/
	 
@UserGuid uniqueidentifier, 
@PropertyName nvarchar(255), 
@PropertyValueString ntext, 
@PropertyValueBinary image, 
@LastUpdatedDate datetime, 
@IsLazyLoaded bit 


AS

UPDATE 		[dbo].[mp_UserProperties] 

SET
			[UserGuid] = @UserGuid,
			[PropertyName] = @PropertyName,
			[PropertyValueString] = @PropertyValueString,
			[PropertyValueBinary] = @PropertyValueBinary,
			[LastUpdatedDate] = @LastUpdatedDate,
			[IsLazyLoaded] = @IsLazyLoaded
			
WHERE
			[UserGuid] = @UserGuid
			AND [PropertyName] = @PropertyName
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_PropertyExists]    Script Date: 05/11/2007 10:59:05 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_UserProperties_PropertyExists]

/*
Author:			Joe Audette
Created:		12/31/2006
Last Modified:	12/31/2006

*/
    
@UserGuid  	uniqueidentifier,
@PropertyName	nvarchar(255)

AS
SELECT Count(*)
FROM mp_UserProperties
WHERE UserGuid = @UserGuid
AND [PropertyName] = @PropertyName
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_Delete]    Script Date: 05/11/2007 10:59:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserProperties_Delete]

/*
Author:   			Joe Audette
Created: 			12/31/2006
Last Modified: 		12/31/2006
*/

@UserGuid uniqueidentifier,
@PropertyName	nvarchar(255)

AS

DELETE FROM [dbo].[mp_UserProperties]
WHERE
	[UserGuid] = @UserGuid
	AND [PropertyName] = @PropertyName
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_SelectByUser]    Script Date: 05/11/2007 10:59:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserProperties_SelectByUser]

/*
Author:   			Joe Audette
Created: 			12/31/2006
Last Modified: 		12/31/2006
*/

@UserGuid uniqueidentifier


AS


SELECT	
		[PropertyID],
		[UserGuid],
		[PropertyName],
		[PropertyValueString],
		[PropertyValueBinary],
		[LastUpdatedDate],
		[IsLazyLoaded]
		
FROM
		[dbo].[mp_UserProperties]
		
WHERE
		[UserGuid] = @UserGuid
		AND IsLazyLoaded = 0
GO
/****** Object:  StoredProcedure [dbo].[mp_UserProperties_SelectOne]    Script Date: 05/11/2007 10:59:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserProperties_SelectOne]

/*
Author:   			Joe Audette
Created: 			12/31/2006
Last Modified: 		12/31/2006
*/

@UserGuid uniqueidentifier,
@PropertyName nvarchar(255)

AS


SELECT	TOP 1
		[PropertyID],
		[UserGuid],
		[PropertyName],
		[PropertyValueString],
		[PropertyValueBinary],
		[LastUpdatedDate],
		[IsLazyLoaded]
		
FROM
		[dbo].[mp_UserProperties]
		
WHERE
		[UserGuid] = @UserGuid
		AND PropertyName = @PropertyName
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteModuleDefinitions_Delete]    Script Date: 05/11/2007 10:58:38 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteModuleDefinitions_Delete]


/*
Author:			Joe Audette
Created:		3/12/2005
Last Modified:		3/12/2005

*/


@SiteID		int,
@ModuleDefID		int


AS

DELETE FROM mp_SiteModuleDefinitions
WHERE	SiteID = @SiteID 
		AND ModuleDefID = @ModuleDefID
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteModuleDefinitions_Insert]    Script Date: 05/11/2007 10:58:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteModuleDefinitions_Insert]

/*
Author:			Joe Audette
Created:		3/12/2005
Last Modified:		3/12/2005

*/


@SiteID		int,
@ModuleDefID		int



AS


IF NOT EXISTS (SELECT SiteID FROM mp_SiteModuleDefinitions WHERE SiteID = @SiteID AND ModuleDefID = @ModuleDefID)
INSERT INTO mp_SiteModuleDefinitions (SiteID, ModuleDefID)

VALUES	(@SiteID, @ModuleDefID)
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectByEmail]    Script Date: 05/11/2007 10:59:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Users_SelectByEmail]

    
@SiteID	int,
@Email 		nvarchar(100)


AS

SELECT	*

FROM
    mp_Users

WHERE
	SiteID = @SiteID
   	AND Email = @Email
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Delete]    Script Date: 05/11/2007 10:59:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Users_Delete]
(
    @UserID int
)
AS

DELETE FROM
    mp_Users

WHERE
    UserID=@UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_ConfirmRegistration]    Script Date: 05/11/2007 10:59:17 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[mp_Users_ConfirmRegistration] 

@EmptyGuid					uniqueidentifier,
@RegisterConfirmGuid		uniqueidentifier

AS
UPDATE	mp_Users
SET		IsLockedOut = 0,
		RegisterConfirmGuid = @EmptyGuid
		

WHERE	RegisterConfirmGuid = @RegisterConfirmGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_FlagAsDeleted]    Script Date: 05/11/2007 10:59:25 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_FlagAsDeleted]


@UserID int

AS

UPDATE
    mp_Users

SET	IsDeleted = 1

WHERE
    UserID=@UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_DecrementTotalPosts]    Script Date: 05/11/2007 10:59:23 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_DecrementTotalPosts]

/*
Author:				Joe Audette
Created:			10/3/2004
Last Modified:			10/3/2004

*/

@UserID		int

AS


UPDATE		mp_Users

SET			TotalPosts = TotalPosts - 1

WHERE		UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetRegistrationConfirmationGuid]    Script Date: 05/11/2007 10:59:46 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[mp_Users_SetRegistrationConfirmationGuid] 

@UserGuid					uniqueidentifier,
@RegisterConfirmGuid		uniqueidentifier

AS
UPDATE	mp_Users
SET		IsLockedOut = 1,
		RegisterConfirmGuid = @RegisterConfirmGuid
		

WHERE	UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_LoginByEmail]    Script Date: 05/11/2007 10:59:33 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE Procedure [dbo].[mp_Users_LoginByEmail]

   
@SiteID	int, 
@Email    	nvarchar(100), 
@Password 	nvarchar(20), 
@UserName 	nvarchar(100) OUTPUT

AS

SELECT
    @UserName = Name

FROM
    mp_Users

WHERE
		SiteID = @SiteID
    		AND Email = @Email
  		AND [Password] = @Password
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_AccountClearLockout]    Script Date: 05/11/2007 10:59:16 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_AccountClearLockout]

@UserGuid		uniqueidentifier


AS

UPDATE	mp_Users
SET		IsLockedOut = 0
		

WHERE	UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdateLastPasswordChangeTime]    Script Date: 05/11/2007 10:59:55 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_UpdateLastPasswordChangeTime]


@UserID	uniqueidentifier,
@PasswordChangeTime	datetime


AS

UPDATE mp_Users WITH (ROWLOCK)
SET LastPasswordChangedDate = @PasswordChangeTime
WHERE UserGuid = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_SelectByRoleID]    Script Date: 05/11/2007 10:59:14 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserRoles_SelectByRoleID]

    
@RoleID  int

AS

SELECT  
    		ur.UserID,
    		u.[Name],
    		u.Email,
		u.LoginName

FROM
    		mp_UserRoles ur
    
JOIN 		mp_Users  u
ON 		u.UserID = ur.UserID

WHERE   
    		ur.RoleID = @RoleID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectByLoginName]    Script Date: 05/11/2007 10:59:36 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SelectByLoginName]

    
@SiteID	int,
@LoginName 		nvarchar(50)


AS

SELECT	*

FROM
    mp_Users

WHERE
	SiteID = @SiteID
   	AND LoginName = @LoginName
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Insert]    Script Date: 05/11/2007 10:59:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [dbo].[mp_Users_Insert]

/*
Author:			Joe Audette
Created:		9/30/2004
Last Modified:		1/14/2007

*/

@SiteID	int,
@Name     	nvarchar(50),
@LoginName	nvarchar(50),
@Email    	nvarchar(100),
@Password 	nvarchar(50),
@UserGuid	uniqueidentifier,
@DateCreated datetime


AS
INSERT INTO 		mp_Users
(
			SiteID,
    			[Name],
			LoginName,
    			Email,
    			[Password],
			UserGuid,
			DateCreated
	

)

VALUES
(
			@SiteID,
    			@Name,
			@LoginName,
    			@Email,
    			@Password,
			@UserGuid,
			@DateCreated
)

SELECT		@@Identity As UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SmartDropDown]    Script Date: 05/11/2007 10:59:47 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Users_SmartDropDown]

/*
Author:		Joe Audette
Created:	6/19/2005
Last Modified:	6/19/2005

*/


@SiteID			int,
@Query				nvarchar(50),
@RowsToGet			int


AS


SET ROWCOUNT @RowsToGet


SELECT 		u1.UserID,
			u1.[Name] AS SiteUser

FROM			mp_Users u1

WHERE		u1.SiteID = @SiteID
			AND u1.[Name] LIKE @Query + '%'

UNION

SELECT 		u2.UserID,
			u2.[Email] As SiteUser

FROM			mp_Users u2

WHERE		u2.SiteID = @SiteID
			AND u2.[Email] LIKE @Query + '%'

ORDER BY		SiteUser
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Login]    Script Date: 05/11/2007 10:59:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [dbo].[mp_Users_Login]

   
@SiteID	int, 
@LoginName    	nvarchar(50), 
@Password 	nvarchar(128), 
@UserName 	nvarchar(100) OUTPUT

AS
SELECT
    @UserName = Name

FROM
    mp_Users

WHERE
		SiteID = @SiteID
    		AND LoginName = @LoginName
  		AND [Password] = @Password
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_AccountLockout]    Script Date: 05/11/2007 10:59:16 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_AccountLockout]

@UserGuid		uniqueidentifier,
@LockoutTime		datetime

AS

UPDATE	mp_Users
SET		IsLockedOut = 1,
		LastLockoutDate = @LockoutTime

WHERE	UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectByGuid]    Script Date: 05/11/2007 10:59:35 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SelectByGuid]

/*
Author:			Joe Audette
Created:		4/15/2006
Last Modified:		4/15/2006

*/

@UserGuid	uniqueidentifier

AS

SELECT	*

FROM		mp_Users

WHERE	UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Select]    Script Date: 05/11/2007 10:59:34 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Users_Select]


@SiteID		int

AS
SELECT  
    UserID,
	LoginName,
    Email,
	Password

FROM
    mp_Users

WHERE SiteID = @SiteID
    
ORDER BY Email
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdatePasswordQuestionAndAnswer]    Script Date: 05/11/2007 10:59:57 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_UpdatePasswordQuestionAndAnswer]


@UserID		uniqueidentifier,
@PasswordQuestion	nvarchar(255),
@PasswordAnswer	nvarchar(255)


AS

UPDATE mp_Users WITH (ROWLOCK)
SET PasswordQuestion = @PasswordQuestion,
	PasswordAnswer = @PasswordAnswer

WHERE UserGuid = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_SelectNotInRole]    Script Date: 05/11/2007 10:59:15 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserRoles_SelectNotInRole]

@SiteID	int,
@RoleID  int

AS
SELECT  DISTINCT
    		u.UserID,
    		u.[Name],
    		u.Email,
			u.LoginName

FROM		mp_Users  u
    		
    
LEFT OUTER JOIN 		
		mp_UserRoles ur

ON 		u.UserID = ur.UserID
		AND ur.RoleID = @RoleID

WHERE		u.SiteID = @SiteID
    		
			AND ur.RoleID IS NULL

ORDER BY	u.[Name]
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_CountOnlineSinceTime]    Script Date: 05/11/2007 10:59:23 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_CountOnlineSinceTime]

/*
Author:			Joe Audette
Created:		4/15/2006
Last Modified:		4/15/2006

*/

@SiteID		int,
@SinceTime		datetime

AS

SELECT  	COUNT(*)

FROM		mp_Users

WHERE	SiteID = @SiteID
		AND LastActivityDate > @SinceTime
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Update]    Script Date: 05/11/2007 10:59:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Users_Update]

/*
Author:			Joe Audette
Created:		9/30/2004
Last Modified:		11/8/2006

*/

    
@UserID        			int,   
@Name				nvarchar(100),
@LoginName			nvarchar(50),
@Email           			nvarchar(100),   
@Password    			nvarchar(20),
@Gender			nchar(1),
@ProfileApproved		bit,
@ApprovedForForums		bit,
@Trusted			bit,
@DisplayInMemberList		bit,
@WebSiteURL			nvarchar(100),
@Country			nvarchar(100),
@State				nvarchar(100),
@Occupation			nvarchar(100),
@Interests			nvarchar(100),
@MSN				nvarchar(50),
@Yahoo			nvarchar(50),
@AIM				nvarchar(50),
@ICQ				nvarchar(50),
@AvatarUrl			nvarchar(255),
@Signature			nvarchar(255),
@Skin				nvarchar(100),

@LoweredEmail		nvarchar(100),
@PasswordQuestion		nvarchar(255),
@PasswordAnswer		nvarchar(255),
@Comment		ntext,
@TimeOffsetHours	int



AS
UPDATE		mp_Users

SET			[Name] = @Name,
			LoginName = @LoginName,
			Email = @Email,
    			[Password] = @Password,
			Gender = @Gender,
			ProfileApproved = @ProfileApproved,
			ApprovedForForums = @ApprovedForForums,
			Trusted = @Trusted,
			DisplayInMemberList = @DisplayInMemberList,
			WebSiteURL = @WebSiteURL,
			Country = @Country,
			State = @State,
			Occupation = @Occupation,
			Interests = @Interests,
			MSN = @MSN,
			Yahoo = @Yahoo,
			AIM = @AIM,
			ICQ = @ICQ,
			AvatarUrl = @AvatarUrl,
			Signature = @Signature,
			Skin = @Skin,
			LoweredEmail = @LoweredEmail,
			PasswordQuestion = @PasswordQuestion,
			PasswordAnswer = @PasswordAnswer,
			Comment = @Comment,
			TimeOffsetHours = @TimeOffsetHours
			
WHERE		UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAttemptStartWindow]    Script Date: 05/11/2007 10:59:45 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SetFailedPasswordAttemptStartWindow]

/*
Author:				Joe Audette
Created:			1/18/2007
Last Modified:		4/29/2007

*/

@UserGuid uniqueidentifier,
@WindowStartTime datetime

AS
UPDATE		mp_Users

SET			

FailedPwdAttemptWindowStart = @WindowStartTime


WHERE		UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_Count]    Script Date: 05/11/2007 10:59:18 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_Count]

/*
Author:			Joe Audette
Created:		11/29/2004
Last Modified:		5/12/2005

*/

@SiteID		int

AS

SELECT  	COUNT(*)

FROM		mp_Users

WHERE	SiteID = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_GetNewestUserID]    Script Date: 05/11/2007 10:59:25 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_GetNewestUserID]

/*
Author:			Joe Audette
Created:		12/3/2006
Last Modified:	12/3/2006

*/

@SiteID		int

AS
SELECT  	MAX(UserID)

FROM		mp_Users

WHERE	SiteID = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_IncrementTotalPosts]    Script Date: 05/11/2007 10:59:27 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_IncrementTotalPosts]

/*
Author:				Joe Audette
Created:			10/3/2004
Last Modified:			10/3/2004

*/

@UserID		int

AS


UPDATE		mp_Users

SET			TotalPosts = TotalPosts + 1

WHERE		UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdateLastLoginTime]    Script Date: 05/11/2007 10:59:54 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_UpdateLastLoginTime]


@UserID	uniqueidentifier,
@LastLoginTime	datetime


AS

UPDATE mp_Users WITH (ROWLOCK)
SET LastLoginDate = @LastLoginTime
WHERE UserGuid = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectOne]    Script Date: 05/11/2007 10:59:37 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SelectOne]

/*
Author:			Joe Audette
Created:		10/3/2004
Last Modified:		10/3/2004

*/

@UserID		int

AS

SELECT	*

FROM		mp_Users

WHERE	UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_UpdateLastActivityTime]    Script Date: 05/11/2007 10:59:53 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_UpdateLastActivityTime]


@UserID	uniqueidentifier,
@LastUpdate	datetime


AS

UPDATE mp_Users WITH (ROWLOCK)
SET LastActivityDate = @LastUpdate
WHERE UserGuid = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_CountByFirstLetter]    Script Date: 05/11/2007 10:59:21 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_CountByFirstLetter]

/*
Author:			Joe Audette
Created:		12/7/2006
Last Modified:	12/7/2006

*/

@SiteID		int,
@UserNameBeginsWith 		nvarchar(1)

AS
SELECT  	COUNT(*)

FROM		mp_Users

WHERE	SiteID = @SiteID
AND (
	(LEFT([Name], 1) = @UserNameBeginsWith)
	OR @UserNameBeginsWith = ''
	)
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAnswerAttemptCount]    Script Date: 05/11/2007 10:59:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SetFailedPasswordAnswerAttemptCount]

/*
Author:				Joe Audette
Created:			1/18/2007
Last Modified:		4/29/2007

*/

@UserGuid uniqueidentifier,
@AttemptCount int

AS
UPDATE		mp_Users

SET			

FailedPwdAnswerAttemptCount = @AttemptCount


WHERE		UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectUsersOnlineSinceTime]    Script Date: 05/11/2007 10:59:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SelectUsersOnlineSinceTime]

/*
Author:			Joe Audette
Created:		11/7/2006
Last Modified:	11/7/2006

*/

@SiteID		int,
@SinceTime		datetime

AS
SELECT  	*

FROM		mp_Users

WHERE	SiteID = @SiteID
		AND LastActivityDate > @SinceTime
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SelectTop50UsersOnlineSinceTime]    Script Date: 05/11/2007 10:59:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SelectTop50UsersOnlineSinceTime]

/*
Author:			Joe Audette
Created:		11/7/2006
Last Modified:	11/7/2006

*/

@SiteID		int,
@SinceTime		datetime

AS
SELECT TOP 50 	*

FROM		mp_Users

WHERE	SiteID = @SiteID
		AND LastActivityDate > @SinceTime

ORDER BY LastActivityDate desc
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAttemptCount]    Script Date: 05/11/2007 10:59:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SetFailedPasswordAttemptCount]

/*
Author:				Joe Audette
Created:			1/18/2007
Last Modified:		1/18/2007

*/

@UserGuid uniqueidentifier,
@AttemptCount int

AS
UPDATE		mp_Users

SET			

FailedPasswordAttemptCount = @AttemptCount


WHERE		UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_CountByRegistrationDateRange]    Script Date: 05/11/2007 10:59:22 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_CountByRegistrationDateRange]

/*
Author:				Joe Audette
Created:			12/3/2006
Last Modified:		12/3/2006

*/

@SiteID		int,
@BeginDate	datetime,
@EndDate	datetime

AS
SELECT  	COUNT(*)

FROM		mp_Users

WHERE	SiteID = @SiteID
AND DateCreated Between @BeginDate And @EndDate
GO
/****** Object:  StoredProcedure [dbo].[mp_Users_SetFailedPasswordAnswerAttemptStartWindow]    Script Date: 05/11/2007 10:59:41 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Users_SetFailedPasswordAnswerAttemptStartWindow]

/*
Author:				Joe Audette
Created:			1/18/2007
Last Modified:		4/29/2007

*/

@UserGuid uniqueidentifier,
@WindowStartTime datetime

AS
UPDATE		mp_Users

SET			

FailedPwdAnswerWindowStart = @WindowStartTime


WHERE		UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_DeleteUserRoles]    Script Date: 05/11/2007 10:59:12 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_UserRoles_DeleteUserRoles]

/*
Author:			Joe Audette
Created:		11/30/2005
Last Modified:		11/30/2005

*/
    
@UserID int

AS

DELETE FROM	mp_UserRoles

WHERE	UserID = @UserID
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_Insert]    Script Date: 05/11/2007 10:59:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [dbo].[mp_UserRoles_Insert]
(
	@RoleID int,
    	@UserID int
    
)
AS

SELECT 
    *
FROM
    mp_UserRoles

WHERE
    UserID=@UserID
    AND
    RoleID=@RoleID

/* only insert if the record doesn't yet exist */
IF @@Rowcount < 1

    INSERT INTO mp_UserRoles
    (
        UserID,
        RoleID
    )

    VALUES
    (
        @UserID,
        @RoleID
    )
GO
/****** Object:  StoredProcedure [dbo].[mp_UserRoles_Delete]    Script Date: 05/11/2007 10:59:12 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserRoles_Delete]
(
   
    	@RoleID int,
	 @UserID int
)
AS

DELETE FROM
    mp_UserRoles

WHERE
    UserID=@UserID
    AND
    RoleID=@RoleID
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_Insert]    Script Date: 05/11/2007 10:59:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserPages_Insert]

/*
Author:   			Joe Audette
Created: 			6/12/2006
Last Modified: 		6/14/2006
*/

@UserPageID	uniqueidentifier,
@SiteID int,
@UserGuid uniqueidentifier,
@PageName nvarchar(255),
@PagePath nvarchar(255),
@PageOrder int

	
AS
INSERT INTO 	[dbo].[mp_UserPages] 
(
				[UserPageID],
				[SiteID],
				[UserGuid],
				[PageName],
				PagePath,
				PageOrder
) 

VALUES 
(
				@UserPageID,
				@SiteID,
				@UserGuid,
				@PageName,
				@PagePath,
				@PageOrder
				
)
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_Delete]    Script Date: 05/11/2007 10:58:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserPages_Delete]

/*
Author:   			Joe Audette
Created: 			6/12/2006
Last Modified: 		6/12/2006
*/

@UserPageID uniqueidentifier

AS

DELETE FROM [dbo].[mp_UserPages]
WHERE
	[UserPageID] = @UserPageID
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_SelectByUser]    Script Date: 05/11/2007 10:59:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserPages_SelectByUser]

/*
Author:   			Joe Audette
Created: 			6/12/2006
Last Modified: 		6/12/2006
*/

@UserGuid uniqueidentifier

AS


SELECT
		*
		
FROM
		[dbo].[mp_UserPages]
		
WHERE
		[UserGuid] = @UserGuid

ORDER BY PageOrder
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_UpdatePageOrder]    Script Date: 05/11/2007 10:59:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserPages_UpdatePageOrder]
(
    @UserPageID       uniqueidentifier,
    @PageOrder        int
)
AS
UPDATE
    mp_UserPages

SET
    PageOrder = @PageOrder

WHERE
    UserPageID = @UserPageID
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_GetNextPageOrder]    Script Date: 05/11/2007 10:59:00 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_UserPages_GetNextPageOrder]

/*
Author:			Joe Audette
Created:		11/7/2004
Last Modified:		11/7/2004

*/

@UserGuid uniqueidentifier

AS
SELECT	COALESCE(MAX(PageOrder), -1) + 2

FROM		mp_UserPages

WHERE	UserGuid = @UserGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_Update]    Script Date: 05/11/2007 10:59:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserPages_Update]

/*
Author:   			Joe Audette
Created: 			6/12/2006
Last Modified: 		6/12/2006
*/
	
@UserPageID uniqueidentifier, 
@PageName nvarchar(255), 
@PageOrder int 


AS

UPDATE 		[dbo].[mp_UserPages] 

SET
			[PageName] = @PageName,
			[PageOrder] = @PageOrder
			
WHERE
			[UserPageID] = @UserPageID
GO
/****** Object:  StoredProcedure [dbo].[mp_UserPages_SelectOne]    Script Date: 05/11/2007 10:59:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_UserPages_SelectOne]

/*
Author:   			Joe Audette
Created: 			6/12/2006
Last Modified: 		6/12/2006
*/

@UserPageID uniqueidentifier

AS
SELECT
		*
		
FROM
		[dbo].[mp_UserPages]
		
WHERE
		[UserPageID] = @UserPageID
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_Delete]    Script Date: 05/11/2007 10:56:36 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CalendarEvents_Delete]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 			4/10/2005

*/

@ItemID int

AS

DELETE FROM [dbo].[mp_CalendarEvents]
WHERE
	[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_SelectOne]    Script Date: 05/11/2007 10:56:41 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CalendarEvents_SelectOne]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 			4/10/2005


*/

@ItemID int

AS


SELECT
		[ItemID],
		[ModuleID],
		[Title],
		[Description],
		[ImageName],
		[EventDate],
		[StartTime],
		[EndTime],
		[CreatedDate],
		[UserID]
		
FROM
		[dbo].[mp_CalendarEvents]
		
WHERE
		[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_Insert]    Script Date: 05/11/2007 10:56:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CalendarEvents_Insert]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 			4/10/2005

*/

@ModuleID int,
@Title nvarchar(255),
@Description ntext,
@ImageName nvarchar(100),
@EventDate datetime,
@StartTime smalldatetime,
@EndTime smalldatetime,
@UserID int

	
AS

INSERT INTO 	[dbo].[mp_CalendarEvents] 
(
				[ModuleID],
				[Title],
				[Description],
				[ImageName],
				[EventDate],
				[StartTime],
				[EndTime],
				[CreatedDate],
				[UserID]
) 

VALUES 
(
				@ModuleID,
				@Title,
				@Description,
				@ImageName,
				@EventDate,
				@StartTime,
				@EndTime,
				GetDate(),
				@UserID
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_Update]    Script Date: 05/11/2007 10:56:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CalendarEvents_Update]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 			4/10/2005

*/
	
@ItemID int, 
@ModuleID int, 
@Title nvarchar(255), 
@Description ntext, 
@ImageName nvarchar(100), 
@EventDate datetime, 
@StartTime smalldatetime, 
@EndTime smalldatetime, 
@UserID int 


AS

UPDATE 		[dbo].[mp_CalendarEvents] 

SET
			[ModuleID] = @ModuleID,
			[Title] = @Title,
			[Description] = @Description,
			[ImageName] = @ImageName,
			[EventDate] = @EventDate,
			[StartTime] = @StartTime,
			[EndTime] = @EndTime,
			[UserID] = @UserID
			
WHERE
			[ItemID] = @ItemID
GO
/****** Object:  StoredProcedure [dbo].[mp_CalendarEvents_SelectByDate]    Script Date: 05/11/2007 10:56:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_CalendarEvents_SelectByDate]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 			4/14/2005

*/

@ModuleID		int,
@BeginDate		datetime,
@EndDate		datetime

AS
SELECT
		[ItemID],
		[ModuleID],
		[Title],
		[Description],
		[ImageName],
		[EventDate],
		[StartTime],
		[EndTime],
		[CreatedDate],
		[UserID]
		
FROM
		[dbo].[mp_CalendarEvents]

WHERE	ModuleID = @ModuleID
		AND (EventDate >= @BeginDate)
		AND (EventDate <= @EndDate)

ORDER BY	EventDate, DATEPART(hh, StartTime)
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_Update]    Script Date: 05/11/2007 10:57:04 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_Update]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		9/19/2004

*/

@ThreadID			int,
@ForumID			int,
@ThreadSubject		nvarchar(255),
@SortOrder			int,
@IsLocked			bit


AS


UPDATE		mp_ForumThreads

SET			ForumID = @ForumID,
			ThreadSubject = @ThreadSubject,
			SortOrder = @SortOrder,
			IsLocked = @IsLocked


WHERE		ThreadID = @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_IncrementReplyCount]    Script Date: 05/11/2007 10:56:58 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_IncrementReplyCount]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		1/14/2006

*/

@ThreadID			int,
@MostRecentPostUserID	int,
@MostRecentPostDate datetime



AS
UPDATE		mp_ForumThreads

SET			MostRecentPostUserID = @MostRecentPostUserID,
			TotalReplies = TotalReplies + 1,
			MostRecentPostDate = @MostRecentPostDate


WHERE		ThreadID = @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_ForumThreads_UpdateViewStats]    Script Date: 05/11/2007 10:57:05 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_ForumThreads_UpdateViewStats]

/*
Author:			Joe Audette
Created:		9/19/2004
Last Modified:		9/19/2004

*/

@ThreadID			int



AS


UPDATE		mp_ForumThreads

SET		
			TotalViews = TotalViews + 1


WHERE		ThreadID = @ThreadID
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteFolders_Delete]    Script Date: 05/11/2007 10:58:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteFolders_Delete]

/*
Author:   			Joe Audette
Created: 			5/11/2007
Last Modified: 		5/11/2007
*/

@Guid uniqueidentifier

AS

DELETE FROM [dbo].[mp_SiteFolders]
WHERE
	[Guid] = @Guid
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteFolders_SelectBySite]    Script Date: 05/11/2007 10:58:34 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteFolders_SelectBySite]

/*
Author:   			Joe Audette
Created: 			5/11/2007
Last Modified: 		5/11/2007
*/

@SiteGuid uniqueidentifier

AS


SELECT
		[Guid],
		[SiteGuid],
		[FolderName]
		
FROM
		[dbo].[mp_SiteFolders]
		
WHERE
		[SiteGuid] = @SiteGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteFolders_Update]    Script Date: 05/11/2007 10:58:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteFolders_Update]

/*
Author:   			Joe Audette
Created: 			5/11/2007
Last Modified: 		5/11/2007
*/
	
@Guid uniqueidentifier, 
@SiteGuid uniqueidentifier, 
@FolderName nvarchar(255) 


AS

UPDATE 		[dbo].[mp_SiteFolders] 

SET
			[SiteGuid] = @SiteGuid,
			[FolderName] = @FolderName
			
WHERE
			[Guid] = @Guid
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteFolders_SelectOne]    Script Date: 05/11/2007 10:58:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteFolders_SelectOne]

/*
Author:   			Joe Audette
Created: 			5/11/2007
Last Modified: 		5/11/2007
*/

@Guid uniqueidentifier

AS


SELECT
		[Guid],
		[SiteGuid],
		[FolderName]
		
FROM
		[dbo].[mp_SiteFolders]
		
WHERE
		[Guid] = @Guid
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteFolders_Insert]    Script Date: 05/11/2007 10:58:34 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteFolders_Insert]

/*
Author:   			Joe Audette
Created: 			5/11/2007
Last Modified: 		5/11/2007
*/

@Guid uniqueidentifier,
@SiteGuid uniqueidentifier,
@FolderName nvarchar(255)

	
AS

INSERT INTO 	[dbo].[mp_SiteFolders] 
(
				[Guid],
				[SiteGuid],
				[FolderName]
) 

VALUES 
(
				@Guid,
				@SiteGuid,
				@FolderName
				
)
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteFolders_SelectSiteGuidByFolder]    Script Date: 05/11/2007 10:58:35 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SiteFolders_SelectSiteGuidByFolder]

/*
Author:   			Joe Audette
Created: 			5/11/2007
Last Modified: 		5/11/2007

*/

@FolderName		nvarchar(255)

AS



SELECT COALESCE(	
	(SELECT TOP 1 SiteGuid 
		FROM mp_SiteFolders 
		WHERE FolderName = @FolderName),
				 
		(SELECT TOP 1 SiteGuid FROM mp_Sites ORDER BY SiteID)
			)
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteFolder_Exists]    Script Date: 05/11/2007 10:58:33 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SiteFolder_Exists]

/*
Author:			Joe Audette
Created:		5/11/2007
Last Modified:	5/11/2007

*/
    
@FolderName	nvarchar(255)

AS

IF EXISTS (	SELECT 	[Guid]
		FROM		mp_SiteFolders
		WHERE		FolderName = @FolderName )
SELECT 1
ELSE
SELECT 0
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_SelectOneByGuid]    Script Date: 05/11/2007 10:58:51 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Sites_SelectOneByGuid]

/*
Author:   			Joe Audette
Created: 			5/11/2007
Last Modified: 		5/11/2007

*/

@SiteGuid uniqueidentifier

AS


SELECT
		*
		
FROM
		[dbo].[mp_Sites]
		
WHERE
		[SiteGuid] = @SiteGuid
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_SelectOne]    Script Date: 05/11/2007 10:58:51 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Sites_SelectOne]

/*
Author:   			Joe Audette
Created: 			3/7/2005
Last Modified: 			5/29/2005

*/

@SiteID int

AS


SELECT
		*
		
FROM
		[dbo].[mp_Sites]
		
WHERE
		[SiteID] = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Insert]    Script Date: 05/11/2007 10:58:50 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Sites_Insert]

/*
Author:   			Joe Audette
Created: 			3/7/2005
Last Modified: 			5/21/2006

*/


@SiteName 				nvarchar(255),
@Skin 					nvarchar(100),
@Logo 					nvarchar(50),
@Icon 					nvarchar(50),
@AllowUserSkins 			bit,
@AllowNewRegistration 			bit,
@UseSecureRegistration 		bit,
@UseSSLOnAllPages 			bit,
@DefaultPageKeyWords 		nvarchar(255),
@DefaultPageDescription 		nvarchar(255),
@DefaultPageEncoding 			nvarchar(255),
@DefaultAdditionalMetaTags 		nvarchar(255),
@IsServerAdminSite 			bit,
@AllowPageSkins			bit,
@AllowHideMenuOnPages		bit,
@UseLdapAuth				bit,
@AutoCreateLdapUserOnFirstLogin	bit,
@LdapServer				nvarchar(255),
@LdapPort				int,
@LdapDomain				nvarchar(255),
@LdapRootDN				nvarchar(255),
@LdapUserDNKey			nvarchar(10),
@AllowUserFullNameChange		bit,
@UseEmailForLogin			bit,
@ReallyDeleteUsers			bit,
@EditorSkin				nvarchar(50),
@DefaultFriendlyUrlPatternEnum		nvarchar(50),
@SiteGuid					uniqueidentifier,
@EnableMyPageFeature 			bit

	
AS
INSERT INTO 	[dbo].[mp_Sites] 
(
				
				[SiteName],
				[Skin],
				[Logo],
				[Icon],
				[AllowUserSkins],
				[AllowNewRegistration],
				[UseSecureRegistration],
				[UseSSLOnAllPages],
				[DefaultPageKeyWords],
				[DefaultPageDescription],
				[DefaultPageEncoding],
				[DefaultAdditionalMetaTags],
				[IsServerAdminSite],
				AllowPageSkins,
				AllowHideMenuOnPages,
				UseLdapAuth,
				AutoCreateLdapUserOnFirstLogin,
				LdapServer,
				LdapPort,
				LdapDomain,
				LdapRootDN,
				LdapUserDNKey,
				ReallyDeleteUsers,
				UseEmailForLogin,
				AllowUserFullNameChange,
				EditorSkin,
				DefaultFriendlyUrlPatternEnum,
				SiteGuid,
				EnableMyPageFeature
) 

VALUES 
(
				
				@SiteName,
				@Skin,
				@Logo,
				@Icon,
				@AllowUserSkins,
				@AllowNewRegistration,
				@UseSecureRegistration,
				@UseSSLOnAllPages,
				@DefaultPageKeyWords,
				@DefaultPageDescription,
				@DefaultPageEncoding,
				@DefaultAdditionalMetaTags,
				@IsServerAdminSite,
				@AllowPageSkins,
				@AllowHideMenuOnPages,
				@UseLdapAuth,
				@AutoCreateLdapUserOnFirstLogin,
				@LdapServer,
				@LdapPort,
				@LdapDomain,
				@LdapRootDN,
				@LdapUserDNKey,
				@ReallyDeleteUsers,
				@UseEmailForLogin,
				@AllowUserFullNameChange,
				@EditorSkin,
				@DefaultFriendlyUrlPatternEnum,
				@SiteGuid,
				@EnableMyPageFeature
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Update]    Script Date: 05/11/2007 10:58:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Sites_Update]

/*
Author:		Joe Audette
Last Modified:	5/21/2006

*/


@SiteID           			int,
@SiteName         		nvarchar(128),
@Skin				nvarchar(100),
@Logo				nvarchar(50),
@Icon				nvarchar(50),
@AllowNewRegistration		bit,
@AllowUserSkins		bit,
@UseSecureRegistration	bit,
@UseSSLOnAllPages		bit,
@DefaultPageKeywords		nvarchar(255),
@DefaultPageDescription	nvarchar(255),
@DefaultPageEncoding		nvarchar(255),
@DefaultAdditionalMetaTags	nvarchar(255),
@IsServerAdminSite		bit,
@AllowPageSkins		bit,
@AllowHideMenuOnPages	bit,
@UseLdapAuth				bit,
@AutoCreateLdapUserOnFirstLogin	bit,
@LdapServer				nvarchar(255),
@LdapPort				int,
@LdapRootDN				nvarchar(255),
@LdapUserDNKey			nvarchar(10),
@AllowUserFullNameChange		bit,
@UseEmailForLogin			bit,
@ReallyDeleteUsers			bit,
@EditorSkin				nvarchar(50),
@DefaultFriendlyUrlPatternEnum		nvarchar(50),
@EnableMyPageFeature		bit,
@LdapDomain				nvarchar(255)
	
	

AS
UPDATE	mp_Sites

SET
    	SiteName = @SiteName,
	Skin = @Skin,
	Logo = @Logo,
	Icon = @Icon,
	AllowNewRegistration = @AllowNewRegistration,
	AllowUserSkins = @AllowUserSkins,
	UseSecureRegistration = @UseSecureRegistration,
	UseSSLOnAllPages = @UseSSLOnAllPages,
	DefaultPageKeywords = @DefaultPageKeywords,
	DefaultPageDescription = @DefaultPageDescription,
	DefaultPageEncoding = @DefaultPageEncoding,
	DefaultAdditionalMetaTags = @DefaultAdditionalMetaTags,
	IsServerAdminSite = @IsServerAdminSite,
	AllowPageSkins = @AllowPageSkins,
	AllowHideMenuOnPages = @AllowHideMenuOnPages,
	UseLdapAuth = @UseLdapAuth,
	AutoCreateLdapUserOnFirstLogin = @AutoCreateLdapUserOnFirstLogin,
	LdapServer = @LdapServer,
	LdapPort = @LdapPort,
    LdapDomain = @LdapDomain,
	LdapRootDN = @LdapRootDN,
	LdapUserDNKey = @LdapUserDNKey,
	AllowUserFullNameChange = @AllowUserFullNameChange,
	UseEmailForLogin = @UseEmailForLogin,
	ReallyDeleteUsers = @ReallyDeleteUsers,
	EditorSkin = @EditorSkin,
	DefaultFriendlyUrlPatternEnum = @DefaultFriendlyUrlPatternEnum,
	EnableMyPageFeature = @EnableMyPageFeature

WHERE
    	SiteID = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_SelectOneByHost]    Script Date: 05/11/2007 10:58:51 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Sites_SelectOneByHost]

/*
Author:   			Joe Audette
Created: 			8/27/2006
Last Modified: 		8/27/2006

*/

@HostName		nvarchar(255)

AS

DECLARE @SiteID int

SET @SiteID = COALESCE(	(SELECT TOP 1 SiteID FROM mp_SiteHosts WHERE HostName = @HostName),
				 (SELECT TOP 1 SiteID FROM mp_Sites ORDER BY SiteID)
			)

SELECT
		*
		
FROM
		[dbo].[mp_Sites]
		
WHERE
		[SiteID] = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Delete]    Script Date: 05/11/2007 10:58:47 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Sites_Delete]

/*
Author:   			Joe Audette
Created: 			3/7/2005
Last Modified: 			3/7/2005

*/

@SiteID int

AS

DELETE FROM [dbo].[mp_Sites]
WHERE
	[SiteID] = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_UpdateExtendedProperties]    Script Date: 05/11/2007 10:58:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[mp_Sites_UpdateExtendedProperties] 
	-- Add the parameters for the stored procedure here

@SiteID							int,
@AllowPasswordRetrieval			bit,
@AllowPasswordReset				bit,
@RequiresQuestionAndAnswer		bit,
@MaxInvalidPasswordAttempts		int,
@PasswordAttemptWindowMinutes	int,
@RequiresUniqueEmail			bit,
@PasswordFormat					int,
@MinRequiredPasswordLength		int,
@MinRequiredNonAlphanumericCharacters	int,
@PasswordStrengthRegularExpression	ntext,
@DefaultEmailFromAddress		nvarchar(100)

AS

UPDATE			mp_Sites

SET				AllowPasswordRetrieval = @AllowPasswordRetrieval,
				AllowPasswordReset = @AllowPasswordReset,
				RequiresQuestionAndAnswer = @RequiresQuestionAndAnswer,
				MaxInvalidPasswordAttempts = @MaxInvalidPasswordAttempts,
				PasswordAttemptWindowMinutes = @PasswordAttemptWindowMinutes,
				RequiresUniqueEmail = @RequiresUniqueEmail,
				PasswordFormat = @PasswordFormat,
				MinRequiredPasswordLength  = @MinRequiredPasswordLength,
				MinReqNonAlphaChars = @MinRequiredNonAlphanumericCharacters,
				PwdStrengthRegex = @PasswordStrengthRegularExpression,
				DefaultEmailFromAddress = @DefaultEmailFromAddress



WHERE			SiteID = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_Count]    Script Date: 05/11/2007 10:58:46 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_Sites_Count]

/*
Author:		Joe Audette
Created:	3/13/2005
Last Modified:	3/13/2005

*/

AS

SELECT Count(*) FROM mp_Sites
GO
/****** Object:  StoredProcedure [dbo].[mp_Sites_SelectAll]    Script Date: 05/11/2007 10:58:50 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_Sites_SelectAll]

/*
Author:   			Joe Audette
Created: 			3/7/2005
Last Modified: 			3/7/2005

*/

AS
SELECT
		*
		
FROM
		[dbo].[mp_Sites]
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_Insert]    Script Date: 05/11/2007 10:56:30 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogCategories_Insert]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			6/12/2005

*/

@ModuleID int,
@Category nvarchar(255)

	
AS

IF NOT EXISTS (SELECT CategoryID FROM mp_BlogCategories WHERE ModuleID = @ModuleID AND Category = @Category)
BEGIN

INSERT INTO 	[dbo].[mp_BlogCategories] 
(
				[ModuleID],
				[Category]
) 

VALUES 
(
				@ModuleID,
				@Category
				
)
SELECT @@IDENTITY 
END
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_Update]    Script Date: 05/11/2007 10:56:32 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogCategories_Update]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			9/11/2005

*/
	
@CategoryID int, 
@Category nvarchar(255) 


AS

UPDATE 		[dbo].[mp_BlogCategories] 

SET
			[Category] = @Category
			
WHERE
			[CategoryID] = @CategoryID
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogCategories_SelectOne]    Script Date: 05/11/2007 10:56:31 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_BlogCategories_SelectOne]

/*
Author:   			Joe Audette
Created: 			6/7/2005
Last Modified: 			6/7/2005

*/

@CategoryID int

AS


SELECT
		[CategoryID],
		[ModuleID],
		[Category]
		
FROM
		[dbo].[mp_BlogCategories]
		
WHERE
		[CategoryID] = @CategoryID
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_SelectOne]    Script Date: 05/11/2007 10:58:37 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteHosts_SelectOne]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 			3/6/2005

*/

@HostID int

AS


SELECT
		[HostID],
		[SiteID],
		[HostName]
		
FROM
		[dbo].[mp_SiteHosts]
		
WHERE
		[HostID] = @HostID
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Select]    Script Date: 05/11/2007 10:58:37 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SiteHosts_Select]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 			3/13/2005


*/

@SiteID		int

AS


SELECT
		[HostID],
		[SiteID],
		[HostName]
		
FROM
		[dbo].[mp_SiteHosts]

WHERE	SiteID = @SiteID
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Update]    Script Date: 05/11/2007 10:58:38 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SiteHosts_Update]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 			3/6/2005


*/
	
@HostID int, 
@SiteID int, 
@HostName nvarchar(255) 


AS

UPDATE 		[dbo].[mp_SiteHosts] 

SET
			[SiteID] = @SiteID,
			[HostName] = @HostName
			
WHERE
			[HostID] = @HostID
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Insert]    Script Date: 05/11/2007 10:58:36 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SiteHosts_Insert]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 			3/6/2005

*/

@SiteID int,
@HostName nvarchar(255)

	
AS

INSERT INTO 	[dbo].[mp_SiteHosts] 
(
				[SiteID],
				[HostName]
) 

VALUES 
(
				@SiteID,
				@HostName
				
)
SELECT @@IDENTITY
GO
/****** Object:  StoredProcedure [dbo].[mp_SiteHosts_Delete]    Script Date: 05/11/2007 10:58:36 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SiteHosts_Delete]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 			3/6/2005


*/

@HostID int

AS

DELETE FROM [dbo].[mp_SiteHosts]
WHERE
	[HostID] = @HostID
GO
/****** Object:  StoredProcedure [dbo].[mp_BlogComments_Select]    Script Date: 05/11/2007 10:56:34 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_BlogComments_Select]
(
    @ModuleID int,
    @ItemID int
)
AS

SELECT		BlogCommentID,
			ItemID, 
			ModuleID, 
			Name, 
			Title, 
			URL, 
			Comment, 
			DateCreated

FROM        mp_BlogComments

WHERE
    		ModuleID = @ModuleID
		AND ItemID = @ItemID

   ORDER BY
   	BlogCommentID DESC,  DateCreated DESC
GO
/****** Object:  StoredProcedure [dbo].[mp_ModuleDefinitions_Insert]    Script Date: 05/11/2007 10:57:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_ModuleDefinitions_Insert]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 		1/21/2007

*/

@SiteID int,
@FeatureName nvarchar(255),
@ControlSrc nvarchar(255),
@SortOrder int,
@IsAdmin bit,
@Icon	nvarchar(255),
@DefaultCacheTime int


	
AS
DECLARE @ModuleDefID int

INSERT INTO 	[dbo].[mp_ModuleDefinitions] 
(
				[FeatureName],
				[ControlSrc],
				[SortOrder],
				DefaultCacheTime,
				Icon,
				[IsAdmin]
) 

VALUES 
(
	
				@FeatureName,
				@ControlSrc,
				@SortOrder,
				@DefaultCacheTime,
				@Icon,
				@IsAdmin
				
)


SET @ModuleDefID =  @@IDENTITY 

Exec mp_SiteModuleDefinitions_Insert @SiteID, @ModuleDefID


SELECT @ModuleDefID
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationPerUser_SetPageSettings]    Script Date: 05/11/2007 10:58:46 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[mp_SitePersonalizationPerUser_SetPageSettings]
 (
    @SiteID		int,
    @Path             	NVARCHAR(255),
    @UserId        	UNIQUEIDENTIFIER,
    @PageSettings     	IMAGE,
    @LastUpdate   	DATETIME
)
AS
BEGIN
 
    DECLARE @PathId UNIQUEIDENTIFIER
    SELECT @PathId = NULL
   
    

    SELECT @PathId = u.PathID FROM mp_SitePaths u WHERE u.SiteID = @SiteID AND u.LoweredPath = LOWER(@Path)
    IF (@PathId IS NULL)
     BEGIN
        EXEC mp_SitePaths_CreatePath @SiteID, @Path, @PathId OUTPUT
     END

    --SELECT @UserId = u.UserId FROM mp_Users u WHERE u.SiteID = @SiteID AND u.LoweredUserName = LOWER(@UserName)
   -- IF (@UserId IS NULL)
   -- BEGIN
   --     EXEC dbo.aspnet_Users_CreateUser @ApplicationId, @UserName, 0, @CurrentTimeUtc, @UserId OUTPUT
   -- END

/*
	UPDATE mp_Users WITH (ROWLOCK)
	SET LastActivityDate = @LastUpdate
	WHERE UserGuid = @UserID
	IF (@@ROWCOUNT = 0) -- Username not found
        	RETURN
*/

    IF (EXISTS(SELECT PathId FROM mp_SitePersonalizationPerUser WHERE UserId = @UserId AND PathId = @PathId))
        UPDATE mp_SitePersonalizationPerUser 
	SET PageSettings = @PageSettings, LastUpdate = @LastUpdate 
	WHERE UserId = @UserId AND PathId = @PathId
    ELSE
        INSERT INTO mp_SitePersonalizationPerUser
	(
			UserID, 
			PathID, 
			PageSettings, 
			LastUpdate
	)
	 VALUES (
			@UserId, 
			@PathId, 
			@PageSettings, 
			@LastUpdate)
    RETURN 0
END
GO
/****** Object:  StoredProcedure [dbo].[mp_SitePersonalizationAllUsers_SetPageSettings]    Script Date: 05/11/2007 10:58:43 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[mp_SitePersonalizationAllUsers_SetPageSettings] 

@SiteID		int,
@Path             		nvarchar(255),
@PageSettings    	image,
@LastUpdate   		datetime

AS


BEGIN
    
    DECLARE @PathID UNIQUEIDENTIFIER
    SELECT @PathID = NULL

    

    SELECT @PathID = u.PathID FROM mp_SitePaths u WHERE u.SiteID = @SiteID AND u.LoweredPath = LOWER(@Path)
    IF (@PathId IS NULL)
    BEGIN
        EXEC mp_SitePaths_CreatePath @SiteID, @Path, @PathID OUTPUT
    END

    IF (EXISTS(SELECT PathID FROM mp_SitePersonalizationAllUsers WHERE PathID = @PathID))
        	UPDATE mp_SitePersonalizationAllUsers 
	SET PageSettings = @PageSettings, LastUpdate = @LastUpdate 
	WHERE PathID = @PathID
    ELSE
        INSERT INTO mp_SitePersonalizationAllUsers(PathID, PageSettings, LastUpdate) 
	VALUES (@PathID, @PageSettings, @LastUpdate)
    RETURN 0
END
GO



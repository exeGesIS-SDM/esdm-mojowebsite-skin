/*
 * QtFile Online File Manager v1.0
 * http://qtfile.codeplex.com/
 *
 * Copyright (c) 2009 Zhifeng Lin (fszlin[at]gmail.com)
 * Licensed under the MS-PL license.
 * http://qtfile.codeplex.com/license
 */
(function(){var a8=this,E,e=a8.jQuery,M=a8.alert,aS=a8.prompt,z=a8.confirm,aP="ul",s="li",X="span",bh="title",Y="<ul></ul>",a3="<li></li>",O="<span></span>",c="name",a1="path",aH=function(bq){return Math.floor(Math.random()*bq)},bn=function(bq){var bt="_";for(var bs=1;bs<bq;++bs){var br=aH(26+26+10);if(br<26){bt+="a"+br}else{if(br<26+26){bt+="A"+br-26}else{bt+="0"+br-26-26}}}return bt},W=function(br,bs){for(var bq in bs){var bt="{"+bq+"}";if(br.indexOf(bt)>=0){br=br.replace(bt,escape(bs[bq]));delete bs[bq]}}return br},H=function(bq){var bs=["KB","MB","GB","TB"],br;bq/=1024;for(br=0;bq>1024&&br<bs.length;++br){bq/=1024}return(Math.floor(bq*100)/100)+" "+bs[br]},u=function(bq){return bq.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},ad=function(bq){return a8["eval"]("("+bq+")")},D=function(){var bq=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/.exec(a8.location);return bq[1]+"://"+bq[2]},a0=function(br){var bq=br.get(0),bt=0,bs=0;if(bq&&bq.offsetParent){do{bt+=bq.offsetLeft;bs+=bq.offsetTop}while(bq=bq.offsetParent)}return{left:bt,top:bs}},a2=function(br){var bq=br.lastIndexOf(".");return bq<0?"":br.substr(bq+1)};getNameOnly=function(br){var bq=br.lastIndexOf(".");return bq<1?br:br.substr(0,bq)};var aC="Error",az="Succeed",aT="Denied",aj="NotFound",A="FolderNotFound",x="AlreadyExist",bj="FolderLimitExceed",F="FileSizeLimitExceed",V="FileLimitExceed",g="QuotaExceed",aU="FileTypeNotAllowed",aV="Copy the URL to access this file:",am="Get URL",aO="Download",at="Rename",a9="Move",bi="Delete",au="The file name entered is invalid.",aD="Operation denied.",a5="The folder name entered is invalid.",f="Folder created.",ao="Maximum number of folders exceed.",Q="The folder trying to create already exists.",ac="Error occurred while creating folder.",aL="Creating new folder.",i="Please wait while a new folder is being created.",ap="New Folder",aW="Please enter the name of the new folder:",an="Folder renamed.",v="Renaming folder.",q="Please wait while a folder is being renamed.",n="Please enter the new name of the folder:",bd="Error occurred while renaming folder.",U="The source folder not found, please refresh and try again.",aE="The destination folder not found, please refresh and try again.",P="A nameske folder already exists in destination folder.",bf="Folder Moved.",bk="Error occurred while renaming folder.",p="The destination folder is a subfolder of the source folder.",aY="The source folder selected.",t="Please select destination folder.",m="Please wait while a folder is being moved.",ar="The source folder not found, please refresh and try again.",aB="The destination folder not found, please refresh and try again.",ay="A nameske folder already exists in destination folder.",y="Folder deleted.",N="Deleting folder.",j="Please wait while a folder is being deleted.",ai="Are you sure you want to pemanently delete this folder?",b="Error occurred while deleting folder.",aN="The folder not found, please refresh and try again.",bm="Folder list loaded.",bo="Loading folder list.",aa="Please wait while loading folder list.",aG="Error occurred while loading folder list.",K="Loading file list.",al="Please wait while loading file list.",aJ="File list loaded.",bc="Error occurred while loading file list.",k="File deleted.",J="Deleting file.",bb="The file not found, please refresh and try again.",ah="Please wait while a file is being deleted.",aR="Are you sure you want to pemanently delete this file?",av="Error occurred while deleting file.",aA="File moved.",R="Error occurred while renaming file.",ag="There is already a file with the same name in this folder.",aQ="Moving file.",L="The file not found, please refresh and try again.",Z="The destination folder not found, please refresh and try again.",aw="A namesake file already exists in destionation folder.",h="Please wait while a file is being Moved.",T="Please select destination folder.",C="File renamed.",af="Error occurred while renaming file.",ba="There is already a file with the same name in this folder.",ae="Renaming file.",aK="The file not found, please refresh and try again.",o="The destination folder not found, please refresh and try again.",r="A namesake file already exists in destionation folder.",S="Please wait while a file is being renamed.",ab="Please enter the new name of the file:",aM="File uploaded.",ax="Uploading file.",bp="Please wait while a file is being uploaded.",be="Error occurred while uploading file.",aX="Maximum allowed file size exceed.",G="Maximum number of files exceed.",bl="Disk space quota exceed.",B="The destination folder not found, please refresh and try again.",d="A namesake file already exists in destionation folder.",w="This type of file is not allowed.",bg=function(bq){switch(bq){case aT:return aD;case F:return aX;case V:return G;case g:return bl;case A:return B;case x:return d;case aU:return w;default:return be}},I=function(bq){switch(bq){case aT:return aD;default:return bc}},aq=function(bq){switch(bq){case az:return k;case aT:return aD;case aj:return bb;default:return av}},aI=function(bq){switch(bq){case az:return aA;case aT:return aD;case aj:return L;case A:return Z;case x:return aw;default:return R}},aZ=function(bq){switch(bq){case az:return C;case aT:return aD;case aj:return aK;case A:return o;case x:return r;default:return af}},a7=function(bq){switch(bq){case az:return f;case bj:return ao;case x:return Q;case aT:return aD;default:return ac}},a4=function(bq){switch(bq){case az:return an;case aj:return U;case A:return aE;case x:return P;case aT:return aD;default:return bc}},ak=function(bq){switch(bq){case az:return bf;case aj:return ar;case A:return aB;case x:return ay;case aT:return aD;default:return bc}},aF=function(bq){switch(bq){case az:return y;case aT:return aD;case aj:return aN;default:return b}},a=function(bq){switch(bq){case aT:return aD;default:return aG}};var l=function(bq,br){this.init(bq,br)},a6=l.prototype={};e.extend(l,{setOptions:function(bq){e.extend(l.prototype,bq)}});e.fn.qtfile=function(bq){return this.each(function(){new l(this,bq)})};e.qtfile=function(bq,br){e(bq).qtfile(br)};e.extend(a6,{options:{username:E,rootFolder:"My Files",folderSeparator:"|",folderNameHtml:'<span class="icon-folder"></span><span>{folderName}</span>',folderName:/^[^\\\/\:\*?\<\>\|]+$/,fileName:/^[^\\\/\:\*?\<\>\|]+$/,ajaxTimeout:10000,folderList:"#folderListPanel",fileList:"#fileListPanel",buttonCreateFolder:"#buttonCreateFolder",buttonRenameFolder:"#buttonRenameFolder",buttonDeleteFolder:"#buttonDeleteFolder",buttonMoveFolder:"#buttonMoveFolder",buttonRefreshFolders:"#buttonRefreshFolderList",buttonRefreshFiles:"#buttonRefreshFileList",buttonUploadFile:"#buttonUploadFile",statusMessage:"#statusMessage",errorStatus:["Error","NotFound","AlreadyExist","FolderNotFound","FolderLimitExceed","FileLimitExceed","QuotaExceed","FileSizeLimitExceed"],file:{download:{url:"/UserFile/Download?username={username}&path={path}",data:{}},move:{url:"/UserFile/FileMove?srcPath={srcPath}&destPath={destPath}",method:"GET",data:{}},del:{url:"/UserFile/FileDelete?path={path}",method:"GET",data:{}},list:{url:"/UserFile/FileList?path={path}",method:"GET",data:{}},upload:{url:"/UserFile/FileUpload",fileName:"fileUploaded",frameName:E,data:{}}},folder:{create:{url:"/UserFile/FolderCreate?path={path}",method:"GET",data:{}},move:{url:"/UserFile/FolderMove?srcPath={srcPath}&destPath={destPath}",method:"GET",data:{}},del:{url:"/UserFile/FolderDelete?path={path}",method:"GET",data:{}},list:{url:"/UserFile/FolderList",method:"GET",data:{}}},classes:{folderSelected:"current-folder",buttonDisabled:"button-disabled",fileList:"file-list",fileListEmpty:"file-list-empty",fileNameIcon:"icon-file-name",fileName:"file-name",fileSize:"file-size",fileActions:"file-actions",fileActionLink:"file-action-link",fileActionDownload:"file-action-download",fileActionRename:"file-action-rename",fileActionMove:"file-action-move",fileActionDelete:"file-action-delete",folderList:"folder-list",folderNameText:"folder-name-text",folderIcon:"icon-folder",folderTailIcon:"icon-folder-end",folderBullet:"folder-bullet",folderBulletOpened:"folder-bullet-opened",folderBulletClosed:"folder-bullet-closed",folderName:"folder-name",folderNameSelected:"folder-name-selected",statusInfo:"status-info",statusError:"status-error",statusWarn:"status-warn",statusIcon:"icon-status"},texts:{}},init:function(bs,bq){var br=this,bq=e.extend(br.options,bq);br.context=e(bs);bq.username=bq.username||e.trim(br.context.attr(bh));if(br.context.size()!=1||!bq.username){return}br.context.removeAttr(bh);bq.errorStatus="|"+bq.errorStatus.join("|")+"|";br.initFolders();br.initFiles();br.initButtons();br.initFileDetails()},find:function(bq){return this.context.find(bq)},loc:function(bq){return this.options.texts[bq]||bq},combinePath:function(br,bq){if(br.length>0){return br+this.options.folderSeparator+bq}return bq},splitPath:function(bt){var bs=bt.lastIndexOf(this.options.folderSeparator);var bq=bt.substr(bs+1);var br=bs<0?"":bt.substr(0,bs);return{parent:br,name:bq}},showStatus:function(bw,bq,bv){var bu=this,br=bu.options,bt=bu.loc(bw),bs=bq||br.classes.statusInfo,bx=e(O).addClass(bs).html(bt).prepend(e(O).addClass(br.classes.statusIcon));bu.find(br.statusMessage).empty().append(bx)},tryLock:function(br,bq){var bs=this;if(bs.isLocking){M(bs.lockingMessage);return false}bs.isLocking=true;bs.showStatus(br);bs.lockingMessage=bq;return true},unlock:function(br,bq){var bs=this;bs.isLocking=false;bs.lockingMessage=null;if(br){bs.showStatus(br,bq)}else{bs.find(bs.options.statusMessage).empty()}},request:function(br,bt,bw,bu,bs){var bx=this,by=bx.options,bv=e.extend({},br.data,{username:by.username},bt),bq=W(br.url,bv);e.ajax({url:bq,data:bv,type:br.method,success:bw,error:bu,complete:bs,dataType:"json",cache:false,timeout:by.ajaxTimeout})},statusClass:function(bs){var br=this,bq=br.options.classes;return bs.succeed?bq.statusInfo:br.options.errorStatus.indexOf("|"+bs.status+"|")<0?bq.statusWarn:bq.statusError}});e.extend(a6,{initFiles:function(){var br=this,bq=[];br.find(br.options.fileList+" > ul > li").each(function(){bq.push(ad(e(this).text()))});br.resetFiles(bq)},resetFiles:function(bu){var bt=this,br=bt.options,bs=br.classes;if(bu.length){var bq=bt.find(br.fileList);$fileList=bq.children(aP);if($fileList.size()==0){bq.removeClass(bs.fileListEmpty);$fileList=e(Y).appendTo(bq).addClass(bs.fileList)}$fileList.children(s).remove();e.each(bu,function(){bt.createFileItem(this).appendTo($fileList)});bt.updateFileList()}else{bt.find(br.fileList).addClass(bs.fileListEmpty).children(aP).remove()}},createFileItem:function(br){var bt=this,bu=bt.options.classes,bq=e(a3).data("info",br).data(c,br.name);e(O).addClass(bu.fileName).text(br.name).attr("title",br.name).prepend(e(O).addClass(bu.fileNameIcon).addClass("icon-file-"+a2(br.name))).appendTo(bq).click(function(){bt.showFileDetails(br)});e(O).addClass(bu.fileSize).text(H(br.size)).appendTo(bq);var bs=e(O).addClass(bu.fileActions).appendTo(bq);e(O).addClass("file-action-preview").html(bt.loc("Preview")).attr("title",bt.loc("Preview")).click(function(){bt.showFileDetails(br)}).appendTo(bs);e(O).addClass(bu.fileActionLink).html(bt.loc(am)).attr("title",bt.loc(am)).click(function(){aS(bt.loc(aV),D()+bt.getUrl(bt.currentFolder,e(this).parent(X).parent(s)))}).appendTo(bs);e(O).addClass(bu.fileActionDownload).html(bt.loc(aO)).attr("title",bt.loc(aO)).click(function(){bt.downloadFile(bt.currentFolder,e(this).parent(X).parent(s))}).appendTo(bs);e(O).addClass(bu.fileActionRename).html(bt.loc(at)).attr("title",bt.loc(at)).click(function(){bt.renameFile(bt.currentFolder,e(this).parent(X).parent(s))}).appendTo(bs);e(O).addClass(bu.fileActionMove).html(bt.loc(a9)).attr("title",bt.loc(a9)).click(function(){bt.moveFileBegin(bt.currentFolder,e(this).parent(X).parent(s))}).appendTo(bs);e(O).addClass(bu.fileActionDelete).html(bt.loc(bi)).attr("title",bt.loc(bi)).click(function(){bt.deleteFile(bt.currentFolder,e(this).parent(X).parent(s))}).appendTo(bs);return bq},initFileDetails:function(){var bq=this,br=bq.find(".file-preview"),bs=br.find(".file-preview-image").html();if(!bs){bs="Loading image..."}br.data("loading",bs);br.find(".file-preview-close").click(function(){if(!br.is(":hidden")){br.hide()}})},showFileDetails:function(bs){var bt=this,bu=bt.find(".file-preview");bu.find(".file-preview-name").text(bs.name);bu.find(".file-preview-size").text(H(bs.size));bu.find(".file-preview-content-type").text(bs.contentType);var br=new Date(bs.modified);bu.find(".file-preview-modified").text(br.toLocaleDateString()+" "+br.toLocaleTimeString());if(bs.contentType.substr(0,6)=="image/"){bu.find(".file-preview-image").html(bu.data("loading")).show();var bq=e('<img alt="'+bs.name+'" src="'+bt.getUrl2(bt.currentFolder,bs)+'" />').load(function(){bu.find(".file-preview-image").html(bq)})}else{bu.find(".file-preview-image").hide()}if(bu.is(":hidden")){bu.show()}},updateFileList:function(){var bq=this.find(this.options.fileList).children("ul");bq.children("li:odd").removeClass("even");bq.children("li:even").addClass("even")},getUrl2:function(bq,bu){var bv=this,bs=bv.options,bt=bv.combinePath(bq.data(a1),bu.name),br=W(bs.file.download.url,e.extend({},bs.file.download.data,{username:bs.username,path:bt}));return br},getUrl:function(br,bq){var bv=this,bt=bv.options,bu=bv.combinePath(br.data(a1),bq.data(c)),bs=W(bt.file.download.url,e.extend({},bt.file.download.data,{username:bt.username,path:bu}));return bs},downloadFile:function(br,bq){a8.open(this.getUrl(br,bq))},addFile:function(bs){var bt=this,br=bt.options,bq=bt.find(br.fileList).removeClass(br.classes.fileListEmpty).children(aP);if(bq.size()==0){bq=e(Y).appendTo(bt.find(br.fileList)).addClass(br.classes.fileList)}bt.createFileItem(bs).appendTo(bq);bt.updateFileList()},uploadFile:function(bt){var by=this,bA=by.options,bs=bA.classes,bx=by.currentFolder;if(bt.val()){if(by.tryLock(ax,bp)){var bw=bA.file.upload.frameName||bn(20);var br=e('<iframe id="'+bw+'" name="'+bw+'"></iframe>').hide().appendTo("body").load(function(){var bD=e(this),bE,bB=bD.contents().find("body").text();if(bB){try{bE=ad(bB)}catch(bC){bE={status:aC}}if(bE.status){by.unlock(bg(bE.status),by.statusClass(bE))}else{by.addFile(bE);by.unlock(aM)}}else{by.unlock(be,bs.statusError)}setTimeout(function(){bD.attr("src","about:blank");bD.remove();bw=bD=null},1)});var bq=e('<form method="post" enctype="multipart/form-data"></form>').attr({action:bA.file.upload.url,target:br.attr("name")}).appendTo("body");var bv=e.extend({path:bx.data(a1)},bA.file.upload.data);for(var bu in bv){e('<input type="hidden" />').appendTo(bq).attr({name:bu,value:bv[bu]})}bq.append(bt).submit();bt.appendTo(by.uploadWraper);bq.remove();var bz=setInterval(function(){try{if(bw){e("#"+bw).contents()}else{clearInterval(bz)}}catch(bB){clearInterval(bz);e("#"+bw).remove();bw=null;by.unlock(be,bs.statusError)}},500);bt.appendTo(by.uploadWraper);bq.remove()}}},moveFileBegin:function(br,bq){var bs=this;if(bs.tryLock(T,h)){bs.fileMovingPath=bs.combinePath(br.data(a1),bq.data(c))}},moveFileEnd:function(br){var bv=this,bt=bv.options,bu=bv.fileMovingPath;if(!bu){return}var bs=br.data(a1),bq=bv.combinePath(bs,bv.splitPath(bu).name);bv.request(bt.file.move,{srcPath:bu,destPath:bq},function(bw){if(bw.succeed){bv.removeFile(bv.splitPath(bu).name)}bv.unlock(aI(bw.status),bv.statusClass(bw))},function(){bv.unlock(R,bt.classes.statusError)},function(){bv.fileMovingPath=null})},renameFile:function(bu,bw){var bv=this,by=bv.options;if(bv.tryLock(ae,S)){var bx=bu.data(a1);var bt=bw.data(c);var bs=aS(ab,getNameOnly(bt));if(bs&&bs!=bt){bs=bs+"."+a2(bt);if(by.fileName.test(bs)){var bq=bv.combinePath(bx,bt);var br=bv.combinePath(bx,bs);bv.request(by.file.move,{srcPath:bq,destPath:br},function(bA){if(bA.succeed){var bz=bw.data("info");bz.name=bs;bv.createFileItem(bz).insertAfter(bw);bw.remove();bw=null;bv.updateFileList()}bv.unlock(aZ(bA.status),bv.statusClass(bA))},function(){bv.unlock(af,by.classes.statusError)},null)}else{M(au);bv.unlock()}}else{bv.unlock()}}},deleteFile:function(br,bq){var bu=this,bt=bu.options;if(bu.tryLock(J,ah)){if(!z(aR)){bu.unlock();return}var bs=br.data(a1),bw=bq.data(c);var bv=bu.combinePath(bs,bw);bu.request(bt.file.del,{path:bv},function(bx){if(bx.succeed){bu.removeFile(bq.data(c))}bu.unlock(aq(bx.status),bu.statusClass(bx))},function(){bu.unlock(av,bt.classes.statusError)})}},removeFile:function(br){var bs=this,bq=bs.options;bs.find(bq.fileList+" > ul > li").each(function(){var bt=e(this);if(bt.data(c)==br){if(bs.find(bq.fileList+" li").size()==1){bs.find(bq.fileList).addClass(bq.classes.fileListEmpty)}bt.remove();bs.updateFileList()}})}});e.extend(a6,{initFolders:function(){var bu=this,bt=bu.options,bs,bq=bu.find(bt.folderList+" > ul"),br=bu.folderPaths=[];if(bq.size()==0){bq=e(Y).appendTo(bu.find(bt.folderList))}bu.folderList=bq;bs=e.trim(bq.attr(bh)||bt.rootFolder);bq.removeAttr(bh).addClass(bt.classes.folderList);bq.children(s).each(function(){var bw=e(this),bv=ad(bw.text()).path;br[bv]=bu.createFolderItem(bv).addClass(bw.attr("class"));bw.remove()});bu.rootFolder=bu.createFolderItem("",bs).appendTo(bq);bu.resetFolders()},createFolderItem:function(bs,br){var bu=this,bt=bu.options.classes,bv=br||bu.splitPath(bs).name,bq=e(a3).attr(bh,bv).data(a1,bs);e(O).addClass(bt.folderBullet).appendTo(bq);e(O).addClass(bt.folderName).click(function(){bu.selectFolder(e(this).parent(s))}).append(e(O).addClass(bt.folderIcon)).append(e(O).addClass(bt.folderNameText).text(bv)).append(e(O).addClass(bt.folderTailIcon)).appendTo(bq);return bq},selectFolder:function(bq){var br=this;if(br.folderMovingPath){br.moveFolderEnd(bq)}else{if(br.fileMovingPath){br.moveFileEnd(bq)}else{br.changeFolder(bq)}}},resetFolders:function(){var br=this,bu=br.rootFolder,bt=br.currentFolder,bq=br.folderList;bu.children(aP).remove();for(var bs in br.folderPaths){br.addFolder(bs)}bt=bq.find("."+br.options.classes.folderSelected);if(bt.size()==0){bt=bu}br.currentFolder=bt;br.updateFolder(bt)},addFolder:function(bu){var bs=this,bt=bs.folderPaths[bu],br=bs.splitPath(bu),bv=br.name,bq=br.parent;bs.appendFolder(bt,bq?bs.folderPaths[bq]:bs.rootFolder)},appendFolder:function(bq,br){if(br.children(aP).size()==0){br.append(Y)}bq.appendTo(br.children(aP));this.updateFolderIcon(br)},updateFolderIcon:function(br){var bq=this.options.classes;if(br.children(aP).children(s).size()){br.children("."+bq.folderBullet).addClass(bq.folderBulletOpened).unbind("click").click(function(){e(this).toggleClass(bq.folderBulletOpened).toggleClass(bq.folderBulletClosed).siblings(aP).slideToggle("slow")})}else{br.children("."+bq.folderBullet).removeClass(bq.folderBulletOpened).removeClass(bq.folderBulletClosed).unbind("click");br.children(aP).remove()}},updateFolder:function(bq){var bs=this,bt=bs.currentFolder,br=bs.options.classes;bt.removeClass(br.folderSelected).children("."+br.folderName).removeClass(br.folderNameSelected);bs.currentFolder=bt=bq.addClass(br.folderSelected);bt.children("."+br.folderName).addClass(br.folderNameSelected)},changeFolder:function(br,bt){var bs=this,bq=bs.options;if(bt||!br.hasClass(bq.classes.folderSelected)){if(bs.tryLock(K,al)){bs.request(bq.file.list,{path:br.data(a1)},function(bv){if(e.isArray(bv)){var bu=[];e.each(bv,function(){bu.push(this)});bs.updateFolder(br);bs.resetFiles(bu);bs.unlock(aJ)}else{bs.unlock(I(bv.status),bs.statusClass(bv))}},function(){bs.unlock(bc,bq.classes.statusError)},function(){bs.updateButtons()})}}},createFolder:function(bu){var bs=this,br=bs.options,bt;if(bs.tryLock(aL,i)){bt=aS(aW,ap);if(bt){if(br.folderName.test(bt)){isLoading=true;var bq=bs.combinePath(bu.data(a1),bt);bs.request(br.folder.create,{path:bq},function(bv){if(bv.succeed){bs.folderPaths[bq]=bs.createFolderItem(bq);bs.addFolder(bq)}bs.unlock(a7(bv.status),bs.statusClass(bv))},function(){bs.unlock(ac,br.classes.statusError)})}else{M(a5);bs.unlock()}}else{bs.unlock()}}},renameFolder:function(br){var bu=this,bx=bu.currentFolder,bt=bu.options,bv=bx.data(a1);if(bv.length){if(bu.tryLock(v,q)){var bs=bu.splitPath(bv),bw=aS(n,bs.name);if(!bw){bu.unlock();return}if(!bt.folderName.test(bw)){M(a5);bu.unlock();return}var bq=bu.combinePath(bs.parent,bw);bu.request(bt.folder.move,{srcPath:bv,destPath:bq},function(by){if(by.succeed){bu.updateFolderPath(bx,bq);bx.children("."+bt.classes.folderName).children("."+bt.classes.folderNameText).text(bw)}bu.unlock(a4(by.status),bu.statusClass(by))},function(){bu.unlock(bd,bt.classes.statusError)})}}},deleteFolder:function(bq){var bs=this,bu=bs.currentFolder,br=bs.options,bt=bu.data(a1);if(bt.length){if(bs.tryLock(N,j)){if(!z(ai)){bs.unlock();return}bs.request(br.folder.del,{path:bt},function(bv){if(bv.succeed){var bw=bu.parent(aP).parent(s);bu.remove();bs.updateFolderIcon(bw);bs.unlock(y);bs.changeFolder(bs.rootFolder)}else{bs.unlock(aF(bv.status),bs.statusClass(bv))}},function(){bs.unlock(b,br.classes.statusError)})}}},reloadFolders:function(){var br=this,bq=br.options;if(br.tryLock(bo,aa)){br.request(bq.folder.list,{},function(bu){if(e.isArray(bu)){br.folderPaths=[];e.each(bu,function(){br.folderPaths[this.path]=br.createFolderItem(this.path)});var bs=br.currentFolder.data(a1),bt=bs.length>0?br.folderPaths[br.currentFolder.data(a1)]:br.rootFolder;br.resetFolders();br.unlock(bm);if(bt){br.updateFolder(bt)}else{br.changeFolder(br.rootFolder,true)}}else{br.unlock(bu,br.statusClass(bu))}},function(){br.unlock(aG,bq.classes.statusError)})}},updateFolderPath:function(bs,br){var bq=this.folderPaths,bt=bs.data(a1);bs.find(s).andSelf().each(function(){$this=e(this);var bu=$this.data(a1);var bv=bu.replace(bt,br);$this.data(a1,bv);bq[bv]=$this;delete bq[bu]})},moveFolderBegin:function(bq){var br=this;if(br.tryLock(t,m)){br.folderMovingPath=bq.data(a1)}},moveFolderEnd:function(by){var bx=this,bz=bx.folderMovingPath,bA=bx.options,bt=bx.folderPaths,bq=bA.folderSeparator;if(!bz){return}var bs=by.data(a1);if(bz==bs||bx.splitPath(bz).parent==bs||(bq+bs+bq).indexOf(bq+bz)==0){bx.folderMovingPath=null;var bv=bs.length,br=bz.length;if(bv>br){bx.unlock(p,bA.classes.statusError)}else{if(bv<br){bx.unlock(ay,bA.classes.statusError)}else{bx.unlock(aY,bA.classes.statusError)}}return}var bw=bx.splitPath(bz),bu=bx.combinePath(bs,bw.name);bx.request(bA.folder.move,{srcPath:bz,destPath:bu},function(bB){if(bB.succeed){bx.updateFolderPath(bx.currentFolder,bu);bx.appendFolder(bt[bu],by);bx.updateFolderIcon(bw.parent?bt[bw.parent]:bx.rootFolder)}bx.unlock(ak(bB.status),bx.statusClass(bB))},function(){bx.unlock(bk,bA.classes.statusError)},function(){bx.folderMovingPath=null})}});e.extend(a6,{initButtons:function(){var br=this,bq=br.options;br.find(bq.buttonCreateFolder).click(function(){br.createFolder(br.currentFolder)});br.find(bq.buttonRenameFolder).click(function(){br.renameFolder(br.currentFolder)});br.find(bq.buttonDeleteFolder).click(function(){br.deleteFolder(br.currentFolder)});br.find(bq.buttonMoveFolder).click(function(){if(br.currentFolder.data(a1).length){br.moveFolderBegin(br.currentFolder)}});br.find(bq.buttonRefreshFolders).click(function(){br.reloadFolders()});br.find(bq.buttonRefreshFiles).click(function(){br.changeFolder(br.currentFolder,true)});br.initUploadInput();br.updateButtons()},updateButtons:function(){var br=this,bq=br.options,bs=bq.classes.buttonDisabled;if(br.currentFolder.data(a1).length){br.find(bq.buttonRenameFolder).removeClass(bs);br.find(bq.buttonDeleteFolder).removeClass(bs);br.find(bq.buttonMoveFolder).removeClass(bs)}else{br.find(bq.buttonRenameFolder).addClass(bs);br.find(bq.buttonDeleteFolder).addClass(bs);br.find(bq.buttonMoveFolder).addClass(bs)}},initUploadInput:function(){var bu=this,br=bu.options,bt=bu.find(br.buttonUploadFile),bq=bt.is("input"),bs=bu.uploadWraper=bq?e(O):bt.mousemove(function(bw){var bv=a0(bt);if(bw.pageX>=bv.left&&bw.pageX<bv.left+bt.outerWidth()&&bw.pageY>=bv.top&&bw.pageY<bv.top+bt.outerHeight()){$uploadInput.show();var bx=a0(e(this));$uploadInput.css({top:bw.pageY-bx.top-5+"px",left:bw.pageX-bx.left-170+"px"})}else{$uploadInput.hide()}});if(bq){bs.insertAfter(bt).append(bt);setTimeout(function(){bs.attr("class",bt.attr("class")).css({position:"relative",overflow:"hidden",padding:0,display:bt.css("display"),"margin-top":bt.css("margin-top"),"margin-right":bt.css("margin-right"),"margin-bottom":bt.css("margin-bottom"),"margin-left":bt.css("margin-left")});bt.css({margin:0})},1)}else{bt.css({position:"relative"})}$uploadInput=e('<input type="file" />').attr("name",br.file.upload.fileName).attr("class",bt.attr("class")).css({position:"absolute",margin:0,padding:0,opacity:0,top:0,left:0,width:"220px",height:"10px"}).appendTo(bs).hide().change(function(){bu.uploadFile(e(this))})}})})();
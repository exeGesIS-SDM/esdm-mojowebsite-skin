ALTER TABLE [dbo].mp_SiteModuleDefinitions ADD
	SiteGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SiteModuleDefinitions ADD
	FeatureGuid uniqueidentifier NULL 
GO


UPDATE mp_SiteModuleDefinitions
SET SiteGuid = (SELECT TOP 1 SiteGuid from mp_Sites
		WHERE mp_Sites.SiteID = mp_SiteModuleDefinitions.SiteID),
	FeatureGuid = (SELECT TOP 1 [Guid] from mp_ModuleDefinitions
		WHERE mp_ModuleDefinitions.ModuleDefID = mp_SiteModuleDefinitions.ModuleDefID)

GO

ALTER TABLE [dbo].mp_Modules ADD
	[Guid] uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Modules ADD
	FeatureGuid uniqueidentifier NULL 
GO


ALTER TABLE [dbo].mp_Modules ADD
	SiteGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Modules ADD
	EditUserGuid uniqueidentifier NULL 
GO

UPDATE mp_Modules
SET [Guid] = newid(),
	FeatureGuid = (SELECT TOP 1 [Guid] from mp_ModuleDefinitions
		WHERE mp_ModuleDefinitions.ModuleDefID = mp_Modules.ModuleDefID),
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_Sites.SiteID = mp_Modules.SiteID)

GO


ALTER TABLE [dbo].mp_ModuleSettings ADD
	SettingGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_ModuleSettings ADD
	ModuleGuid uniqueidentifier NULL 
GO

UPDATE mp_ModuleSettings
SET [SettingGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_ModuleSettings.ModuleID = mp_Modules.ModuleID)

GO

ALTER TABLE [dbo].mp_PageModules ADD
	PageGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_PageModules ADD
	ModuleGuid uniqueidentifier NULL 
GO

UPDATE mp_PageModules
SET 
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_PageModules.ModuleID = mp_Modules.ModuleID),
	PageGuid = (SELECT TOP 1 [PageGuid] from mp_Pages
		WHERE mp_PageModules.PageID = mp_Pages.PageID)

GO

ALTER TABLE [dbo].mp_Blogs ADD
	BlogGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Blogs ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Blogs ADD
	Location ntext NULL 
GO

UPDATE mp_Blogs
SET [BlogGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_Blogs.ModuleID = mp_Modules.ModuleID)

GO

ALTER TABLE [dbo].mp_Blogs ADD
	UserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Blogs ADD
	LastModUserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Blogs ADD
	LastModUtc datetime NULL 
GO

UPDATE mp_Blogs
SET	LastModUtc = CreatedDate

GO


ALTER TABLE [dbo].mp_BlogStats ADD
	ModuleGuid uniqueidentifier NULL 
GO


UPDATE mp_BlogStats
SET 
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_BlogStats.ModuleID = mp_Modules.ModuleID)

GO


ALTER TABLE [dbo].mp_HtmlContent ADD
	ItemGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_HtmlContent ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_HtmlContent ADD
	UserGuid uniqueidentifier NULL 
GO


UPDATE mp_HtmlContent
SET [ItemGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_HtmlContent.ModuleID = mp_Modules.ModuleID)

GO

ALTER TABLE [dbo].mp_HtmlContent ADD
	LastModUserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_HtmlContent ADD
	LastModUtc datetime NULL 
GO

UPDATE mp_HtmlContent
SET LastModUtc = CreatedDate

GO


ALTER TABLE [dbo].mp_CalendarEvents ADD
	ItemGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_CalendarEvents ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_CalendarEvents ADD
	UserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_CalendarEvents ADD
	Location ntext NULL 
GO


UPDATE mp_CalendarEvents
SET [ItemGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_CalendarEvents.ModuleID = mp_Modules.ModuleID)

GO

ALTER TABLE [dbo].mp_CalendarEvents ADD
	LastModUserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_CalendarEvents ADD
	LastModUtc datetime NULL 
GO

ALTER TABLE [dbo].mp_CalendarEvents ADD
	TicketPrice decimal(15, 4) NULL
GO

ALTER TABLE [dbo].mp_CalendarEvents ADD
	RequiresTicket bit NULL
GO

UPDATE mp_CalendarEvents
SET LastModUtc = CreatedDate,
	TicketPrice = 0,
	RequiresTicket = 0

GO



ALTER TABLE [dbo].mp_GalleryImages ADD
	ItemGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_GalleryImages ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_GalleryImages ADD
	UserGuid uniqueidentifier NULL 
GO


UPDATE mp_GalleryImages
SET [ItemGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_GalleryImages.ModuleID = mp_Modules.ModuleID)

GO

ALTER TABLE [dbo].mp_Links ADD
	ItemGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Links ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Links ADD
	UserGuid uniqueidentifier NULL 
GO


UPDATE mp_Links
SET [ItemGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_Links.ModuleID = mp_Modules.ModuleID)

GO

ALTER TABLE [dbo].mp_RssFeeds ADD
	ItemGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_RssFeeds ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_RssFeeds ADD
	UserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_RssFeeds ADD
	LastModUserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_RssFeeds ADD
	LastModUtc datetime NULL 
GO


UPDATE mp_RssFeeds
SET [ItemGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_RssFeeds.ModuleID = mp_Modules.ModuleID),
	UserGuid = (SELECT TOP 1 [UserGuid] from mp_Users
		WHERE mp_RssFeeds.UserID = mp_Users.UserID)

GO



ALTER TABLE [dbo].mp_SharedFileFolders ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SharedFileFolders ADD
	FolderGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SharedFileFolders ADD
	ParentGuid uniqueidentifier NULL 
GO

UPDATE mp_SharedFileFolders
SET [FolderGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_SharedFileFolders.ModuleID = mp_Modules.ModuleID)
	

GO

UPDATE mp_SharedFileFolders
SET 
	ParentGuid = (SELECT TOP 1 sf.[FolderGuid] from mp_SharedFileFolders sf
		WHERE mp_SharedFileFolders.FolderID = sf.FolderID)
WHERE
	ParentID > 0

GO

ALTER TABLE [dbo].mp_SharedFiles ADD
	ItemGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SharedFiles ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SharedFiles ADD
	UserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SharedFiles ADD
	FileBlob Image NULL 
GO


UPDATE mp_SharedFiles
SET [ItemGuid] = newid(),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_SharedFiles.ModuleID = mp_Modules.ModuleID)

GO

UPDATE mp_SharedFiles
SET 
	UserGuid = (SELECT TOP 1 [UserGuid] from mp_Users
		WHERE mp_SharedFiles.UploadUserID = mp_Users.UserID)
WHERE
	UploadUserID > -1

GO

ALTER TABLE [dbo].mp_SharedFiles ADD
	FolderGuid uniqueidentifier NULL 
GO

UPDATE mp_SharedFiles
SET 
	FolderGuid = (SELECT TOP 1 [FolderGuid] from mp_SharedFileFolders
		WHERE mp_SharedFiles.FolderID = mp_SharedFileFolders.FolderID)
WHERE
	FolderID > -1

GO

ALTER TABLE [dbo].mp_SharedFilesHistory ADD
	ItemGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SharedFilesHistory ADD
	ModuleGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_SharedFilesHistory ADD
	UserGuid uniqueidentifier NULL 
GO


UPDATE mp_SharedFilesHistory
SET [ItemGuid] = (SELECT TOP 1 [ItemGuid] from mp_SharedFiles
		WHERE mp_SharedFilesHistory.ItemID = mp_SharedFiles.ItemID),
	ModuleGuid = (SELECT TOP 1 [Guid] from mp_Modules
		WHERE mp_SharedFilesHistory.ModuleID = mp_Modules.ModuleID)

GO

UPDATE mp_SharedFilesHistory
SET 
	UserGuid = (SELECT TOP 1 [UserGuid] from mp_Users
		WHERE mp_SharedFilesHistory.UploadUserID = mp_Users.UserID)
WHERE
	UploadUserID > -1

GO



ALTER TABLE [dbo].mp_FriendlyUrls ADD
	PageGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_FriendlyUrls ADD
	SiteGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_FriendlyUrls ADD
	ItemGuid uniqueidentifier NULL 
GO

UPDATE mp_FriendlyUrls
SET 
	[ItemGuid] = newid(),
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_FriendlyUrls.SiteID = mp_Sites.SiteID)
	

GO

ALTER TABLE [dbo].mp_Sites ADD
	GmapApiKey nvarchar(255) NULL 
GO

ALTER TABLE [dbo].mp_Sites ADD
	ApiKeyExtra1 nvarchar(255) NULL 
GO

ALTER TABLE [dbo].mp_Sites ADD
	ApiKeyExtra2 nvarchar(255) NULL 
GO
ALTER TABLE [dbo].mp_Sites ADD
	ApiKeyExtra3 nvarchar(255) NULL 
GO
ALTER TABLE [dbo].mp_Sites ADD
	ApiKeyExtra4 nvarchar(255) NULL 
GO
ALTER TABLE [dbo].mp_Sites ADD
	ApiKeyExtra5 nvarchar(255) NULL 
GO

ALTER TABLE [dbo].mp_Pages ADD
	SiteGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Pages ADD
	CompiledMeta ntext NULL 
GO

ALTER TABLE [dbo].mp_Pages ADD
	CompiledMetaUtc datetime NULL 
GO


UPDATE mp_Pages
SET 
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_Sites.SiteID = mp_Pages.SiteID)

GO

ALTER TABLE [dbo].mp_Users ADD
	SiteGuid uniqueidentifier NULL 
GO


UPDATE mp_Users
SET 
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_Sites.SiteID = mp_Users.SiteID)

GO

ALTER TABLE [dbo].mp_Roles ADD
	SiteGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_Roles ADD
	RoleGuid uniqueidentifier NULL 
GO


UPDATE mp_Roles
SET 	RoleGuid = newid(),
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_Sites.SiteID = mp_Roles.SiteID)

GO

ALTER TABLE [dbo].mp_UserRoles ADD
	UserGuid uniqueidentifier NULL 
GO

ALTER TABLE [dbo].mp_UserRoles ADD
	RoleGuid uniqueidentifier NULL 
GO


UPDATE mp_UserRoles
SET 	
	RoleGuid = (SELECT TOP 1 [RoleGuid] from mp_Roles
		WHERE mp_Roles.RoleID = mp_UserRoles.RoleID),
	UserGuid = (SELECT TOP 1 [UserGuid] from mp_Users
		WHERE mp_Users.UserID = mp_UserRoles.UserID)

GO

ALTER TABLE [dbo].mp_SiteHosts ADD
	SiteGuid uniqueidentifier NULL 
GO

UPDATE mp_SiteHosts
SET 
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_SiteHosts.SiteID = mp_Sites.SiteID)
	

GO

ALTER TABLE [dbo].mp_SitePaths ADD
	SiteGuid uniqueidentifier NULL 
GO

UPDATE mp_SitePaths
SET 
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_SitePaths.SiteID = mp_Sites.SiteID)
	

GO

ALTER TABLE [dbo].mp_UserPages ADD
	SiteGuid uniqueidentifier NULL 
GO

UPDATE mp_UserPages
SET 
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_UserPages.SiteID = mp_Sites.SiteID)
	

GO

ALTER TABLE [dbo].mp_WebParts ADD
	SiteGuid uniqueidentifier NULL 
GO

UPDATE mp_WebParts
SET 
	SiteGuid = (SELECT TOP 1 [SiteGuid] from mp_Sites
		WHERE mp_WebParts.SiteID = mp_Sites.SiteID)
	

GO



SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SiteModuleDefinitions_Insert]

/*
Author:			Joe Audette
Created:		3/12/2005
Last Modified:		2008-01-26

*/


@SiteGuid		uniqueidentifier,
@FeatureGuid	uniqueidentifier



AS

DECLARE @SiteID	int
DECLARE @ModuleDefID int

SET @SiteID = (SELECT TOP 1 SiteID FROM mp_Sites WHERE SiteGuid = @SiteGuid)
SET @ModuleDefID = (SELECT TOP 1 ModuleDefID FROM mp_ModuleDefinitions WHERE Guid = @FeatureGuid)

IF NOT EXISTS (SELECT SiteID FROM mp_SiteModuleDefinitions WHERE SiteID = @SiteID AND ModuleDefID = @ModuleDefID)
INSERT INTO mp_SiteModuleDefinitions (SiteID, ModuleDefID, SiteGuid, FeatureGuid)

VALUES	(@SiteID, @ModuleDefID, @SiteGuid, @FeatureGuid)

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SiteModuleDefinitions_Delete]


/*
Author:			Joe Audette
Created:		3/12/2005
Last Modified:	2008-01-26

*/


@SiteGuid		uniqueidentifier,
@FeatureGuid	uniqueidentifier


AS

DELETE FROM mp_SiteModuleDefinitions
WHERE	SiteGuid = @SiteGuid 
		AND FeatureGuid = @FeatureGuid

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SiteModuleDefinitions_EnsureForAdminSites]

/*
Author:			Joe Audette
Created:		2007-08-06
Last Modified:	2008-01-26

*/


AS

INSERT INTO mp_SiteModuleDefinitions
(
	SiteID,
	ModuleDefID,
	SiteGuid,
	FeatureGuid
)

SELECT
	s.SiteID,
	md.ModuleDefID,
	s.SiteGuid,
	md.Guid

FROM
	mp_Sites s

CROSS JOIN
	mp_ModuleDefinitions md

WHERE	s.IsServerAdminSite = 1
AND md.Guid NOT IN
(SELECT sd.FeatureGuid FROM mp_SiteModuleDefinitions sd
	WHERE sd.SiteGuid = s.SiteGuid)

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_ModuleDefinitions_Select]

    
@SiteGuid  uniqueidentifier


AS

SELECT   	md.*

FROM		mp_ModuleDefinitions md

JOIN		mp_SiteModuleDefinitions smd
ON		smd.FeatureGuid = md.Guid
    
WHERE   	smd.SiteGuid = @SiteGuid

ORDER BY 	md.SortOrder, md.FeatureName

GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[mp_Modules_Insert]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2008-01-26

*/

@PageID int,
@SiteID		int,
@ModuleDefID int,
@ModuleOrder int,
@PaneName nvarchar(50),
@ModuleTitle nvarchar(255),
@AuthorizedEditRoles ntext,
@CacheTime int,
@ShowTitle bit,
@AvailableForMyPage	bit,
@CreatedByUserID	int,
@CreatedDate		datetime,
@AllowMultipleInstancesOnMyPage	bit,
@Icon	nvarchar(255),
@Guid	uniqueidentifier,
@FeatureGuid uniqueidentifier,
@SiteGuid	uniqueidentifier

	
AS
DECLARE @ModuleID int

INSERT INTO 	[dbo].[mp_Modules] 
(
				SiteID,
				SiteGuid,
				[ModuleDefID],
				[ModuleTitle],
				[AuthorizedEditRoles],
				[CacheTime],
				[ShowTitle],
				AvailableForMyPage,
				AllowMultipleInstancesOnMyPage,
				Icon,
				CreatedByUserID,
				CreatedDate,
				[Guid],
				FeatureGuid
) 

VALUES 
(
				@SiteID,
				@SiteGuid,
				@ModuleDefID,
				@ModuleTitle,
				@AuthorizedEditRoles,
				@CacheTime,
				@ShowTitle,
				@AvailableForMyPage,
				@AllowMultipleInstancesOnMyPage,
				@Icon,
				@CreatedByUserID,
				@CreatedDate,
				@Guid,
				@FeatureGuid
				
)
SELECT @ModuleID =  @@IDENTITY

IF @PageID > -1
BEGIN

DECLARE @PageGuid uniqueidentifier
SET @PageGuid = (SELECT TOP 1 PageGuid FROM mp_Pages WHERE PageID = @PageID)

INSERT INTO 	[dbo].[mp_PageModules] 
(
				[PageID],
				[ModuleID],
				[ModuleOrder],
				[PaneName],
				[PublishBeginDate],
				PageGuid,
				ModuleGuid
				
) 

VALUES 
(
				@PageID,
				@ModuleID,
				@ModuleOrder,
				@PaneName,
				@CreatedDate,
				@PageGuid,
				@Guid
				
				
)
END


SELECT @ModuleID

GO

ALTER PROCEDURE [dbo].[mp_Modules_SelectByPage]

/*
Author:				Joe Audette
Created:			12/26/2004
Last Modified:		2008-01-26

*/

@PageID		int


AS
SELECT  		m.ModuleID,
				m.[Guid],
				m.FeatureGuid,
				m.SiteGuid,
				m.SiteID,
				pm.PageID,
				m.ModuleDefID,
				pm.ModuleOrder,
				pm.PaneName,
				m.ModuleTitle,
				m.AuthorizedEditRoles,
				m.CacheTime,
				m.ShowTitle,
				m.EditUserID,
				m.EditUserGuid,
				m.AvailableForMyPage,
				m.CreatedByUserID,
				m.CreatedDate,
				pm.PublishBeginDate,
				pm.PublishEndDate,
				md.ControlSrc,
				md.FeatureName
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

INNER JOIN		mp_PageModules pm
ON				m.ModuleID = pm.ModuleID
    
WHERE   
    			pm.PageID = @PageID
				AND pm.PublishBeginDate < GetutcDate()
				AND	(
					(pm.PublishEndDate IS NULL)
					OR
					(pm.PublishEndDate > GetutcDate())
					)
		
    
ORDER BY
    			pm.ModuleOrder


GO


SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_Modules_SelectOneByPage]

/*
Author:   			Joe Audette
Created: 			12/26/2004
Last Modified: 		2008-01-26

*/

@ModuleID int,
@PageID		int

AS
SELECT  		m.ModuleID,
				m.[Guid],
				m.FeatureGuid,
				m.SiteGuid,
				m.SiteID,
				pm.PageID,
				m.ModuleDefID,
				pm.ModuleOrder,
				pm.PaneName,
				m.ModuleTitle,
				m.AuthorizedEditRoles,
				m.CacheTime,
				m.ShowTitle,
				m.EditUserID,
				m.EditUserGuid,
				m.AvailableForMyPage,
				m.AllowMultipleInstancesOnMyPage,
				m.Icon,
				m.CreatedByUserID,
				m.CreatedDate,
				pm.PublishBeginDate,
				pm.PublishEndDate,
				md.ControlSrc
    
FROM
    			mp_Modules m
  
INNER JOIN
    			mp_ModuleDefinitions md
ON 			m.ModuleDefID = md.ModuleDefID

INNER JOIN		mp_PageModules pm
ON				m.ModuleID = pm.ModuleID
    
WHERE   
    			pm.PageID = @PageID
				AND pm.ModuleID = @ModuleID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_ModuleSettings_Insert]

/*
Author:			Joe Audette
Created:		6/9/2005
Last Modified:		2008-01-26

*/


@SettingGuid		uniqueidentifier,
@ModuleGuid		uniqueidentifier,
@ModuleID			int,
@SettingName			nvarchar(50),
@SettingValue			nvarchar(255),
@ControlType			nvarchar(50),
@RegexValidationExpression 	ntext




AS

INSERT INTO 	mp_ModuleSettings
(
			SettingGuid,
			ModuleGuid,
			ModuleID,
			SettingName,
			SettingValue,
			ControlType,
			RegexValidationExpression
)

VALUES
(
			@SettingGuid,
			@ModuleGuid,
			@ModuleID,
			@SettingName,
			@SettingValue,
			@ControlType,
			@RegexValidationExpression
)

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_ModuleSettings_Update]
(
	@ModuleGuid		uniqueidentifier,
    @ModuleID      int,
    @SettingName   nvarchar(50),
    @SettingValue  nvarchar(255)
)
AS

IF NOT EXISTS (
    SELECT 
        * 
    FROM 
        mp_ModuleSettings 
    WHERE 
        ModuleID = @ModuleID
      AND
        SettingName = @SettingName
)
INSERT INTO mp_ModuleSettings (
	SettingGuid,
	ModuleGuid,
    ModuleID,
    SettingName,
    SettingValue
) 
VALUES (
	newid(),
	@ModuleGuid,
    @ModuleID,
    @SettingName,
    @SettingValue
)
ELSE
UPDATE
    mp_ModuleSettings

SET
    SettingValue = @SettingValue

WHERE
    ModuleID = @ModuleID
  AND
    SettingName = @SettingName

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_PageModules_Insert]

/*
Author:   			Joe Audette
Created: 			5/18/2006
Last Modified: 		2008-01-27

*/

@PageGuid	uniqueidentifier,
@ModuleGuid uniqueidentifier,
@ModuleID			int,
@PageID				int,
@PaneName			nvarchar(50),
@ModuleOrder		int,
@PublishBeginDate	datetime,
@PublishEndDate		datetime

	
AS
INSERT INTO 	[dbo].[mp_PageModules] 
(
				PageGuid,
				ModuleGuid,
				ModuleID,
				PageID,
				PaneName,
				ModuleOrder,
				PublishBeginDate,
				PublishEndDate
				
) 

VALUES 
(
				@PageGuid,
				@ModuleGuid,
				@ModuleID,
				@PageID,
				@PaneName,
				@ModuleOrder,
				@PublishBeginDate,
				@PublishEndDate
				
				
)
SELECT @@IDENTITY

GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[mp_Blog_Insert]

/*
Author:			Joe Audette
Last Modified:	2008-01-29

*/

@BlogGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@ModuleID       		int,
@UserName       	nvarchar(100),
@Title          		nvarchar(100),
@Excerpt	    	nvarchar(512),
@Description    		ntext,
@Location    		ntext,
@StartDate      		datetime,
@IsInNewsletter 	bit,
@IncludeInFeed		bit,
@AllowCommentsForDays	int,
@UserGuid	uniqueidentifier,
@CreatedDate	datetime,
@ItemID         		int OUTPUT

AS

INSERT INTO 		mp_Blogs
(
			BlogGuid,
			ModuleGuid,
    			ModuleID,
    			CreatedByUser,
    			CreatedDate,
    			Title,
    			Excerpt,
			[Description],
			Location,
			StartDate,
			IsInNewsletter,
			IncludeInFeed,
			AllowCommentsForDays,
			UserGuid,
			LastModUserGuid,
			LastModUtc
		
)

VALUES
(
			@BlogGuid,
			@ModuleGuid,
    		@ModuleID,
    		@UserName,
    		@CreatedDate,
    		@Title,
    		@Excerpt,
    		@Description,
			@Location,
    		@StartDate,
    		@IsInNewsletter,
		@IncludeInFeed,
			@AllowCommentsForDays,
			@UserGuid,
			@UserGuid,
			@CreatedDate
    		
)

SELECT

    @ItemID = @@Identity


IF EXISTS(SELECT ModuleID FROM mp_BlogStats WHERE ModuleID = @ModuleID)
	BEGIN
		UPDATE mp_BlogStats
		SET 	EntryCount = EntryCount + 1
		WHERE ModuleID = @ModuleID

	END
ELSE
	BEGIN
		INSERT INTO mp_BlogStats(ModuleGuid, ModuleID, EntryCount)
		VALUES (@ModuleGuid, @ModuleID, 1)


	END

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[mp_Blog_Select]

/*
Author:		Joe Audette
Last Modified:	2008-01-27

*/
    
@ModuleID int,
@BeginDate datetime

AS
DECLARE @RowsToGet int

SET @RowsToGet = COALESCE((SELECT TOP 1 SettingValue FROM mp_ModuleSettings WHERE SettingName = 'BlogEntriesToShowSetting' AND ModuleID = @ModuleID),1)

SET rowcount @RowsToGet

SELECT		
			b.BlogGuid,
			b.ModuleGuid,
			b.ItemID, 
			b.ModuleID, 
			b.CreatedByUser, 
			b.CreatedDate, 
			b.Title, 
			b.Excerpt, 
			b.[Description], 
			b.StartDate,
			b.IsInNewsletter, 
			b.IncludeInFeed,
			b.AllowCommentsForDays,
			b.Location,
			b.UserGuid,
			b.LastModUserGuid,
			b.LastModUtc,
			'CommentCount' = CONVERT(nvarchar(20), b.CommentCount)
			

FROM        		mp_Blogs b

WHERE
    			(b.ModuleID = @ModuleID)  and (@BeginDate >= b.StartDate)

ORDER BY
   			b.StartDate DESC

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_Blog_SelectByEndDate]

/*
Author:		Joe Audette
Created:	6/5/2005
Last Modified:	2008-01-27

*/
    
@ModuleID int,
@EndDate datetime

AS

DECLARE @RowsToGet int

SET @RowsToGet = COALESCE((SELECT TOP 1 SettingValue FROM mp_ModuleSettings WHERE SettingName = 'BlogEntriesToShowSetting' AND ModuleID = @ModuleID),10)

SET rowcount @RowsToGet

SELECT		b.BlogGuid,
			b.ModuleGuid,
			b.ItemID, 
			b.ModuleID, 
			b.CreatedByUser, 
			b.CreatedDate, 
			b.Title, 
			b.Excerpt, 
			b.[Description], 
			b.StartDate,
			b.IsInNewsletter, 
			b.IncludeInFeed,
			b.AllowCommentsForDays,
			b.Location,
			b.UserGuid,
			b.LastModUserGuid,
			b.LastModUtc,
			'CommentCount' = CONVERT(nvarchar(20), b.CommentCount)
			

FROM        		mp_Blogs b

WHERE
    			(b.ModuleID = @ModuleID)  and (@EndDate >= b.StartDate)

ORDER BY
   			b.ItemID DESC,  b.StartDate DESC

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[mp_Blog_SelectDrafts]

/*
Author:		Joe Audette
Created:	2007-12-14
Last Modified:	2008-01-27

*/
    
@ModuleID int

AS


SELECT		b.*

FROM        		mp_Blogs b

WHERE
    			(b.ModuleID = @ModuleID)  
		and (b.StartDate > getutcdate())

ORDER BY
   			b.StartDate DESC

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[mp_Blog_Update]

/*
Author:			Joe Audette
Last Modified:		2007-08-29

*/

@ItemID         		int,
@ModuleID       		int,
@UserName       	nvarchar(100),
@Title          		nvarchar(100),
@Excerpt       		nvarchar(512),
@Description    		ntext,
@StartDate      		datetime,
@IsInNewsletter 	bit,
@IncludeInFeed		bit,
@AllowCommentsForDays	int,
@Location ntext,
@LastModUserGuid	uniqueidentifier,
@LastModUtc	datetime
  
AS

UPDATE mp_Blogs

SET 

		ModuleID = @ModuleID,
		CreatedByUser = @UserName,
		CreatedDate = GetDate(),
		Title =@Title ,
		Excerpt =@Excerpt,
		[Description] = @Description,
		StartDate = @StartDate,
		IsInNewsletter = @IsInNewsletter,
		IncludeInFeed = @IncludeInFeed,
		AllowCommentsForDays = @AllowCommentsForDays,
		Location = @Location,
		LastModUserGuid = @LastModUserGuid,
		LastModUtc = @LastModUtc
		
WHERE 
		ItemID = @ItemID

GO



SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_HtmlContent_Insert]

/*
Author:   			Joe Audette
Created: 			12/23/2004
Last Modified: 		2008-01-27

*/

@ItemGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@ModuleID int,
@Title nvarchar(255),
@Excerpt ntext,
@Body ntext,
@MoreLink nvarchar(255),
@SortOrder int,
@BeginDate datetime,
@EndDate datetime,
@CreatedDate datetime,
@UserID int,
@UserGuid	uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_HtmlContent] 
(
				ItemGuid,
				ModuleGuid,
				[ModuleID],
				[Title],
				[Excerpt],
				[Body],
				[MoreLink],
				[SortOrder],
				[BeginDate],
				[EndDate],
				[CreatedDate],
				[UserID],
				[UserGuid],
				LastModUserGuid,
				LastModUtc
) 

VALUES 
(
				@ItemGuid,
				@ModuleGuid,
				@ModuleID,
				@Title,
				@Excerpt,
				@Body,
				@MoreLink,
				@SortOrder,
				@BeginDate,
				@EndDate,
				@CreatedDate,
				@UserID,
				@UserGuid,
				@UserGuid,
				@CreatedDate
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_HtmlContent_Update]

/*
Author:   			Joe Audette
Created: 			12/23/2004
Last Modified: 		2008-01-28


*/
	
@ItemID int, 
@ModuleID int, 
@Title nvarchar(255), 
@Excerpt ntext, 
@Body ntext, 
@MoreLink nvarchar(255), 
@SortOrder int, 
@BeginDate datetime, 
@EndDate datetime, 
@LastModUtc datetime, 
@LastModUserGuid	uniqueidentifier


AS

UPDATE 		[dbo].[mp_HtmlContent] 

SET
			[ModuleID] = @ModuleID,
			[Title] = @Title,
			[Excerpt] = @Excerpt,
			[Body] = @Body,
			[MoreLink] = @MoreLink,
			[SortOrder] = @SortOrder,
			[BeginDate] = @BeginDate,
			[EndDate] = @EndDate,
			[LastModUtc] = @LastModUtc,
			[LastModUserGuid] = @LastModUserGuid
			
WHERE
			[ItemID] = @ItemID

GO



SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_CalendarEvents_Insert]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 		2008-01-29

*/

@ItemGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@ModuleID int,
@Title nvarchar(255),
@Description ntext,
@ImageName nvarchar(100),
@EventDate datetime,
@StartTime smalldatetime,
@EndTime smalldatetime,
@UserID int,
@UserGuid	uniqueidentifier,
@Location	ntext,
@RequiresTicket	bit,
@TicketPrice	decimal(15,4),
@CreatedDate	datetime

	
AS

INSERT INTO 	[dbo].[mp_CalendarEvents] 
(
				ItemGuid,
				ModuleGuid,
				[ModuleID],
				[Title],
				[Description],
				[ImageName],
				[EventDate],
				[StartTime],
				[EndTime],
				[CreatedDate],
				[UserID],
				UserGuid,
				Location,
				RequiresTicket,
				TicketPrice,
				LastModUserGuid,
				LastModUtc
) 

VALUES 
(
				@ItemGuid,
				@ModuleGuid,
				@ModuleID,
				@Title,
				@Description,
				@ImageName,
				@EventDate,
				@StartTime,
				@EndTime,
				@CreatedDate,
				@UserID,
				@UserGuid,
				@Location,
				@RequiresTicket,
				@TicketPrice,
				@UserGuid,
				@CreatedDate
				
)
SELECT @@IDENTITY

GO


SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_CalendarEvents_SelectByDate]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 		2008-01-27

*/

@ModuleID		int,
@BeginDate		datetime,
@EndDate		datetime

AS
SELECT
		*
		
FROM
		[dbo].[mp_CalendarEvents]

WHERE	ModuleID = @ModuleID
		AND (EventDate >= @BeginDate)
		AND (EventDate <= @EndDate)

ORDER BY	EventDate, DATEPART(hh, StartTime)

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_CalendarEvents_SelectOne]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 		2008-01-27


*/

@ItemID int

AS


SELECT
		*
		
FROM
		[dbo].[mp_CalendarEvents]
		
WHERE
		[ItemID] = @ItemID


GO


SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_CalendarEvents_Update]

/*
Author:   			Joe Audette
Created: 			4/10/2005
Last Modified: 		2008-01-29

*/
	
@ItemID int, 
@ModuleID int, 
@Title nvarchar(255), 
@Description ntext, 
@ImageName nvarchar(100), 
@EventDate datetime, 
@StartTime smalldatetime, 
@EndTime smalldatetime, 
@Location ntext,
@RequiresTicket	bit,
@TicketPrice	decimal(15,4),
@LastModUtc	datetime,
@LastModUserGuid	uniqueidentifier


AS

UPDATE 		[dbo].[mp_CalendarEvents] 

SET
			[ModuleID] = @ModuleID,
			[Title] = @Title,
			[Description] = @Description,
			[ImageName] = @ImageName,
			[EventDate] = @EventDate,
			[StartTime] = @StartTime,
			[EndTime] = @EndTime,
			Location = @Location,
			RequiresTicket = @RequiresTicket,
			TicketPrice = @TicketPrice,
			LastModUtc = @LastModUtc,
			LastModUserGuid = @LastModUserGuid
			
WHERE
			[ItemID] = @ItemID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_GalleryImages_Insert]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 		2008-01-27


*/

@ItemGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@ModuleID int,
@DisplayOrder int,
@Caption nvarchar(255),
@Description ntext,
@MetaDataXml ntext,
@ImageFile nvarchar(100),
@WebImageFile nvarchar(100),
@ThumbnailFile nvarchar(100),
@UploadDate datetime,
@UploadUser nvarchar(100),
@UserGuid	uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_GalleryImages] 
(
				ItemGuid,
				ModuleGuid,
				[ModuleID],
				[DisplayOrder],
				[Caption],
				[Description],
				[MetaDataXml],
				[ImageFile],
				[WebImageFile],
				[ThumbnailFile],
				[UploadDate],
				[UploadUser],
				UserGuid
) 

VALUES 
(
				@ItemGuid,
				@ModuleGuid,
				@ModuleID,
				@DisplayOrder,
				@Caption,
				@Description,
				@MetaDataXml,
				@ImageFile,
				@WebImageFile,
				@ThumbnailFile,
				@UploadDate,
				@UploadUser,
				@UserGuid
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_GalleryImages_Select]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 		2008-01-27

*/

@ModuleID		int

AS


SELECT
		*
		
FROM
		[dbo].[mp_GalleryImages]

WHERE	ModuleID = @ModuleID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_GalleryImages_SelectOne]

/*
Author:   			Joe Audette
Created: 			12/4/2004
Last Modified: 		2008-01-27
*/

@ItemID int

AS


SELECT
		*
		
FROM
		[dbo].[mp_GalleryImages]
		
WHERE
		[ItemID] = @ItemID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_GalleryImages_SelectThumbsByPage]

/*
Author:			Joe Audette
Created:		12/5/2004
Last Modified:	2008-01-27

*/

@ModuleID			int,
@PageNumber 			int,
@PageSize 			int


AS
DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1


CREATE TABLE #PageIndex
(
	IndexID int IDENTITY (1, 1) NOT NULL,
	ItemID int
)	


 
INSERT INTO 	#PageIndex (ItemID)

SELECT	t.ItemID
FROM		mp_GalleryImages t
WHERE	t.ModuleID = @ModuleID	
ORDER BY	t.DisplayOrder, t.ItemID ASC

DECLARE @TotalRows int
DECLARE @TotalPages int
DECLARE @Remainder int

SET @TotalRows = (SELECT Count(*) FROM #PageIndex)
SET @TotalPages = @TotalRows / @PageSize
SET @Remainder = @TotalRows % @PageSize
IF @Remainder > 0 
SET @TotalPages = @TotalPages + 1


SELECT	t.*,
		p.IndexID,
		'TotalPages' = @TotalPages
		


FROM		mp_GalleryImages t

JOIN		#PageIndex p
ON		p.ItemID = t.ItemID



WHERE	t.ModuleID = @ModuleID	
		AND p.IndexID > @PageLowerBound 
		AND p.IndexID < @PageUpperBound

ORDER BY	p.IndexID 

DROP TABLE #PageIndex

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_Links_Insert]

/*
Author:   			Joe Audette
Created: 			12/24/2004
Last Modified: 		2008-01-27

*/

@ItemGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@ModuleID int,
@Title nvarchar(255),
@Url nvarchar(255),
@ViewOrder int,
@Description ntext,
@CreatedDate datetime,
@CreatedBy int,
@Target nvarchar(20),
@UserGuid	uniqueidentifier

	
AS

INSERT INTO 	[dbo].[mp_Links] 
(
				ItemGuid,
				ModuleGuid,
				[ModuleID],
				[Title],
				[Url],
				[ViewOrder],
				[Description],
				[CreatedDate],
				[CreatedBy],
				Target,
				UserGuid
) 

VALUES 
(
				@ItemGuid,
				@ModuleGuid,
				@ModuleID,
				@Title,
				@Url,
				@ViewOrder,
				@Description,
				@CreatedDate,
				@CreatedBy,
				@Target,
				@UserGuid
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_FriendlyUrls_Insert]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 		2008-01-27


*/

@ItemGuid	uniqueidentifier,
@SiteGuid	uniqueidentifier,
@PageGuid	uniqueidentifier,
@SiteID int,
@FriendlyUrl varchar(255),
@RealUrl varchar(255),
@IsPattern bit

	
AS

INSERT INTO 	[dbo].[mp_FriendlyUrls] 
(
				ItemGuid,
				SiteGuid,
				PageGuid,
				[SiteID],
				[FriendlyUrl],
				[RealUrl],
				[IsPattern]
) 

VALUES 
(
				@ItemGuid,
				@SiteGuid,
				@PageGuid,
				@SiteID,
				@FriendlyUrl,
				@RealUrl,
				@IsPattern
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_FriendlyUrls_SelectByHost]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 		2008-01-27
*/

@HostName		varchar(100)

AS

SELECT
		*
		
FROM
		[dbo].[mp_FriendlyUrls]

WHERE	SiteID = COALESCE(
					(SELECT TOP 1 SiteID From mp_SiteHosts WHERE HostName = @HostName),

					(SELECT TOP 1 SiteID From mp_Sites ORDER BY SiteID )
					)

GO


SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_FriendlyUrls_SelectOne]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 		2008-01-27

*/

@UrlID int

AS

SELECT
		*
		
FROM
		[dbo].[mp_FriendlyUrls]
		
WHERE
		[UrlID] = @UrlID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_FriendlyUrls_SelectOneByUrl]

/*
Author:   			Joe Audette
Created: 			6/16/2005
Last Modified: 		2008-01-27
*/

@HostName		varchar(100),
@FriendlyUrl		varchar(255)

AS

SELECT TOP 1
		u.*
		
FROM
		[dbo].[mp_FriendlyUrls] u



WHERE	u.FriendlyUrl = @FriendlyUrl
		AND u.SiteID = COALESCE(
					(SELECT TOP 1 SiteID From mp_SiteHosts WHERE HostName = @HostName),

					(SELECT TOP 1 SiteID From mp_Sites ORDER BY SiteID )
					)
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_FriendlyUrls_Update]

/*
Author:   			Joe Audette
Created: 			6/1/2005
Last Modified: 		2008-01-27


*/
	
@UrlID int, 
@SiteID int, 
@FriendlyUrl varchar(255), 
@RealUrl varchar(255), 
@IsPattern bit ,
@PageGuid	uniqueidentifier

AS

UPDATE 		[dbo].[mp_FriendlyUrls] 

SET
			[SiteID] = @SiteID,
			[FriendlyUrl] = @FriendlyUrl,
			[RealUrl] = @RealUrl,
			[IsPattern] = @IsPattern,
			PageGuid = @PageGuid
			
WHERE
			[UrlID] = @UrlID


GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[mp_Sites_Insert]

/*
Author:   			Joe Audette
Created: 			2005/03/07
Last Modified: 		2008-01-27

*/


@SiteName 				nvarchar(255),
@Skin 					nvarchar(100),
@Logo 					nvarchar(50),
@Icon 					nvarchar(50),
@AllowUserSkins 			bit,
@AllowNewRegistration 			bit,
@UseSecureRegistration 		bit,
@UseSSLOnAllPages 			bit,
@DefaultPageKeyWords 		nvarchar(255),
@DefaultPageDescription 		nvarchar(255),
@DefaultPageEncoding 			nvarchar(255),
@DefaultAdditionalMetaTags 		nvarchar(255),
@IsServerAdminSite 			bit,
@AllowPageSkins			bit,
@AllowHideMenuOnPages		bit,
@UseLdapAuth				bit,
@AutoCreateLdapUserOnFirstLogin	bit,
@LdapServer				nvarchar(255),
@LdapPort				int,
@LdapDomain				nvarchar(255),
@LdapRootDN				nvarchar(255),
@LdapUserDNKey			nvarchar(10),
@AllowUserFullNameChange		bit,
@UseEmailForLogin			bit,
@ReallyDeleteUsers			bit,
@EditorSkin				nvarchar(50),
@DefaultFriendlyUrlPatternEnum		nvarchar(50),
@SiteGuid					uniqueidentifier,
@EnableMyPageFeature 			bit,
@EditorProvider				nvarchar(255),
@DatePickerProvider				nvarchar(255),
@CaptchaProvider				nvarchar(255),
@RecaptchaPrivateKey				nvarchar(255),
@RecaptchaPublicKey				nvarchar(255),
@WordpressAPIKey				nvarchar(255),
@WindowsLiveAppID				nvarchar(255),
@WindowsLiveKey				nvarchar(255),
@AllowOpenIDAuth			bit,
@AllowWindowsLiveAuth		bit,
@GmapApiKey 				nvarchar(255),
@ApiKeyExtra1 				nvarchar(255),
@ApiKeyExtra2 				nvarchar(255),
@ApiKeyExtra3 				nvarchar(255),
@ApiKeyExtra4 				nvarchar(255),
@ApiKeyExtra5 				nvarchar(255)


	
AS
INSERT INTO 	[dbo].[mp_Sites] 
(
				
				[SiteName],
				[Skin],
				[Logo],
				[Icon],
				[AllowUserSkins],
				[AllowNewRegistration],
				[UseSecureRegistration],
				[UseSSLOnAllPages],
				[DefaultPageKeyWords],
				[DefaultPageDescription],
				[DefaultPageEncoding],
				[DefaultAdditionalMetaTags],
				[IsServerAdminSite],
				AllowPageSkins,
				AllowHideMenuOnPages,
				UseLdapAuth,
				AutoCreateLdapUserOnFirstLogin,
				LdapServer,
				LdapPort,
				LdapDomain,
				LdapRootDN,
				LdapUserDNKey,
				ReallyDeleteUsers,
				UseEmailForLogin,
				AllowUserFullNameChange,
				EditorSkin,
				DefaultFriendlyUrlPatternEnum,
				SiteGuid,
				EnableMyPageFeature,
				EditorProvider,
				DatePickerProvider,
				CaptchaProvider,
				RecaptchaPrivateKey,
				RecaptchaPublicKey,
				WordpressAPIKey,
				WindowsLiveAppID,
				WindowsLiveKey,
				AllowOpenIDAuth,
				AllowWindowsLiveAuth,
				GmapApiKey,
				ApiKeyExtra1,
				ApiKeyExtra2,
				ApiKeyExtra3,
				ApiKeyExtra4,
				ApiKeyExtra5
) 

VALUES 
(
				
				@SiteName,
				@Skin,
				@Logo,
				@Icon,
				@AllowUserSkins,
				@AllowNewRegistration,
				@UseSecureRegistration,
				@UseSSLOnAllPages,
				@DefaultPageKeyWords,
				@DefaultPageDescription,
				@DefaultPageEncoding,
				@DefaultAdditionalMetaTags,
				@IsServerAdminSite,
				@AllowPageSkins,
				@AllowHideMenuOnPages,
				@UseLdapAuth,
				@AutoCreateLdapUserOnFirstLogin,
				@LdapServer,
				@LdapPort,
				@LdapDomain,
				@LdapRootDN,
				@LdapUserDNKey,
				@ReallyDeleteUsers,
				@UseEmailForLogin,
				@AllowUserFullNameChange,
				@EditorSkin,
				@DefaultFriendlyUrlPatternEnum,
				@SiteGuid,
				@EnableMyPageFeature,
				@EditorProvider,
				@DatePickerProvider,
				@CaptchaProvider,
				@RecaptchaPrivateKey,
				@RecaptchaPublicKey,
				@WordpressAPIKey,
				@WindowsLiveAppID,
				@WindowsLiveKey,
				@AllowOpenIDAuth,
				@AllowWindowsLiveAuth,
				@GmapApiKey,
				@ApiKeyExtra1,
				@ApiKeyExtra2,
				@ApiKeyExtra3,
				@ApiKeyExtra4,
				@ApiKeyExtra5
				
)
SELECT @@IDENTITY

GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_Sites_Update]

/*
Author:		Joe Audette
Last Modified:	2008-01-27

*/

@SiteID           			int,
@SiteName         		nvarchar(128),
@Skin				nvarchar(100),
@Logo				nvarchar(50),
@Icon				nvarchar(50),
@AllowNewRegistration		bit,
@AllowUserSkins		bit,
@UseSecureRegistration	bit,
@UseSSLOnAllPages		bit,
@DefaultPageKeywords		nvarchar(255),
@DefaultPageDescription	nvarchar(255),
@DefaultPageEncoding		nvarchar(255),
@DefaultAdditionalMetaTags	nvarchar(255),
@IsServerAdminSite		bit,
@AllowPageSkins		bit,
@AllowHideMenuOnPages	bit,
@UseLdapAuth				bit,
@AutoCreateLdapUserOnFirstLogin	bit,
@LdapServer				nvarchar(255),
@LdapPort				int,
@LdapRootDN				nvarchar(255),
@LdapUserDNKey			nvarchar(10),
@AllowUserFullNameChange		bit,
@UseEmailForLogin			bit,
@ReallyDeleteUsers			bit,
@EditorSkin				nvarchar(50),
@DefaultFriendlyUrlPatternEnum		nvarchar(50),
@EnableMyPageFeature		bit,
@LdapDomain				nvarchar(255),
@EditorProvider				nvarchar(255),
@DatePickerProvider				nvarchar(255),
@CaptchaProvider				nvarchar(255),
@RecaptchaPrivateKey				nvarchar(255),
@RecaptchaPublicKey				nvarchar(255),
@WordpressAPIKey				nvarchar(255),
@WindowsLiveAppID				nvarchar(255),
@WindowsLiveKey				nvarchar(255),
@AllowOpenIDAuth			bit,
@AllowWindowsLiveAuth		bit,
@GmapApiKey 				nvarchar(255),
@ApiKeyExtra1 				nvarchar(255),
@ApiKeyExtra2 				nvarchar(255),
@ApiKeyExtra3 				nvarchar(255),
@ApiKeyExtra4 				nvarchar(255),
@ApiKeyExtra5 				nvarchar(255)
	
AS
UPDATE	mp_Sites

SET
    	SiteName = @SiteName,
	Skin = @Skin,
	Logo = @Logo,
	Icon = @Icon,
	AllowNewRegistration = @AllowNewRegistration,
	AllowUserSkins = @AllowUserSkins,
	UseSecureRegistration = @UseSecureRegistration,
	UseSSLOnAllPages = @UseSSLOnAllPages,
	DefaultPageKeywords = @DefaultPageKeywords,
	DefaultPageDescription = @DefaultPageDescription,
	DefaultPageEncoding = @DefaultPageEncoding,
	DefaultAdditionalMetaTags = @DefaultAdditionalMetaTags,
	IsServerAdminSite = @IsServerAdminSite,
	AllowPageSkins = @AllowPageSkins,
	AllowHideMenuOnPages = @AllowHideMenuOnPages,
	UseLdapAuth = @UseLdapAuth,
	AutoCreateLdapUserOnFirstLogin = @AutoCreateLdapUserOnFirstLogin,
	LdapServer = @LdapServer,
	LdapPort = @LdapPort,
    LdapDomain = @LdapDomain,
	LdapRootDN = @LdapRootDN,
	LdapUserDNKey = @LdapUserDNKey,
	AllowUserFullNameChange = @AllowUserFullNameChange,
	UseEmailForLogin = @UseEmailForLogin,
	ReallyDeleteUsers = @ReallyDeleteUsers,
	EditorSkin = @EditorSkin,
	DefaultFriendlyUrlPatternEnum = @DefaultFriendlyUrlPatternEnum,
	EnableMyPageFeature = @EnableMyPageFeature,
	EditorProvider = @EditorProvider,
	DatePickerProvider = @DatePickerProvider,
	CaptchaProvider = @CaptchaProvider,
	RecaptchaPrivateKey = @RecaptchaPrivateKey,
	RecaptchaPublicKey = @RecaptchaPublicKey,
	WordpressAPIKey = @WordpressAPIKey,
	WindowsLiveAppID = @WindowsLiveAppID,
	WindowsLiveKey = @WindowsLiveKey,
	AllowOpenIDAuth = @AllowOpenIDAuth,
	AllowWindowsLiveAuth = @AllowWindowsLiveAuth,
	GmapApiKey = @GmapApiKey,
	ApiKeyExtra1 = @ApiKeyExtra1,
	ApiKeyExtra2 = @ApiKeyExtra2,
	ApiKeyExtra3 = @ApiKeyExtra3,
	ApiKeyExtra4 = @ApiKeyExtra4,
	ApiKeyExtra5 = @ApiKeyExtra5

WHERE
    	SiteID = @SiteID

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_Pages_Insert]

/*
Author:			Joe Audette
Created:		2004-11-17
Last Modified:	2008-01-27

*/

@SiteID   		int,
@ParentID		int,
@PageName    		nvarchar(50),
@PageOrder   		int,
@AuthorizedRoles 	ntext,
@EditRoles		ntext,
@CreateChildPageRoles ntext,
@RequireSSL		bit,
@ShowBreadcrumbs 	bit,
@ShowChildPageBreadcrumbs 	bit,
@PageKeyWords	nvarchar(255),
@PageDescription	nvarchar(255),
@PageEncoding	nvarchar(255),
@AdditionalMetaTags	nvarchar(255),
@UseUrl		bit,
@Url			nvarchar(255),
@OpenInNewWindow	bit,
@ShowChildPageMenu	bit,
@HideMainMenu	bit,
@Skin			nvarchar(100),
@IncludeInMenu	bit,
@MenuImage			nvarchar(50),
@PageTitle    		nvarchar(255),
@AllowBrowserCache	bit,
@ChangeFrequency	nvarchar(20),
@SiteMapPriority			nvarchar(10),
@LastModifiedUTC			datetime,
@PageGuid	uniqueidentifier,
@ParentGuid uniqueidentifier,
@HideAfterLogin	bit,
@SiteGuid	uniqueidentifier,
@CompiledMeta		ntext,
@CompiledMetaUtc	datetime

AS
INSERT INTO 		mp_Pages
(
    			SiteID,
			ParentID,
    			PageName,
				PageTitle,
    			PageOrder,
			AuthorizedRoles,
			EditRoles,
			CreateChildPageRoles,
    			RequireSSL,
			AllowBrowserCache,
    			ShowBreadcrumbs,
			ShowChildBreadCrumbs,
    			PageKeyWords,
			PageDescription,
			PageEncoding,
			AdditionalMetaTags,
			UseUrl,
			Url,
			OpenInNewWindow,
			ShowChildPageMenu,
			HideMainMenu,
			Skin,
			IncludeInMenu,
			MenuImage,
			ChangeFrequency,
			SiteMapPriority,
			LastModifiedUTC,
			PageGuid,
			ParentGuid,
			HideAfterLogin,
			SiteGuid,
			CompiledMeta,
			CompiledMetaUtc
)

VALUES
(
    			@SiteID,
			@ParentID,
    			@PageName,
				@PageTitle,
    			@PageOrder,
			@AuthorizedRoles,
			@EditRoles,
			@CreateChildPageRoles,
    			@RequireSSL,
			@AllowBrowserCache,
    			@ShowBreadcrumbs,
			@ShowChildPageBreadcrumbs,
			@PageKeyWords,
			@PageDescription,
			@PageEncoding,
			@AdditionalMetaTags,
			@UseUrl,
			@Url,
			@OpenInNewWindow,
			@ShowChildPageMenu,
			@HideMainMenu,
			@Skin,
			@IncludeInMenu,
			@MenuImage,
			@ChangeFrequency,
			@SiteMapPriority,
			@LastModifiedUTC,
			@PageGuid,
			@ParentGuid,
			@HideAfterLogin,
			@SiteGuid,
			@CompiledMeta,
			@CompiledMetaUtc
)

SELECT  @@Identity As PageID

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[mp_Pages_Update]

/*
Author:			Joe Audette
Last Modified:		2008-01-27

*/


@SiteID        		int,
@PageID           	int,
@ParentID		int,
@PageOrder        	int,
@PageName         	nvarchar(50),
@AuthorizedRoles 	ntext,
@EditRoles		ntext,
@CreateChildPageRoles ntext,
@RequireSSL		bit,
@ShowBreadcrumbs	bit,
@ShowChildPageBreadcrumbs bit,
@PageKeyWords	nvarchar(255),
@PageDescription	nvarchar(255),
@PageEncoding	nvarchar(255),
@AdditionalMetaTags	nvarchar(255),
@UseUrl		bit,
@Url			nvarchar(255),
@OpenInNewWindow	bit,
@ShowChildPageMenu	bit,
@HideMainMenu	bit,
@Skin			nvarchar(100),
@IncludeInMenu	bit,
@MenuImage			nvarchar(50),
@PageTitle         	nvarchar(255),
@AllowBrowserCache	bit,
@ChangeFrequency	nvarchar(20),
@SiteMapPriority			nvarchar(10),
@LastModifiedUTC			datetime,
@ParentGuid uniqueidentifier,
@HideAfterLogin bit,
@CompiledMeta		ntext,
@CompiledMetaUtc	datetime


AS

UPDATE
    mp_Pages

SET
	ParentID = @ParentID,
    	PageOrder = @PageOrder,
    	PageName = @PageName,
		PageTitle = @PageTitle,
    	AuthorizedRoles = @AuthorizedRoles,
	EditRoles = @EditRoles,
	CreateChildPageRoles = @CreateChildPageRoles,
    	RequireSSL = @RequireSSL,
	AllowBrowserCache = @AllowBrowserCache,
	ShowBreadcrumbs = @ShowBreadcrumbs,
	ShowChildBreadCrumbs = @ShowChildPageBreadcrumbs,
	PageKeyWords = @PageKeyWords,
	PageDescription = @PageDescription,
	PageEncoding = @PageEncoding,
	AdditionalMetaTags = @AdditionalMetaTags,
	UseUrl = @UseUrl,
	Url = @Url,
	OpenInNewWindow = @OpenInNewWindow,
	ShowChildPageMenu = @ShowChildPageMenu,
	HideMainMenu = @HideMainMenu,
	Skin = @Skin,
	IncludeInMenu = @IncludeInMenu,
	MenuImage = @MenuImage,
	ChangeFrequency = @ChangeFrequency,
	SiteMapPriority = @SiteMapPriority,
	LastModifiedUTC = @LastModifiedUTC,
	ParentGuid = @ParentGuid,
	HideAfterLogin = @HideAfterLogin,
	CompiledMeta = @CompiledMeta,
	CompiledMetaUtc = @CompiledMetaUtc

WHERE
    PageID = @PageID

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER Procedure [dbo].[mp_Users_Insert]

/*
Author:			Joe Audette
Created:		9/30/2004
Last Modified:	2008-01-27

*/

@SiteGuid	uniqueidentifier,
@SiteID	int,
@Name     	nvarchar(50),
@LoginName	nvarchar(50),
@Email    	nvarchar(100),
@Password 	nvarchar(50),
@UserGuid	uniqueidentifier,
@DateCreated datetime


AS
INSERT INTO 		mp_Users
(
		SiteGuid,
			SiteID,
    			[Name],
			LoginName,
    			Email,
    			[Password],
			UserGuid,
			DateCreated
	

)

VALUES
(
			@SiteGuid,
			@SiteID,
    			@Name,
			@LoginName,
    			@Email,
    			@Password,
			@UserGuid,
			@DateCreated
)

SELECT		@@Identity As UserID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_Roles_Insert]

/*
Author:			Joe Audette
Created:		7/19/2004
Last Modified:	2008-01-27

*/

@RoleGuid	uniqueidentifier,
@SiteGuid	uniqueidentifier,
@SiteID    		int,
@RoleName    nvarchar(50)

AS

INSERT INTO mp_Roles
(
			RoleGuid,
			SiteGuid,
    		SiteID,
    		RoleName,
    		DisplayName
)

VALUES
(
		@RoleGuid,
		@SiteGuid,
    	@SiteID,
    	@RoleName,
	@RoleName
)

SELECT  @@Identity As RoleID

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER Procedure [dbo].[mp_UserRoles_Insert]
(
@RoleID int,
@UserID int,
@RoleGuid	uniqueidentifier,
@UserGuid	uniqueidentifier
    
)
AS

IF NOT EXISTS (SELECT RoleID FROM mp_UserRoles
WHERE UserID = @UserID AND RoleID = @RoleID)
BEGIN
INSERT INTO mp_UserRoles
    (
        UserID,
        RoleID,
		RoleGuid,
		UserGuid
    )

    VALUES
    (
        @UserID,
        @RoleID,
		@RoleGuid,
		@UserGuid
    )
END

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_RssFeeds_Insert]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 		2008-01-28

*/

@ItemGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@UserGuid	uniqueidentifier,
@ModuleID int,
@UserID int,
@Author nvarchar(100),
@Url nvarchar(255),
@RssUrl nvarchar(255),
@CreatedDate	datetime

AS

INSERT INTO 	[dbo].[mp_RssFeeds] 
(
				ItemGuid,
				ModuleGuid,
				UserGuid,
				[ModuleID],
				[CreatedDate],
				[UserID],
				[Author],
				[Url],
				[RssUrl],
				LastModUserGuid,
				LastModUtc
) 

VALUES 
(
				@ItemGuid,
				@ModuleGuid,
				@UserGuid,
				@ModuleID,
				@CreatedDate,
				@UserID,
				@Author,
				@Url,
				@RssUrl,
				@UserGuid,
				@CreatedDate
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_RssFeeds_Update]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 		2008-01-28


*/
	
@ItemID int, 
@ModuleID int, 
@Author nvarchar(100), 
@Url nvarchar(255), 
@RssUrl nvarchar(255),
@LastModUserGuid	uniqueidentifier,
@LastModUtc	datetime


AS

UPDATE 		[dbo].[mp_RssFeeds] 

SET
			[ModuleID] = @ModuleID,
			[Author] = @Author,
			[Url] = @Url,
			[RssUrl] = @RssUrl,
			LastModUserGuid = @LastModUserGuid,
			LastModUtc = @LastModUtc
			
WHERE
			[ItemID] = @ItemID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_RssFeeds_Select]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 		2008-01-28

*/

@ModuleID		int

AS


SELECT	*
			
FROM
		[dbo].[mp_RssFeeds]

WHERE	ModuleID = @ModuleID

ORDER BY	Author

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_RssFeeds_SelectOne]

/*
Author:   			Joe Audette
Created: 			3/27/2005
Last Modified: 		2008-01-28


*/


@ItemID int

AS


SELECT	*		
FROM
		[dbo].[mp_RssFeeds]
		
WHERE
		[ItemID] = @ItemID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_SiteHosts_Insert]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 		2008-01-28

*/

@SiteGuid	uniqueidentifier,
@SiteID int,
@HostName nvarchar(255)

	
AS

INSERT INTO 	[dbo].[mp_SiteHosts] 
(
				SiteGuid,
				[SiteID],
				[HostName]
) 

VALUES 
(
				@SiteGuid,
				@SiteID,
				@HostName
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_SiteHosts_Select]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 			3/13/2005


*/

@SiteID		int

AS


SELECT *
		
FROM
		[dbo].[mp_SiteHosts]

WHERE	SiteID = @SiteID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SiteHosts_SelectOne]

/*
Author:   			Joe Audette
Created: 			3/6/2005
Last Modified: 		2008-01-28

*/

@HostID int

AS


SELECT	*
		
FROM
		[dbo].[mp_SiteHosts]
		
WHERE
		[HostID] = @HostID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_SitePaths_CreatePath]

@SiteGuid		uniqueidentifier,
@SiteID	int,
@Path           nvarchar(255),
@PathId         UNIQUEIDENTIFIER OUTPUT

AS

BEGIN
    BEGIN TRANSACTION
    IF (NOT EXISTS(SELECT * FROM mp_SitePaths WHERE LoweredPath = LOWER(@Path) AND SiteID = @SiteID))
    BEGIN
        INSERT mp_SitePaths 
(
SiteGuid,
SiteID, 
[Path], 
LoweredPath) 
VALUES 
(
@SiteGuid,
@SiteID, 
@Path, 
LOWER(@Path)
)
    END
    COMMIT TRANSACTION
    SELECT @PathId = PathID FROM mp_SitePaths WHERE LOWER(@Path) = LoweredPath AND SiteID = @SiteID
END

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SitePersonalizationPerUser_SetPageSettings]
 (
    @SiteID		int,
    @Path             	NVARCHAR(255),
    @UserId        	UNIQUEIDENTIFIER,
    @PageSettings     	IMAGE,
    @LastUpdate   	DATETIME
)
AS
BEGIN
 
    DECLARE @PathId UNIQUEIDENTIFIER
    SELECT @PathId = NULL
   DECLARE @SiteGuid uniqueidentifier
	SET @SiteGuid = (SELECT TOP 1 SiteGuid FROM mp_Sites WHERE siteID = @SiteID)
    

    SELECT @PathId = u.PathID FROM mp_SitePaths u WHERE u.SiteID = @SiteID AND u.LoweredPath = LOWER(@Path)
    IF (@PathId IS NULL)
     BEGIN
        EXEC mp_SitePaths_CreatePath @SiteGuid, @SiteID, @Path, @PathId OUTPUT
     END

    IF (EXISTS(SELECT PathId FROM mp_SitePersonalizationPerUser WHERE UserId = @UserId AND PathId = @PathId))
        UPDATE mp_SitePersonalizationPerUser 
	SET PageSettings = @PageSettings, LastUpdate = @LastUpdate 
	WHERE UserId = @UserId AND PathId = @PathId
    ELSE
        INSERT INTO mp_SitePersonalizationPerUser
	(
			UserID, 
			PathID, 
			PageSettings, 
			LastUpdate
	)
	 VALUES (
			@UserId, 
			@PathId, 
			@PageSettings, 
			@LastUpdate)
    RETURN 0
END

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_SitePersonalizationAllUsers_SetPageSettings] 

@SiteID		int,
@Path             		nvarchar(255),
@PageSettings    	image,
@LastUpdate   		datetime

AS


BEGIN
    
    DECLARE @PathID UNIQUEIDENTIFIER
    SELECT @PathID = NULL
	DECLARE @SiteGuid uniqueidentifier
	SET @SiteGuid = (SELECT TOP 1 SiteGuid FROM mp_Sites WHERE siteID = @SiteID)
    
    

    SELECT @PathID = u.PathID FROM mp_SitePaths u WHERE u.SiteID = @SiteID AND u.LoweredPath = LOWER(@Path)
    IF (@PathId IS NULL)
    BEGIN
        EXEC mp_SitePaths_CreatePath @SiteGuid, @SiteID, @Path, @PathID OUTPUT
    END

    IF (EXISTS(SELECT PathID FROM mp_SitePersonalizationAllUsers WHERE PathID = @PathID))
        	UPDATE mp_SitePersonalizationAllUsers 
	SET PageSettings = @PageSettings, LastUpdate = @LastUpdate 
	WHERE PathID = @PathID
    ELSE
        INSERT INTO mp_SitePersonalizationAllUsers(PathID, PageSettings, LastUpdate) 
	VALUES (@PathID, @PageSettings, @LastUpdate)
    RETURN 0
END

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_UserPages_Insert]

/*
Author:   			Joe Audette
Created: 			6/12/2006
Last Modified: 		2008-01-28
*/

@UserPageID	uniqueidentifier,
@SiteGuid	uniqueidentifier,
@SiteID int,
@UserGuid uniqueidentifier,
@PageName nvarchar(255),
@PagePath nvarchar(255),
@PageOrder int

	
AS
INSERT INTO 	[dbo].[mp_UserPages] 
(
				[UserPageID],
				SiteGuid,
				[SiteID],
				[UserGuid],
				[PageName],
				PagePath,
				PageOrder
) 

VALUES 
(
				@UserPageID,
				@SiteGuid,
				@SiteID,
				@UserGuid,
				@PageName,
				@PagePath,
				@PageOrder
				
)

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_WebParts_Insert]

/*
Author:   			Joe Audette
Created: 			6/3/2006
Last Modified: 		2008-01-28
*/

@WebPartID	uniqueidentifier,
@SiteGuid	uniqueidentifier,
@SiteID int,
@Title nvarchar(255),
@Description nvarchar(255),
@ImageUrl nvarchar(255),
@ClassName nvarchar(255),
@AssemblyName nvarchar(255),
@AvailableForMyPage bit,
@AllowMultipleInstancesOnMyPage bit,
@AvailableForContentSystem bit

	
AS

INSERT INTO 	[dbo].[mp_WebParts] 
(
				[WebPartID],
				SiteGuid,
				[SiteID],
				[Title],
				[Description],
				[ImageUrl],
				[ClassName],
				[AssemblyName],
				[AvailableForMyPage],
				[AllowMultipleInstancesOnMyPage],
				[AvailableForContentSystem]
) 

VALUES 
(
				@WebPartID,
				@SiteGuid,
				@SiteID,
				@Title,
				@Description,
				@ImageUrl,
				@ClassName,
				@AssemblyName,
				@AvailableForMyPage,
				@AllowMultipleInstancesOnMyPage,
				@AvailableForContentSystem
				
)

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_WebParts_SelectBySite]

/*
Author:   			Joe Audette
Created: 			6/11/2006
Last Modified: 		2008-01-28
*/

@SiteID		int

AS
SELECT *
		
FROM
		[dbo].[mp_WebParts]
		
WHERE
		[SiteID] = @SiteID
		AND AvailableForContentSystem = 1


GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_WebParts_SelectOne]

/*
Author:   			Joe Audette
Created: 			6/3/2006
Last Modified: 		2008-01-28
*/

@WebPartID uniqueidentifier

AS


SELECT *
		
FROM
		[dbo].[mp_WebParts]
		
WHERE
		[WebPartID] = @WebPartID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SharedFileFolders_Insert]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-28


*/

@FolderGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@ParentGuid uniqueidentifier,
@ModuleID	int,
@FolderName 	nvarchar(255),
@ParentID 	int

	
AS

INSERT INTO 	[dbo].[mp_SharedFileFolders] 
(
				FolderGuid,
				ModuleGuid,
				ParentGuid,
				ModuleID,
				[FolderName],
				[ParentID]
) 

VALUES 
(
				@FolderGuid,
				@ModuleGuid,
				@ParentGuid,
				@ModuleID,
				@FolderName,
				@ParentID
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_SharedFileFolders_SelectAllByModule]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-28
*/

@ModuleID		int

AS

SELECT *
		
FROM
		[dbo].[mp_SharedFileFolders]

WHERE	ModuleID = @ModuleID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SharedFileFolders_SelectByModule]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-28
*/

@ModuleID		int,
@ParentID		int


AS

SELECT *
		
FROM
		[dbo].[mp_SharedFileFolders]

WHERE	ModuleID = @ModuleID
		AND ParentID = @ParentID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SharedFileFolders_SelectOne]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 			2008-01-28

*/

@FolderID int

AS

SELECT *
		
FROM
		[dbo].[mp_SharedFileFolders]
		
WHERE
		[FolderID] = @FolderID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SharedFiles_Insert]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-28

*/

@ItemGuid		uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@UserGuid	uniqueidentifier,
@FolderGuid	uniqueidentifier,
@ModuleID int,
@UploadUserID int,
@FriendlyName nvarchar(255),
@OriginalFileName nvarchar(255),
@ServerFileName nvarchar(255),
@SizeInKB int,
@UploadDate datetime,
@FolderID int

	
AS

INSERT INTO 			[dbo].[mp_SharedFiles] 
(
				ItemGuid,
				ModuleGuid,
				UserGuid,
				FolderGuid,
				[ModuleID],
				[UploadUserID],
				[FriendlyName],
				[OriginalFileName],
				[ServerFileName],
				[SizeInKB],
				[UploadDate],
				[FolderID]
) 

VALUES 
(
				@ItemGuid,
				@ModuleGuid,
				@UserGuid,
				@FolderGuid,
				@ModuleID,
				@UploadUserID,
				@FriendlyName,
				@OriginalFileName,
				@ServerFileName,
				@SizeInKB,
				@UploadDate,
				@FolderID
				
)


SELECT @@IDENTITY

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SharedFiles_Update]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-28

*/
	
@ItemID int, 
@ModuleID int, 
@UploadUserID int, 
@FriendlyName nvarchar(255), 
@OriginalFileName nvarchar(255), 
@ServerFileName nvarchar(255), 
@SizeInKB int, 
@UploadDate datetime, 
@FolderID int,
@FolderGuid	uniqueidentifier ,
@UserGuid	uniqueidentifier

AS

UPDATE 		[dbo].[mp_SharedFiles] 

SET
			[ModuleID] = @ModuleID,
			[UploadUserID] = @UploadUserID,
			[FriendlyName] = @FriendlyName,
			[OriginalFileName] = @OriginalFileName,
			[ServerFileName] = @ServerFileName,
			[SizeInKB] = @SizeInKB,
			[UploadDate] = @UploadDate,
			[FolderID] = @FolderID,
			FolderGuid = @FolderGuid,
			UserGuid = @UserGuid
			
WHERE
			[ItemID] = @ItemID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_SharedFiles_SelectByModule]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-28

*/

@ModuleID		int,
@FolderID		int

AS
SELECT
		sf.[ItemID],
		sf.[ModuleID],
		sf.[UploadUserID],
		sf.[FriendlyName],
		sf.[OriginalFileName],
		sf.[ServerFileName],
		sf.[SizeInKB],
		sf.[UploadDate],
		sf.[FolderID],
		sf.ItemGuid,
		sf.FolderGuid,
		sf.UserGuid,
		sf.ModuleGuid,
		u.[Name] As UserName
		
FROM
		[dbo].[mp_SharedFiles] sf

LEFT OUTER JOIN
		mp_Users u
ON		sf.UploadUserID = u.UserID

WHERE	sf.ModuleID = @ModuleID
		AND sf.FolderID = @FolderID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_SharedFiles_SelectOne]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-28

*/

@ItemID int

AS


SELECT
		[ItemID],
		[ModuleID],
		[UploadUserID],
		[FriendlyName],
		[OriginalFileName],
		[ServerFileName],
		[SizeInKB],
		[UploadDate],
		[FolderID],
		ItemGuid,
		FolderGuid,
		UserGuid,
		ModuleGuid
		
FROM
		[dbo].[mp_SharedFiles]
		
WHERE
		[ItemID] = @ItemID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[mp_SharedFiles_SelectByPage]

/*
Author:			Joe Audettte
Created:		7/4/2005
Last Modified:	2008-01-28

*/


@SiteID		int,
@PageID		int

AS
SELECT  	sf.[ItemID],
		sf.[ModuleID],
		sf.[UploadUserID],
		sf.[FriendlyName],
		sf.[OriginalFileName],
		sf.[ServerFileName],
		sf.[SizeInKB],
		sf.[UploadDate],
		sf.[FolderID],
		sf.ItemGuid,
		sf.FolderGuid,
		sf.UserGuid,
		sf.ModuleGuid,
		
		m.ModuleTitle,
		md.FeatureName

FROM		mp_SharedFiles sf

JOIN		mp_Modules m
ON		sf.ModuleID = m.ModuleID

JOIN		mp_ModuleDefinitions md
ON		m.ModuleDefID = md.ModuleDefID

JOIN		mp_PageModules pm
ON			pm.ModuleID = m.ModuleID

JOIN		mp_Pages p
ON		p.PageID = pm.PageID

WHERE	p.SiteID = @SiteID
		AND pm.PageID = @PageID

GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SharedFilesHistory_Insert]

/*
Author:   			Joe Audette
Created: 			1/9/2005
Last Modified: 		2008-01-28

*/

@ItemGuid	uniqueidentifier,
@ModuleGuid	uniqueidentifier,
@UserGuid	uniqueidentifier,
@ItemID int,
@ModuleID int,
@FriendlyName nvarchar(255),
@OriginalFileName nvarchar(255),
@ServerFileName nvarchar(50),
@SizeInKB	int,
@UploadDate datetime,
@UploadUserID	int,
@ArchiveDate datetime

AS

INSERT INTO 	[dbo].[mp_SharedFilesHistory] 
(
				ItemGuid,
				ModuleGuid,
				UserGuid,
				[ItemID],
				[ModuleID],
				[FriendlyName],
				OriginalFileName,
				[ServerFileName],
				SizeInKB,
				UploadDate,
				UploadUserID,
				[ArchiveDate]
) 

VALUES 
(
				@ItemGuid,
				@ModuleGuid,
				@UserGuid,
				@ItemID,
				@ModuleID,
				@FriendlyName,
				@OriginalFileName,
				@ServerFileName,
				@SizeInKB,
				@UploadDate,
				@UploadUserID,
				@ArchiveDate
				
)
SELECT @@IDENTITY

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_ModuleDefinitions_Insert]

/*
Author:   			Joe Audette
Created: 			2004-12-26
Last Modified: 		2007-08-06

*/

@SiteID int,
@FeatureName nvarchar(255),
@ControlSrc nvarchar(255),
@SortOrder int,
@IsAdmin bit,
@Icon	nvarchar(255),
@DefaultCacheTime int,
@FeatureGuid uniqueidentifier,
@ResourceFile nvarchar(255)
	
AS
DECLARE @ModuleDefID int

INSERT INTO 	[dbo].[mp_ModuleDefinitions] 
(
				[Guid],
				[FeatureName],
				[ControlSrc],
				[SortOrder],
				DefaultCacheTime,
				Icon,
				[IsAdmin],
				[ResourceFile]
) 

VALUES 
(
				@FeatureGuid,
				@FeatureName,
				@ControlSrc,
				@SortOrder,
				@DefaultCacheTime,
				@Icon,
				@IsAdmin,
				@ResourceFile
				
)


SET @ModuleDefID =  @@IDENTITY 

IF @SiteID > -1
BEGIN
DECLARE @SiteGuid uniqueidentifier
SET @SiteGuid = (SELECT TOP 1 SiteGuid FROM mp_Sites WHERE SiteID = @SiteID)
Exec mp_SiteModuleDefinitions_Insert @SiteGuid, @FeatureGuid

END

SELECT @ModuleDefID


GO

SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[mp_ModuleSettings_CreateDefaultSettings]

/*
Author:			Joe Audette
Created:		1/1/2005
Last Modified:	2008-01-29

*/



@ModuleID		int


AS

INSERT INTO 	mp_ModuleSettings
(
			ModuleID,
			SettingName,
			SettingValue,
			ControlType,
			RegexValidationExpression,
			ModuleGuid,
			SettingGuid
)

SELECT		m.ModuleID,
			ds.SettingName,
			ds.SettingValue,
			ds.ControlType,
			ds.RegexValidationExpression,
			m.[Guid],
			newid()


FROM			mp_Modules m

JOIN			mp_ModuleDefinitionSettings ds
ON			ds.ModuleDefID = m.ModuleDefID

WHERE		m.ModuleID = @ModuleID

ORDER BY		ds.[ID]


GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[mp_SharedFileFolders_Update]

/*
Author:   			Joe Audette
Created: 			1/5/2005
Last Modified: 		2008-01-30
*/
	
@FolderID int, 
@ModuleID	int,
@FolderName nvarchar(255), 
@ParentID int,
@ParentGuid	uniqueidentifier


AS

UPDATE 		[dbo].[mp_SharedFileFolders] 

SET
			ModuleID = @ModuleID,
			[FolderName] = @FolderName,
			[ParentID] = @ParentID,
			ParentGuid = @ParentGuid
			
WHERE
			[FolderID] = @FolderID


GO









































































